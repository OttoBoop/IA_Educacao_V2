<!-- 
╔══════════════════════════════════════════════════════════════════╗
║  PROVA AI - FRONTEND v2.0 - PARTE 1 de 2                        ║
║                                                                  ║
║  INSTRUÇÕES:                                                     ║
║  1. Copie TODO o conteúdo deste arquivo                         ║
║  2. Cole no VSCode                                               ║
║  3. Depois, copie a PARTE 2 e cole NO FINAL deste arquivo       ║
║  4. Salve como: frontend/index_v2.html                          ║
╚══════════════════════════════════════════════════════════════════╝
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prova AI v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1117;
            --bg-card: #1a1d24;
            --bg-hover: #242830;
            --bg-input: #242830;
            --border: #2e3340;
            --text: #e4e4e7;
            --text-muted: #71717a;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --purple: #a855f7;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }
        
        .app { display: flex; min-height: 100vh; }
        
        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-tree {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .tree-section { margin-bottom: 8px; }
        
        .tree-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.15s;
        }
        
        .tree-item:hover { background: var(--bg-hover); }
        .tree-item.active { background: var(--primary); color: white; }
        
        .tree-item-icon { opacity: 0.7; font-size: 1rem; }
        .tree-item-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tree-item-count {
            font-size: 0.75rem;
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--text-muted);
        }
        
        .tree-children {
            margin-left: 20px;
            border-left: 1px solid var(--border);
            padding-left: 8px;
            display: none;
        }
        
        .tree-children.expanded { display: block; }
        
        .tree-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: transform 0.2s;
        }
        
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-toggle.hidden { visibility: hidden; }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        /* MAIN CONTENT */
        .main {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .breadcrumb-item {
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.15s;
        }
        
        .breadcrumb-item:hover { color: var(--text); }
        .breadcrumb-item.current { color: var(--text); font-weight: 500; }
        .breadcrumb-sep { color: var(--text-muted); opacity: 0.5; }
        
        .header-actions { display: flex; gap: 12px; }
        
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        /* PAGE HEADER */
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 4px; }
        .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }
        
        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title { font-size: 1rem; font-weight: 600; }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .card-grid-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .card-grid-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-hover);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 12px;
        }
        
        .card-name { font-weight: 600; margin-bottom: 4px; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); }
        
        /* BUTTONS */
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }
        
        .btn:hover { background: var(--bg-hover); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); border-color: var(--success); color: white; }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* FORMS */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-muted);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.15s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-textarea { min-height: 100px; resize: vertical; }
        
        /* TABLES */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        tr:hover { background: var(--bg-hover); }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .badge-warning { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        
        /* ALERTS */
        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .alert-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: var(--warning);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        .alert-icon { font-size: 1.2rem; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 4px; }
        .alert-text { font-size: 0.85rem; opacity: 0.9; }
        
        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
        }
        
        .modal-close:hover { color: var(--text); }
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .upload-zone.dragover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .upload-icon { font-size: 3rem; opacity: 0.5; margin-bottom: 16px; }
        .upload-text { color: var(--text-muted); }
        .upload-text strong { color: var(--primary); }
        
        /* DOC ITEM */
        .doc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .doc-item:hover { background: var(--bg-hover); }
        
        .doc-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-hover);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .doc-info { flex: 1; }
        .doc-actions { display: flex; gap: 8px; }
        .doc-name { font-weight: 500; font-size: 0.9rem; }
        .doc-meta { font-size: 0.8rem; color: var(--text-muted); }

        .doc-group {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-card);
        }

        .doc-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .doc-group-title {
            font-weight: 600;
        }

        .doc-item-static { cursor: default; }
        .doc-item-static:hover { background: var(--bg-input); }

        .doc-meta-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 12px;
            margin-top: 4px;
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        .doc-meta-pill {
            background: var(--bg-hover);
            border-radius: 999px;
            padding: 2px 8px;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon { font-size: 4rem; opacity: 0.3; margin-bottom: 16px; }
        .empty-title { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .empty-text { margin-bottom: 20px; }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s;
        }
        
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* TOAST */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
            max-width: 400px;
        }
        
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        
        /* SPINNER */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* TASK PANEL */
        .task-panel {
            position: fixed;
            bottom: 80px;
            right: 24px;
            width: 380px;
            max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 150;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .task-panel.show { display: flex; }
        .task-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-hover);
        }
        .task-panel-header h4 { margin: 0; font-size: 0.9rem; }
        .task-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .task-item {
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-hover);
            margin-bottom: 8px;
            border-left: 3px solid var(--border);
        }
        .task-item.running { border-left-color: var(--primary); }
        .task-item.success { border-left-color: var(--success); }
        .task-item.error { border-left-color: var(--danger); }
        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .task-item-title { font-weight: 500; font-size: 0.85rem; }
        .task-item-status { font-size: 0.75rem; color: var(--text-muted); }
        .task-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .task-fab {
            position: fixed;
            bottom: 24px;
            right: 440px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            z-index: 151;
        }
        .task-fab.show { display: flex; }
        .task-fab .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* RESULTS NAV */
        .results-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .results-nav-item {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .results-nav-item:hover { background: var(--bg-hover); }
        .results-nav-item.active { border-color: var(--primary); background: rgba(139, 92, 246, 0.1); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }



        /* ============================================
           CHAT GERAL - ESTILOS
           ============================================ */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .chat-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .chat-provider-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-provider-icon {
            font-size: 1.5rem;
        }
        
        .chat-provider-name {
            font-weight: 600;
        }
        
        .chat-provider-model {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .chat-context-bar {
            padding: 10px 20px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }
        
        .chat-context-bar select {
            flex: 1;
            max-width: 300px;
        }
        
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .chat-message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: var(--bg-input);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message pre {
            background: var(--bg-dark);
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
        }
        
        .chat-message-meta {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }
        
        .chat-message-files {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .chat-message-file {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .chat-message-file:hover {
            background: var(--border);
        }
        
        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .chat-input-wrapper textarea {
            flex: 1;
            min-height: 44px;
            max-height: 150px;
            resize: none;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
        }
        
        .chat-input-wrapper textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing-bounce {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }
        
        .alert-pipeline {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .alert-pipeline.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .alert-pipeline.warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        
        .alert-pipeline.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .alert-pipeline.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* ============================================================
           MODEL MODAL STYLES
           ============================================================ */

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .model-warning {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .model-warning .warning-icon {
            font-size: 1.5rem;
        }
        .model-warning .warning-text strong {
            display: block;
            color: var(--warning);
            margin-bottom: 4px;
        }
        .model-warning .warning-text p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        /* ============================================================
           CATALOG STYLES
           ============================================================ */

        /* View Mode Selector */
        .catalog-view-modes {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .view-mode-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }
        .view-mode-btn:hover { background: var(--bg-hover); }
        .view-mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Catalog Filters */
        .catalog-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Model Card Grid */
        .model-catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .model-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.15s, transform 0.15s;
        }
        .model-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .model-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .model-card-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .model-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* Model Stats */
        .model-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-dark);
            border-radius: 6px;
        }
        .stat-label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .stat-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Capability Badges */
        .capability-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .capability-badges span {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .badge-vision { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .badge-tools { background: rgba(168,85,247,0.2); color: #c084fc; }
        .badge-reasoning { background: rgba(234,179,8,0.2); color: #fbbf24; }
        .badge-search { background: rgba(34,197,94,0.2); color: #4ade80; }
        .badge-json { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .badge-code { background: rgba(236,72,153,0.2); color: #f472b6; }

        /* Provider Badges */
        .provider-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }
        .provider-openai { background: #10a37f; }
        .provider-anthropic { background: #d4a574; }
        .provider-google { background: #4285f4; }
        .provider-deepseek { background: #1890ff; }
        .provider-xai { background: #333; }
        .provider-perplexity { background: #20b2aa; }
        .provider-cohere { background: #ff6b6b; }
        .provider-mistral { background: #ff7000; }
        .provider-groq { background: #f55036; }
        .provider-openrouter { background: #6366f1; }
        .provider-ollama { background: #fff; color: #333; }
        .provider-vllm { background: #7c3aed; }
        .provider-lmstudio { background: #059669; }

        /* Model Card Footer */
        .model-card-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        /* Catalog Table (Table View) */
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .catalog-table th, .catalog-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .catalog-table th {
            background: var(--bg-input);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .catalog-table tr:hover { background: var(--bg-hover); }
        .catalog-table .check { color: var(--success); }
        .catalog-table .cross { color: var(--text-muted); }

        /* Compare Grid */
        .compare-selector { margin-bottom: 16px; }
        .compare-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .compare-chip {
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .compare-chip:hover { border-color: var(--primary); }
        .compare-chip.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* Cost Results */
        .cost-results {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .cost-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }
        .cost-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .cost-card-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
        }
        .cost-card-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Minimal View */
        .minimal-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .minimal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .minimal-item:hover { background: var(--bg-hover); }
        .provider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .context-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            background: var(--bg-dark);
            border-radius: 4px;
            color: var(--text-muted);
        }

        /* Local Providers */
        .local-providers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        .local-provider-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .local-provider-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .local-provider-icon { font-size: 1.2rem; }
        .local-provider-name {
            font-weight: 600;
            flex: 1;
        }
        .status-indicator { font-size: 0.9rem; }
        .local-provider-url {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .local-models-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .local-model-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-dark);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .local-model-item .model-name { flex: 1; }
        .local-model-item .model-size {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 8px;
        }
        .empty-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            padding: 12px;
        }

        /* Modal Tabs for Student Selection */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            padding: 0 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: var(--text-primary);
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Student Selection List */
        .aluno-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 12px;
        }
        .aluno-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .aluno-item:last-child {
            border-bottom: none;
        }
        .aluno-item:hover {
            background: var(--bg-hover);
        }
        .aluno-item.selected {
            background: var(--primary-alpha, rgba(74, 144, 226, 0.15));
            border-left: 3px solid var(--primary);
        }
        .aluno-item-info {
            flex: 1;
        }
        .aluno-item-nome {
            font-weight: 500;
            color: var(--text-primary);
        }
        .aluno-item-detalhes {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .aluno-list-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
        }

        /* ============================================================
           TUTORIAL & WELCOME MODALS
           ============================================================ */
        .modal-welcome .modal {
            max-width: 680px;
            animation: modalBounceIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes modalBounceIn {
            0% { opacity: 0; transform: translateY(-40px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .welcome-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            color: #000;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            margin-bottom: 16px;
        }
        
        .welcome-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .welcome-subtitle {
            color: var(--text-muted);
            margin-bottom: 24px;
        }
        
        .welcome-section {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .welcome-section h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .model-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .model-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .model-chip img {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .flow-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .flow-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        
        .flow-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .flow-card-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .flow-card h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        .flow-card p {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .filter-examples {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-example {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }
        
        .filter-example-arrow {
            color: var(--primary);
            font-weight: 600;
        }
        
        .filter-example-result {
            color: var(--text-muted);
        }
        
        /* Chat examples - more visual */
        .chat-examples {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-example {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .chat-example:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .chat-example-icon {
            font-size: 1.2rem;
        }
        
        /* Tips section - compact */
        .welcome-tips {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        
        .tip-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
            padding: 10px 14px;
            background: rgba(59, 130, 246, 0.08);
            border-radius: 8px;
        }
        
        .tip-item.tip-warning {
            background: rgba(234, 179, 8, 0.1);
        }
        
        .tip-icon {
            font-size: 1.1rem;
        }
        
        .welcome-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .welcome-warning h4 {
            color: var(--warning);
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .welcome-warning p {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .welcome-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        
        .welcome-footer label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        /* Tutorial Modal */
        .modal-tutorial .modal {
            max-width: 900px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-tutorial .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        .tutorial-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            gap: 4px;
        }
        
        .tutorial-tab {
            padding: 12px 20px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tutorial-tab:hover {
            color: var(--text);
        }
        
        .tutorial-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tutorial-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .tutorial-step {
            display: none;
        }
        
        .tutorial-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tutorial-step-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .tutorial-step-subtitle {
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        .tutorial-image-container {
            width: 100%;
            min-height: 200px;
            background: var(--bg-hover);
            border-radius: 12px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .tutorial-image {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: opacity 0.3s;
        }
        
        .tutorial-image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            padding: 40px;
            text-align: center;
        }
        
        .tutorial-image-placeholder-icon {
            font-size: 3rem;
            opacity: 0.5;
        }
        
        .tutorial-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text);
        }
        
        .tutorial-text ul {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .tutorial-text li {
            margin-bottom: 8px;
        }
        
        .tutorial-highlight {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--primary);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin: 16px 0;
        }
        
        .tutorial-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        
        .tutorial-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tutorial-progress-dots {
            display: flex;
            gap: 6px;
        }
        
        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.2s;
        }
        
        .tutorial-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }
        
        .tutorial-dot.completed {
            background: var(--success);
        }
        
        .tutorial-progress-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Help button in sidebar */
        .help-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border: none;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .help-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }
        
        .help-btn-icon {
            font-size: 1.1rem;
        }
        
        /* Pulsação para chamar atenção */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 2px 20px rgba(59, 130, 246, 0.6); }
        }
        
        .help-btn.pulse {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        /* Tutorial text enhancements */
        .tutorial-text ol {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .tutorial-text ol li {
            margin-bottom: 8px;
        }
        
        /* Tutorial highlight variations */
        .tutorial-highlight.warning {
            background: rgba(234, 179, 8, 0.1);
            border-left-color: #eab308;
        }
        
        .tutorial-highlight.success {
            background: rgba(34, 197, 94, 0.1);
            border-left-color: #22c55e;
        }
        
        /* Botão de tutorial destacado */
        .btn-tutorial {
            background: linear-gradient(135deg, #10b981, #059669) !important;
            border: none !important;
            color: white !important;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .btn-tutorial:hover {
            background: linear-gradient(135deg, #059669, #047857) !important;
            transform: translateY(-1px);
        }

        /* ========================================
           SISTEMA DE TOOLTIPS E AJUDA CONTEXTUAL
           ======================================== */
        
        /* Tooltip básico via atributo data-tooltip */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::before,
        [data-tooltip]::after {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.25s ease;
            z-index: 1000;
        }
        
        [data-tooltip]::before {
            content: attr(data-tooltip);
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 0.82rem;
            font-weight: 400;
            line-height: 1.5;
            color: var(--text);
            white-space: normal;
            max-width: 300px;
            min-width: 180px;
            text-align: left;
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
        }
        
        [data-tooltip]::after {
            content: '';
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }
        
        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        [data-tooltip]:hover::before {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Tooltip posicionado à direita */
        [data-tooltip-pos="right"]::before {
            bottom: auto;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%) translateX(-4px);
        }
        
        [data-tooltip-pos="right"]::after {
            bottom: auto;
            left: calc(100% + 4px);
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--border);
        }
        
        [data-tooltip-pos="right"]:hover::before {
            transform: translateY(-50%) translateX(0);
        }
        
        /* Tooltip posicionado embaixo */
        [data-tooltip-pos="bottom"]::before {
            bottom: auto;
            top: calc(100% + 8px);
            transform: translateX(-50%) translateY(-4px);
        }
        
        [data-tooltip-pos="bottom"]::after {
            bottom: auto;
            top: calc(100% + 2px);
            border: 6px solid transparent;
            border-bottom-color: var(--border);
        }
        
        [data-tooltip-pos="bottom"]:hover::before {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Ícone de ajuda inline (?) */
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s;
            vertical-align: middle;
        }
        
        .tooltip-icon:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Botão de ajuda por seção (maior, para headers) */
        .section-help {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-hover);
            border: 1px solid var(--border);
            font-size: 1rem;
            color: var(--text-muted);
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s;
        }
        
        .section-help:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        
        /* Painel de ajuda inline (abre em cada seção) */
        .help-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(139, 92, 246, 0.04));
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .help-panel.show {
            display: block;
            animation: helpSlideDown 0.3s ease;
        }
        
        @keyframes helpSlideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .help-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .help-panel-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .help-panel-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }
        
        .help-panel-close:hover {
            color: var(--text);
        }
        
        .help-panel-content {
            font-size: 0.88rem;
            line-height: 1.65;
            color: var(--text);
        }
        
        .help-panel-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .help-panel-content li {
            margin-bottom: 6px;
        }
        
        .help-step {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
            align-items: flex-start;
        }
        
        .help-step-number {
            flex-shrink: 0;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .help-step-text {
            flex: 1;
            padding-top: 2px;
        }
        
        .help-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.85rem;
            margin-top: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .help-link:hover {
            text-decoration: underline;
        }
        
        /* Tag de explicação inline */
        .inline-hint {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .inline-hint::before {
            content: '💡';
            font-size: 0.85rem;
        }
        
        /* ============================================================
           TOGGLE VISUAL/JSON
           ============================================================ */
        .view-toggle {
            display: inline-flex;
            background: var(--bg);
            border-radius: 8px;
            padding: 3px;
            gap: 2px;
        }
        
        .view-toggle-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .view-toggle-btn:hover {
            background: var(--bg-hover);
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }
        
        /* Visual Data Cards */
        .visual-data {
            display: grid;
            gap: 16px;
        }
        
        .data-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        .data-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .data-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }
        
        .data-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-value {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .data-value.large {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .data-value.success { color: var(--success); }
        .data-value.warning { color: var(--warning); }
        .data-value.danger { color: var(--danger); }
        .data-value.primary { color: var(--primary); }
        
        /* Questões visuais */
        .questao-card {
            background: var(--bg);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            border-left: 4px solid var(--border);
        }
        
        .questao-card.correta {
            border-left-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .questao-card.incorreta {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .questao-card.parcial {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.05);
        }
        
        .questao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .questao-numero {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .questao-pontuacao {
            font-size: 0.85rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .questao-pontuacao.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }
        
        .questao-pontuacao.danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }
        
        .questao-pontuacao.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        
        .questao-resposta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        .questao-feedback {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-style: italic;
        }
        
        /* Habilidades visual */
        .habilidade-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .habilidade-item:last-child {
            border-bottom: none;
        }
        
        .habilidade-nome {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .habilidade-barra {
            width: 120px;
            height: 8px;
            background: var(--bg);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .habilidade-barra-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .habilidade-valor {
            font-size: 0.85rem;
            font-weight: 600;
            width: 45px;
            text-align: right;
        }

    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">📝</div>
                    <span>Prova AI</span>
                </div>
            </div>
            
<nav class="nav-tree" id="nav-tree">
<div class="tree-section">
                    <div class="tree-section-header">
                        <span>Navegação</span>
                    </div>
                    <div class="tree-item active" onclick="showDashboard()" data-tooltip="Página inicial com visão geral do sistema" data-tooltip-pos="right">
                        <span class="tree-item-icon">🏠</span>
                        <span class="tree-item-name">Início</span>
                    </div>
                    <div class="tree-item" onclick="showChat()" data-tooltip="Converse com a IA sobre seus documentos e provas" data-tooltip-pos="right">
                        <span class="tree-item-icon">💬</span>
                        <span class="tree-item-name">Chat com IA</span>
                    </div>
                    <div class="tree-item" onclick="showAlunos()" data-tooltip="Lista de todos os alunos cadastrados no sistema" data-tooltip-pos="right">
                        <span class="tree-item-icon">👥</span>
                        <span class="tree-item-name">Todos os Alunos</span>
                    </div>
                    <div class="tree-item" onclick="showPrompts()" data-tooltip="⚠️ Área técnica: instruções que controlam o comportamento da IA" data-tooltip-pos="right">
                        <span class="tree-item-icon">🧠</span>
                        <span class="tree-item-name">Prompts</span>
                    </div>
                    <div class="tree-item" onclick="showProviders()" data-tooltip="⚠️ Área técnica: modelos de IA configurados (GPT, Claude, Gemini)" data-tooltip-pos="right">
                        <span class="tree-item-icon">🤖</span>
                        <span class="tree-item-name">Modelos de LLM</span>
                    </div>
                </div>
                
                <div class="tree-section">
                    <div class="tree-section-header">
                        <span>Matérias</span>
                        <button class="btn btn-sm" onclick="openModal('modal-materia')">+</button>
                    </div>
                    <div id="tree-materias"></div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="btn" style="flex: 1;" onclick="openModal('modal-settings')" data-tooltip="Configure API Keys e modelos de IA. ⚠️ Área técnica - as chaves já estão configuradas!" data-tooltip-pos="right">
                        ⚙️ Configurações IA
                    </button>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="openModal('modal-materia')">
                        + Nova Matéria
                    </button>
                    <button class="help-btn pulse" id="help-btn" onclick="openWelcome()" title="Ajuda e Tutorial">
                        <span class="help-btn-icon">📖</span>
                        <span>Ajuda</span>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main">
            <header class="header">
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item current">Início</span>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="openModal('modal-busca')">🔍 Buscar</button>
                </div>
            </header>
            
            <div class="content" id="content"></div>
        </main>
    </div>
    
    <!-- Modal: Nova Matéria -->
    <div class="modal-overlay" id="modal-materia">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Matéria</h3>
                <button class="modal-close" onclick="closeModal('modal-materia')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Matéria *</label>
                    <input type="text" class="form-input" id="input-materia-nome" placeholder="Ex: Matemática">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea class="form-textarea" id="input-materia-desc" placeholder="Descrição opcional"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Nível de Ensino</label>
                    <select class="form-select" id="input-materia-nivel">
                        <option value="outro">Outro</option>
                        <option value="fundamental_1">Fundamental I</option>
                        <option value="fundamental_2">Fundamental II</option>
                        <option value="medio">Ensino Médio</option>
                        <option value="superior">Ensino Superior</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-materia')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarMateria()">Criar Matéria</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Nova Turma -->
    <div class="modal-overlay" id="modal-turma">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Turma</h3>
                <button class="modal-close" onclick="closeModal('modal-turma')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Turma *</label>
                    <input type="text" class="form-input" id="input-turma-nome" placeholder="Ex: 9º Ano A">
                </div>
                <div class="form-group">
                    <label class="form-label">Ano Letivo</label>
                    <input type="number" class="form-input" id="input-turma-ano" placeholder="2024" value="2024">
                </div>
                <div class="form-group">
                    <label class="form-label">Período</label>
                    <input type="text" class="form-input" id="input-turma-periodo" placeholder="Ex: Manhã">
                </div>
                <input type="hidden" id="input-turma-materia-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-turma')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarTurma()">Criar Turma</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Nova Atividade -->
    <div class="modal-overlay" id="modal-atividade">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Atividade</h3>
                <button class="modal-close" onclick="closeModal('modal-atividade')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Atividade *</label>
                    <input type="text" class="form-input" id="input-ativ-nome" placeholder="Ex: Prova 1 - Bimestre 1">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="input-ativ-tipo">
                        <option value="prova">Prova</option>
                        <option value="trabalho">Trabalho</option>
                        <option value="exercicio">Exercício</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nota Máxima</label>
                    <input type="number" class="form-input" id="input-ativ-nota" value="10" step="0.5">
                </div>
                <input type="hidden" id="input-ativ-turma-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-atividade')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarAtividade()">Criar Atividade</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Adicionar Aluno -->
    <div class="modal-overlay" id="modal-aluno">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Aluno</h3>
                <button class="modal-close" onclick="closeModal('modal-aluno')">×</button>
            </div>

            <!-- Tab buttons -->
            <div class="modal-tabs">
                <button class="tab-btn active" id="tab-btn-selecionar" onclick="switchAlunoTab('selecionar')">Selecionar Existente</button>
                <button class="tab-btn" id="tab-btn-criar" onclick="switchAlunoTab('criar')">Criar Novo</button>
            </div>

            <div class="modal-body">
                <!-- Tab: Select Existing -->
                <div id="tab-selecionar-aluno">
                    <input type="text" class="form-input" id="input-busca-aluno"
                           placeholder="Buscar por nome..." oninput="filtrarAlunos()">
                    <div id="lista-alunos" class="aluno-list"></div>
                </div>

                <!-- Tab: Create New -->
                <div id="tab-criar-aluno" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-input" id="input-aluno-nome" placeholder="Ex: João da Silva">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Matrícula</label>
                        <input type="text" class="form-input" id="input-aluno-matricula" placeholder="Ex: 2024001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="input-aluno-email" placeholder="email@exemplo.com">
                    </div>
                </div>

                <input type="hidden" id="input-aluno-turma-id">
                <input type="hidden" id="input-aluno-selecionado-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-aluno')">Cancelar</button>
                <button class="btn btn-primary" id="btn-confirmar-aluno" onclick="confirmarAluno()">Adicionar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Upload Documento -->
    <div class="modal-overlay" id="modal-upload">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Documento</h3>
                <button class="modal-close" onclick="closeModal('modal-upload')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">
                        Tipo de Documento *
                        <span class="tooltip-icon" data-tooltip="Cada tipo tem um propósito no pipeline de correção. Passe o mouse sobre as opções para saber mais!" data-tooltip-pos="right">?</span>
                    </label>
                    <select class="form-select" id="input-upload-tipo" onchange="onUploadTipoChange()">
                        <option value="enunciado">📄 Enunciado da Prova</option>
                        <option value="gabarito">✅ Gabarito</option>
                        <option value="criterios_correcao">📋 Critérios de Correção</option>
                        <option value="prova_respondida">👤 Prova do Aluno</option>
                        <option value="correcao_professor">🧑‍🏫 Correção do Professor</option>
                    </select>
                    <div class="inline-hint" id="upload-tipo-hint">PDF ou imagem da prova original com as questões</div>
                </div>
                <div class="form-group" id="grupo-aluno-upload" style="display: none;">
                    <label class="form-label">Aluno *</label>
                    <select class="form-select" id="input-upload-aluno"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Arquivo *</label>
                    <div class="upload-zone" id="upload-zone-modal">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">
                            Arraste o(s) arquivo(s) aqui ou <strong>clique para selecionar</strong>
                        </div>
                        <input type="file" id="input-upload-file" hidden multiple accept=".pdf,.docx,.doc,.png,.jpg,.jpeg">
                    </div>
                    <div id="upload-file-name" style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);"></div>
                </div>
                <input type="hidden" id="input-upload-atividade-id">
                <input type="hidden" id="input-upload-documento-id">
                <div id="upload-replace-info" style="display: none; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-upload')">Cancelar</button>
                <button class="btn btn-primary" onclick="uploadDocumento()">Fazer Upload</button>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar Documento -->
    <div class="modal-overlay" id="modal-documento-conteudo">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="titulo-documento-conteudo">Visualizar Documento</h3>
                <button class="modal-close" onclick="closeModal('modal-documento-conteudo')">×</button>
            </div>
            <div class="modal-body">
                <div id="documento-conteudo-meta" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;"></div>
                <pre id="output-documento-conteudo" style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto; max-height: 60vh;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-documento-conteudo')">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Busca -->
    <div class="modal-overlay" id="modal-busca">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buscar</h3>
                <button class="modal-close" onclick="closeModal('modal-busca')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-input" id="input-busca" placeholder="Digite para buscar...">
                </div>
                <div id="resultados-busca"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Alunos (CSV) -->
    <div class="modal-overlay" id="modal-importar-csv">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Importar Alunos (CSV)</h3>
                <button class="modal-close" onclick="closeModal('modal-importar-csv')">×</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                    Cabeçalho esperado: nome,email,matricula
                </p>
                <div class="form-group">
                    <label class="form-label">Arquivo CSV *</label>
                    <input type="file" class="form-input" id="input-importar-csv" accept=".csv">
                </div>
                <input type="hidden" id="input-importar-turma-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-importar-csv')">Cancelar</button>
                <button class="btn btn-primary" onclick="importarAlunosCsv()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Upload Provas em Lote -->
    <div class="modal-overlay" id="modal-upload-provas">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Provas em Lote</h3>
                <button class="modal-close" onclick="closeModal('modal-upload-provas')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Modo de identificação</label>
                    <select class="form-select" id="input-upload-provas-modo">
                        <option value="matricula">Matrícula no nome do arquivo</option>
                        <option value="nome">Nome do aluno no arquivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Arquivos *</label>
                    <input type="file" class="form-input" id="input-upload-provas-files" multiple accept=".pdf,.docx,.doc,.png,.jpg,.jpeg">
                </div>
                <input type="hidden" id="input-upload-provas-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-upload-provas')">Cancelar</button>
                <button class="btn btn-primary" onclick="uploadProvasEmLote()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Executar Etapa -->
    <div class="modal-overlay" id="modal-execucao">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    Executar Etapa
                    <span class="tooltip-icon" data-tooltip="Execute uma etapa específica do pipeline de correção. Cada etapa processa documentos e gera resultados intermediários." data-tooltip-pos="right">?</span>
                </h3>
                <button class="modal-close" onclick="closeModal('modal-execucao')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">
                        Etapa *
                        <span class="tooltip-icon" data-tooltip="Escolha qual etapa do pipeline executar. Cada uma tem um propósito específico no processo de correção." data-tooltip-pos="right">?</span>
                    </label>
                    <select class="form-select" id="input-execucao-etapa" onchange="onEtapaChange()"></select>
                    <div class="inline-hint" id="execucao-etapa-hint">Selecione uma etapa para ver sua descrição</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Aluno (opcional para etapas da atividade)</label>
                    <select class="form-select" id="input-execucao-aluno"></select>
                    <small id="input-execucao-aluno-hint" style="color: var(--text-muted); font-size: 0.8rem;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        Prompt
                        <span class="tooltip-icon" data-tooltip="Prompts são instruções que dizem à IA como executar a tarefa. O padrão já foi otimizado, mas você pode personalizar." data-tooltip-pos="right">?</span>
                    </label>
                    <select class="form-select" id="input-execucao-prompt" onchange="onPromptChange()">
                        <option value="">Usar prompt padrão</option>
                    </select>
                </div>
                <div class="form-group" id="grupo-prompt-customizado" style="display: none;">
                    <label class="form-label">
                        <input type="checkbox" id="input-execucao-editar-prompt" onchange="toggleEditarPrompt()">
                        Editar prompt antes de executar
                    </label>
                </div>
                <div class="form-group" id="grupo-prompt-texto" style="display: none;">
                    <label class="form-label">Texto do Prompt</label>
                    <textarea class="form-textarea" id="input-execucao-prompt-texto" rows="6" placeholder="Carregue um prompt ou escreva aqui..."></textarea>
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Variáveis disponíveis: {conteudo_documento}, {questoes_extraidas}, {gabarito_extraido}, {respostas_extraidas}, {materia}, {atividade}, {nome_aluno}</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Modelo de IA</label>
                    <select class="form-select" id="input-execucao-model"></select>
                </div>
                <input type="hidden" id="input-execucao-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-execucao')">Cancelar</button>
                <button class="btn" onclick="executarEtapa(true)">Preview</button>
                <button class="btn btn-primary" onclick="executarEtapa(false)">Executar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Pipeline Completo -->
    <div class="modal-overlay" id="modal-pipeline-completo">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    🚀 Pipeline Completo
                    <span class="tooltip-icon" data-tooltip="O pipeline executa automaticamente todas as etapas de correção, desde a extração de questões até o relatório final." data-tooltip-pos="right">?</span>
                </h3>
                <button class="modal-close" onclick="closeModal('modal-pipeline-completo')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Executar para:</label>
                    <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="pipeline-modo" value="aluno" checked onchange="onPipelineModoChange()"> Um aluno específico
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="pipeline-modo" value="turma" onchange="onPipelineModoChange()"> Turma toda
                        </label>
                    </div>
                </div>
                <div class="form-group" id="pipeline-aluno-container">
                    <label class="form-label">Aluno *</label>
                    <select class="form-select" id="input-pipeline-aluno"></select>
                </div>
                <div id="pipeline-turma-info" style="display: none;">
                    <div class="alert alert-info" style="margin-bottom: 12px;">⚠️ Será executado para todos os alunos que têm prova enviada</div>
                    <div id="pipeline-turma-resumo" style="padding: 10px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 12px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Modelo de IA padrão</label>
                    <select class="form-select" id="input-pipeline-provider-default"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Etapas a executar e modelo por etapa</label>
                    <div id="pipeline-provider-stages" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <small style="color: var(--text-muted); display: block; margin-top: 6px;">
                        Marque as etapas que deseja executar. Selecione um modelo diferente para personalizar cada etapa.
                    </small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="input-pipeline-force-rerun">
                        Forçar re-execução (criar nova versão)
                    </label>
                    <small style="color: var(--text-muted); display: block; margin-top: 4px;">
                        Se marcado, cria novas versões dos documentos em vez de pular etapas já executadas. Útil para comparar resultados de diferentes modelos.
                    </small>
                </div>
                <input type="hidden" id="input-pipeline-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-pipeline-completo')">Cancelar</button>
                <button class="btn btn-primary" id="btn-executar-pipeline" onclick="executarPipelineCompleto()">Executar Pipeline</button>
            </div>
        </div>
    </div>

    <!-- Modal: Preview Prompt -->
    <div class="modal-overlay" id="modal-prompt-preview">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Preview de Prompt</h3>
                <button class="modal-close" onclick="closeModal('modal-prompt-preview')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Variáveis (JSON)</label>
                    <textarea class="form-textarea" id="input-prompt-variaveis" placeholder='{"materia":"Matemática","atividade":"Prova 1"}'></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt de Sistema (preview)</label>
                    <textarea class="form-textarea" id="output-prompt-preview-sistema" readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt do Usuário (preview)</label>
                    <textarea class="form-textarea" id="output-prompt-preview" readonly></textarea>
                </div>
                <input type="hidden" id="input-prompt-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-prompt-preview')">Fechar</button>
                <button class="btn btn-primary" onclick="renderPrompt()">Gerar Preview</button>
            </div>
        </div>
    </div>

    <!-- Modal: Settings (API Keys e Modelos) -->
    <div class="modal-overlay" id="modal-settings">
        <div class="modal modal-lg" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">⚙️ Configurações de IA</h3>
                <button class="modal-close" onclick="closeModal('modal-settings')">×</button>
            </div>
            <div class="modal-body">
                <div class="tabs" style="flex-wrap: wrap;">
                    <div class="tab active" onclick="showSettingsTab('api-keys')">🔑 API Keys</div>
                    <div class="tab" onclick="showSettingsTab('models')">🤖 Modelos</div>
                    <div class="tab" onclick="showSettingsTab('catalog')">📚 Catálogo</div>
                    <div class="tab" onclick="showSettingsTab('custom')">⚙️ Customizado</div>
                    <div class="tab" onclick="showSettingsTab('local')">💻 Local</div>
                </div>
                
                <!-- Tab: API Keys -->
                <div id="settings-tab-api-keys">
                    <div class="card-header" style="margin-bottom: 16px;">
                        <span class="card-title">API Keys por Empresa</span>
                        <button class="btn btn-primary btn-sm" onclick="openModal('modal-add-apikey')">+ Adicionar</button>
                    </div>
                    <div id="api-keys-list">
                        <div class="empty-state">
                            <div class="empty-icon">🔑</div>
                            <div class="empty-title">Nenhuma API key configurada</div>
                            <div class="empty-text">Adicione uma API key para começar a usar a IA</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Models -->
                <div id="settings-tab-models" style="display: none;">
                    <div class="card-header" style="margin-bottom: 16px;">
                        <span class="card-title">Modelos Configurados</span>
                        <button class="btn btn-primary btn-sm" onclick="openAddModelModal()">+ Adicionar</button>
                    </div>
                    <div id="models-list">
                        <div class="empty-state">
                            <div class="empty-icon">🤖</div>
                            <div class="empty-title">Nenhum modelo configurado</div>
                            <div class="empty-text">Adicione um modelo para usar nas correções</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Catalog -->
                <div id="settings-tab-catalog" style="display: none;">
                    <!-- View Mode Selector -->
                    <div class="catalog-view-modes">
                        <button class="view-mode-btn active" data-mode="cards" onclick="setCatalogView('cards')">▦ Cards</button>
                        <button class="view-mode-btn" data-mode="table" onclick="setCatalogView('table')">☰ Tabela</button>
                        <button class="view-mode-btn" data-mode="compare" onclick="setCatalogView('compare')">⇆ Comparar</button>
                        <button class="view-mode-btn" data-mode="minimal" onclick="setCatalogView('minimal')">• Minimal</button>
                    </div>

                    <!-- Filters -->
                    <div class="catalog-filters">
                        <select id="filter-provider" class="form-select" onchange="filterCatalog()" style="max-width: 180px;">
                            <option value="">Todos Provedores</option>
                        </select>
                        <select id="filter-capability" class="form-select" onchange="filterCatalog()" style="max-width: 180px;">
                            <option value="">Todas Capacidades</option>
                            <option value="vision">👁️ Vision</option>
                            <option value="tools">🔧 Tool Use</option>
                            <option value="reasoning">🧠 Reasoning</option>
                            <option value="search">🔍 Search</option>
                            <option value="json_mode">📋 JSON Mode</option>
                        </select>
                        <input type="text" class="form-input" id="filter-search" placeholder="Buscar modelo..."
                               onkeyup="filterCatalog()" style="max-width: 180px;">
                    </div>

                    <!-- Catalog Content -->
                    <div id="catalog-content">
                        <div class="model-catalog-grid" id="catalog-grid"></div>
                    </div>

                    <!-- Compare Mode Content (hidden by default) -->
                    <div id="compare-content" style="display: none;">
                        <div class="compare-selector">
                            <label style="margin-bottom: 8px; display: block;">Selecione modelos para comparar (até 4):</label>
                            <div id="compare-chips" class="compare-chips"></div>
                        </div>
                        <div id="compare-grid" class="compare-grid"></div>

                        <!-- Cost Calculator -->
                        <div class="cost-calculator" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 12px;">💰 Calculadora de Custos</h4>
                            <div class="form-row" style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Tokens Input/req</label>
                                    <input type="number" class="form-input" id="calc-input-tokens" value="1000" onchange="calculateCosts()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Tokens Output/req</label>
                                    <input type="number" class="form-input" id="calc-output-tokens" value="500" onchange="calculateCosts()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Requisições/dia</label>
                                    <input type="number" class="form-input" id="calc-requests" value="100" onchange="calculateCosts()">
                                </div>
                            </div>
                            <div id="cost-results" class="cost-results"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Custom Endpoint -->
                <div id="settings-tab-custom" style="display: none;">
                    <div class="card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                        <h4 style="margin-bottom: 16px;">🔧 Configuração de Endpoint Customizado</h4>
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                            Configure endpoints específicos (Azure, versões antigas, proxies, etc.)
                        </p>

                        <div class="form-group">
                            <label class="form-label">Tipo de Compatibilidade *</label>
                            <select id="custom-compat" class="form-select">
                                <option value="openai">OpenAI-Compatible</option>
                                <option value="anthropic">Anthropic-Compatible</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome de Exibição *</label>
                            <input type="text" class="form-input" id="custom-nome" placeholder="Ex: Azure GPT-4 Produção">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Base URL *</label>
                            <input type="text" class="form-input" id="custom-url" placeholder="https://my-resource.openai.azure.com/v1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ID Exato do Modelo *</label>
                            <input type="text" class="form-input" id="custom-model-id" placeholder="gpt-4o-2024-08-06">
                            <div class="form-hint">O identificador exato enviado nas requisições</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Versão da API (opcional)</label>
                            <input type="text" class="form-input" id="custom-api-version" placeholder="2024-02-15-preview">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Headers Extras (JSON, opcional)</label>
                            <textarea class="form-input" id="custom-headers" rows="2" placeholder='{"x-custom-header": "value"}'></textarea>
                        </div>

                        <div class="form-row" style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Max Tokens</label>
                                <input type="number" class="form-input" id="custom-tokens" value="4096">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Temperatura</label>
                                <input type="number" class="form-input" id="custom-temp" value="0.7" step="0.1" min="0" max="2">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="salvarCustomEndpoint()" style="margin-top: 12px;">
                            💾 Salvar Endpoint Customizado
                        </button>
                    </div>
                </div>

                <!-- Tab: Local Models -->
                <div id="settings-tab-local" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Detecta automaticamente modelos em servidores locais (Ollama, vLLM, LM Studio)
                        </p>
                        <button class="btn btn-sm" onclick="detectAllLocalModels()" style="margin-top: 8px;">
                            🔄 Atualizar Todos
                        </button>
                    </div>

                    <div class="local-providers-grid">
                        <!-- Ollama -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">🦙</span>
                                <span class="local-provider-name">Ollama</span>
                                <span id="ollama-status" class="status-indicator">⏳</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('ollama')">↻</button>
                            </div>
                            <div class="local-provider-url">localhost:11434</div>
                            <div id="ollama-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>

                        <!-- vLLM -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">⚡</span>
                                <span class="local-provider-name">vLLM</span>
                                <span id="vllm-status" class="status-indicator">⏳</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('vllm')">↻</button>
                            </div>
                            <div class="local-provider-url">localhost:8000</div>
                            <div id="vllm-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>

                        <!-- LM Studio -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">🖥️</span>
                                <span class="local-provider-name">LM Studio</span>
                                <span id="lmstudio-status" class="status-indicator">⏳</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('lmstudio')">↻</button>
                            </div>
                            <div class="local-provider-url">localhost:1234</div>
                            <div id="lmstudio-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar API Key -->
    <div class="modal-overlay" id="modal-add-apikey">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">🔑 Adicionar API Key</h3>
                <button class="modal-close" onclick="closeModal('modal-add-apikey')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Empresa *</label>
                    <select class="form-select" id="input-apikey-empresa">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google (Gemini)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="mistral">Mistral</option>
                        <option value="xai">xAI (Grok)</option>
                        <option value="perplexity">Perplexity</option>
                        <option value="cohere">Cohere</option>
                        <option value="groq">Groq</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="ollama">Ollama (local)</option>
                        <option value="vllm">vLLM (local)</option>
                        <option value="lmstudio">LM Studio (local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key *</label>
                    <input type="password" class="form-input" id="input-apikey-key" placeholder="sk-...">
                    <div class="form-hint">Sua chave será armazenada de forma segura</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome de exibição</label>
                    <input type="text" class="form-input" id="input-apikey-nome" placeholder="Ex: Minha conta OpenAI">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-apikey')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarApiKey()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Modelo -->
    <div class="modal-overlay" id="modal-add-model">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">
                    🤖 Adicionar Modelo
                    <span class="tooltip-icon" data-tooltip="⚠️ Área técnica! Configure um modelo de IA para usar nas correções e no chat." data-tooltip-pos="right">?</span>
                </h3>
                <button class="modal-close" onclick="closeModal('modal-add-model')">×</button>
            </div>
            <div class="modal-body">
                <!-- Linha 1: Apelido e Provider -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">
                            Apelido (Identificador) *
                            <span class="tooltip-icon" data-tooltip="Nome amigável para identificar este modelo na lista. Ex: 'GPT-4o Principal' ou 'Claude para Correções'" data-tooltip-pos="right">?</span>
                        </label>
                        <input type="text" class="form-input" id="input-model-nome" placeholder="Ex: GPT-4o Produção">
                        <div class="form-hint">Nome interno para identificar este modelo na lista</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            Provedor *
                            <span class="tooltip-icon" data-tooltip="Empresa que fornece o modelo. OpenAI (GPT), Anthropic (Claude), Google (Gemini), etc." data-tooltip-pos="right">?</span>
                        </label>
                        <select class="form-select" id="input-model-tipo" onchange="onProviderChange()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                            <option value="xai">xAI (Grok)</option>
                            <option value="perplexity">Perplexity</option>
                            <option value="cohere">Cohere</option>
                            <option value="groq">Groq</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (local)</option>
                            <option value="vllm">vLLM (local)</option>
                            <option value="lmstudio">LM Studio (local)</option>
                            <option value="custom">Customizado</option>
                        </select>
                    </div>
                </div>

                <!-- Linha 2: Modelo (select + input manual) -->
                <div class="form-group">
                    <label class="form-label">Modelo (ID da API) *</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select class="form-select" id="input-model-select" onchange="onModelSelect()" style="flex: 1;">
                            <option value="">-- Selecione ou digite abaixo --</option>
                        </select>
                        <span style="color: var(--text-muted);">ou</span>
                        <input type="text" class="form-input" id="input-model-manual" placeholder="gpt-4o-2024-08-06" style="flex: 1;">
                    </div>
                    <div class="form-hint">O ID exato do modelo enviado para a API (ex: gpt-4o, claude-sonnet-4-5-20250514)</div>
                </div>

                <!-- Aviso de Modelo Reasoning -->
                <div id="reasoning-warning" class="model-warning" style="display: none;">
                    <div class="warning-icon">🧠</div>
                    <div class="warning-text">
                        <strong>Modelo de Raciocínio Detectado</strong>
                        <p>Este modelo usa "reasoning_effort" ao invés de temperatura. Defina abaixo o nível de raciocínio.</p>
                    </div>
                </div>

                <!-- Linha 3: Parâmetros (dinamicamente mostra temp ou reasoning) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">
                            Max Tokens
                            <span class="tooltip-icon" data-tooltip="Limite máximo de caracteres/palavras na resposta da IA. Valores maiores = respostas mais longas (e mais caras)." data-tooltip-pos="right">?</span>
                        </label>
                        <input type="number" class="form-input" id="input-model-tokens" value="4096">
                        <div class="form-hint">Máximo de tokens na resposta</div>
                    </div>
                    <div class="form-group" id="temp-group">
                        <label class="form-label">
                            Temperatura
                            <span class="tooltip-icon" data-tooltip="Controla a 'criatividade' da IA. 0 = sempre a mesma resposta, 0.7 = balanceado, 2 = muito criativo/aleatório." data-tooltip-pos="right">?</span>
                        </label>
                        <input type="number" class="form-input" id="input-model-temp" value="0.7" step="0.1" min="0" max="2">
                        <div class="form-hint">0 = determinístico, 2 = criativo</div>
                    </div>
                    <div class="form-group" id="reasoning-group" style="display: none;">
                        <label class="form-label">
                            Reasoning Effort
                            <span class="tooltip-icon" data-tooltip="Para modelos de raciocínio (o1, o3). Low = respostas rápidas, Medium = balanceado, High = raciocínio profundo." data-tooltip-pos="right">?</span>
                        </label>
                        <select class="form-select" id="input-model-reasoning">
                            <option value="low">Low (rápido)</option>
                            <option value="medium" selected>Medium (balanceado)</option>
                            <option value="high">High (detalhado)</option>
                        </select>
                        <div class="form-hint">Profundidade do raciocínio</div>
                    </div>
                </div>

                <!-- Linha 4: System Prompt com exemplo -->
                <div class="form-group">
                    <label class="form-label">System Prompt Padrão</label>
                    <textarea class="form-textarea" id="input-model-system" rows="4" placeholder="Instruções que definem o comportamento do modelo..."></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                        <div class="form-hint">Deixe vazio para usar o prompt padrão do sistema</div>
                        <button class="btn btn-xs" onclick="preencherSystemPromptPadrao()">Usar Padrão</button>
                    </div>
                </div>

                <!-- Linha 5: Capacidades (checkbox) -->
                <div class="form-group">
                    <label class="form-label">
                        Capacidades do Modelo
                        <span class="tooltip-icon" data-tooltip="Recursos especiais que o modelo suporta. Marque apenas os que o modelo realmente tem!" data-tooltip-pos="right">?</span>
                    </label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <label class="checkbox-label" data-tooltip="Pode analisar imagens e PDFs escaneados" data-tooltip-pos="bottom">
                            <input type="checkbox" id="input-model-vision">
                            <span>👁️ Vision (imagens)</span>
                        </label>
                        <label class="checkbox-label" data-tooltip="Pode executar ferramentas/funções durante a resposta" data-tooltip-pos="bottom">
                            <input type="checkbox" id="input-model-tools">
                            <span>🔧 Tool Use / Functions</span>
                        </label>
                        <label class="checkbox-label" data-tooltip="Mostra a resposta enquanto está sendo gerada" data-tooltip-pos="bottom">
                            <input type="checkbox" id="input-model-streaming" checked>
                            <span>📡 Streaming</span>
                        </label>
                    </div>
                </div>

                <!-- Campo oculto para ID do modelo real -->
                <input type="hidden" id="input-model-modelo">
                <input type="hidden" id="input-model-is-reasoning" value="false">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-model')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarModelo()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Chat com IA -->
    <div class="modal-overlay" id="modal-chat">
        <div class="modal modal-lg" style="max-width: 900px; height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="chat-titulo">💬 Chat com IA</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select class="form-select" id="chat-model-select" style="width: 200px;"></select>
                    <button class="modal-close" onclick="closeModal('modal-chat')">×</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: calc(100% - 130px);">
                <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;"></div>
                <div style="border-top: 1px solid var(--border); padding: 16px; display: flex; gap: 12px;">
                    <textarea class="form-textarea" id="chat-input" placeholder="Digite sua mensagem..." style="flex: 1; min-height: 44px; max-height: 150px; resize: none;"></textarea>
                    <button class="btn btn-primary" onclick="enviarMensagemChat()">Enviar</button>
                </div>
            </div>
            <input type="hidden" id="chat-session-id">
            <input type="hidden" id="chat-atividade-id">
            <input type="hidden" id="chat-aluno-id">
        </div>
    </div>

    <!-- Modal: Boas-vindas ao Protótipo -->
    <div class="modal-overlay modal-welcome" id="modal-welcome">
        <div class="modal">
            <div class="modal-body" style="padding: 28px;">
                <span class="welcome-badge">🧪 PROTÓTIPO</span>
                <h2 class="welcome-title">🎓 Bem-vindo ao Prova AI</h2>
                <p class="welcome-subtitle">Sistema de correção automática de provas e análise educacional com IA</p>
                
                <div class="welcome-section">
                    <h4>🤖 Modelos Disponíveis</h4>
                    <div class="model-chips">
                        <span class="model-chip">
                            <img src="https://cdn.simpleicons.org/openai/white" alt="OpenAI">
                            OpenAI (GPT)
                        </span>
                        <span class="model-chip">
                            <img src="https://cdn.simpleicons.org/google/white" alt="Google">
                            Google (Gemini)
                        </span>
                        <span class="model-chip">
                            <img src="https://cdn.simpleicons.org/anthropic/white" alt="Anthropic">
                            Anthropic (Claude)
                        </span>
                    </div>
                </div>
                
                <div class="welcome-section">
                    <h4>📋 Dois Fluxos Principais</h4>
                    <div class="flow-cards">
                        <div class="flow-card">
                            <div class="flow-card-icon">⚙️</div>
                            <h5>Pipeline de Correção</h5>
                            <p>Adicione provas, gabarito e critérios → Execute o pipeline → Receba correções e relatórios individuais automaticamente</p>
                        </div>
                        <div class="flow-card">
                            <div class="flow-card-icon">💬</div>
                            <h5>Chat com Documentos</h5>
                            <p>Converse com a IA sobre todos os documentos. Use filtros para gerar relatórios específicos de turmas, matérias ou alunos</p>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-section">
                    <h4>🔍 Exemplos de Perguntas ao Chat</h4>
                    <div class="chat-examples">
                        <div class="chat-example">
                            <span class="chat-example-icon">📊</span>
                            <span>"Faça um relatório da turma 3A"</span>
                        </div>
                        <div class="chat-example">
                            <span class="chat-example-icon">👤</span>
                            <span>"Como está o desempenho do João?"</span>
                        </div>
                        <div class="chat-example">
                            <span class="chat-example-icon">❓</span>
                            <span>"Quais questões os alunos mais erraram?"</span>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-tips">
                    <div class="tip-item">
                        <span class="tip-icon">💡</span>
                        <span><strong>Claude</strong> faz relatórios mais elaborados, <strong>Gemini</strong> é mais rápido!</span>
                    </div>
                    <div class="tip-item tip-warning">
                        <span class="tip-icon">💰</span>
                        <span>Protótipo custeado por <strong>Otávio Bopp</strong> — use com moderação 🙏</span>
                    </div>
                </div>
                
                <div class="welcome-footer">
                    <label>
                        <input type="checkbox" id="welcome-dont-show">
                        Não mostrar novamente
                    </label>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-tutorial" onclick="openTutorial()">
                            <span style="font-size: 1.2rem;">🎓</span> Tutorial Interativo
                        </button>
                        <button class="btn btn-primary" onclick="closeWelcome()">Começar a Usar →</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Tutorial Interativo -->
    <div class="modal-overlay modal-tutorial" id="modal-tutorial">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">📖 Tutorial - Prova AI</h3>
                <button class="modal-close" onclick="closeTutorial()">×</button>
            </div>
            
            <div class="tutorial-tabs">
                <button class="tutorial-tab active" data-mode="quick" onclick="switchTutorialMode('quick')">⚡ 3 Passos Essenciais</button>
                <button class="tutorial-tab" data-mode="full" onclick="switchTutorialMode('full')">📚 Completo (8 passos)</button>
            </div>
            
            <div class="modal-body">
                <div class="tutorial-content" id="tutorial-content">
                    <!-- Conteúdo é injetado via JS -->
                </div>
            </div>
            
            <div class="tutorial-nav">
                <button class="btn" id="tutorial-prev" onclick="prevTutorialStep()">← Anterior</button>
                <div class="tutorial-progress">
                    <div class="tutorial-progress-dots" id="tutorial-dots"></div>
                    <span class="tutorial-progress-text" id="tutorial-progress-text">1 de 3</span>
                </div>
                <button class="btn btn-primary" id="tutorial-next" onclick="nextTutorialStep()">Próximo →</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Task Panel (Fila de Tarefas) -->
    <button class="task-fab" id="task-fab" onclick="toggleTaskPanel()">
        📋
        <span class="badge" id="task-badge" style="display:none;">0</span>
    </button>
    <div class="task-panel" id="task-panel">
        <div class="task-panel-header">
            <h4>📋 Tarefas</h4>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-xs" onclick="clearCompletedTasks()">Limpar concluídas</button>
                <button class="btn btn-xs" onclick="toggleTaskPanel()">×</button>
            </div>
        </div>
        <div class="task-panel-body" id="task-panel-body">
            <div class="empty-state" style="padding: 24px; text-align: center;">
                <div style="font-size: 2rem;">📭</div>
                <div style="color: var(--text-muted); font-size: 0.85rem;">Nenhuma tarefa em execução</div>
            </div>
        </div>
    </div>

<!--
╔══════════════════════════════════════════════════════════════════╗
║  FIM DA PARTE 1 - CONTINUE COM A PARTE 2 ABAIXO                 ║
╚══════════════════════════════════════════════════════════════════╝
-->

    <script>
        // ============================================================
        // CONFIGURAÇÃO
        // ============================================================
        // API URL - relative path works in both local and production
        const API = '/api';
        
        let currentView = 'dashboard';
        let currentMateria = null;
        let currentTurma = null;
        let currentAtividade = null;
        let currentAluno = null;
         // Chat Geral
        let chatGeralConversationId = 'chat_' + Date.now();
        let chatGeralProviders = [];

        // ============================================================
        // SISTEMA DE TAREFAS (TASK QUEUE)
        // ============================================================
        const taskQueue = {
            tasks: [],
            results: [],
            maxResults: 20,

            addTask(type, description, atividadeId, alunoId = null) {
                const task = {
                    id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type,
                    description,
                    atividadeId,
                    alunoId,
                    status: 'running',
                    createdAt: new Date(),
                    result: null,
                    error: null
                };
                this.tasks.push(task);
                this.updateUI();
                return task;
            },

            completeTask(taskId, result) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = 'success';
                    task.result = result;
                    task.completedAt = new Date();
                    // Adicionar ao histórico de resultados
                    this.results.unshift({
                        id: task.id,
                        type: task.type,
                        description: task.description,
                        atividadeId: task.atividadeId,
                        alunoId: task.alunoId,
                        result: result,
                        completedAt: task.completedAt
                    });
                    // Limitar histórico
                    if (this.results.length > this.maxResults) {
                        this.results = this.results.slice(0, this.maxResults);
                    }
                    this.updateUI();
                    showToast(`✅ ${task.description} - concluído!`, 'success');
                }
            },

            failTask(taskId, error) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = 'error';
                    task.error = error;
                    task.completedAt = new Date();
                    this.updateUI();
                    showToast(`❌ ${task.description} - falhou: ${error}`, 'error');
                }
            },

            removeTask(taskId) {
                this.tasks = this.tasks.filter(t => t.id !== taskId);
                this.updateUI();
            },

            clearCompleted() {
                this.tasks = this.tasks.filter(t => t.status === 'running');
                this.updateUI();
            },

            clearResult(resultId) {
                this.results = this.results.filter(r => r.id !== resultId);
            },

            getRunningCount() {
                return this.tasks.filter(t => t.status === 'running').length;
            },

            isRunning(type, atividadeId, alunoId = null) {
                return this.tasks.some(t =>
                    t.status === 'running' &&
                    t.type === type &&
                    t.atividadeId === atividadeId &&
                    t.alunoId === alunoId
                );
            },

            updateUI() {
                const fab = document.getElementById('task-fab');
                const badge = document.getElementById('task-badge');
                const body = document.getElementById('task-panel-body');

                const runningCount = this.getRunningCount();
                const totalTasks = this.tasks.length;

                // Mostrar FAB se houver tarefas
                if (totalTasks > 0) {
                    fab.classList.add('show');
                    if (runningCount > 0) {
                        badge.style.display = 'flex';
                        badge.textContent = runningCount;
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    fab.classList.remove('show');
                    badge.style.display = 'none';
                }

                // Renderizar tarefas
                if (totalTasks === 0) {
                    body.innerHTML = `
                        <div class="empty-state" style="padding: 24px; text-align: center;">
                            <div style="font-size: 2rem;">📭</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Nenhuma tarefa em execução</div>
                        </div>
                    `;
                } else {
                    body.innerHTML = this.tasks.map(task => `
                        <div class="task-item ${task.status}">
                            <div class="task-item-header">
                                <span class="task-item-title">${escapeHtml(task.description)}</span>
                                <span class="task-item-status">
                                    ${task.status === 'running' ? '<span class="spinner"></span>' : ''}
                                    ${task.status === 'success' ? '✅' : ''}
                                    ${task.status === 'error' ? '❌' : ''}
                                </span>
                            </div>
                            <div class="task-item-actions">
                                ${task.status === 'success' && task.result ? `<button class="btn btn-xs btn-primary" onclick="viewTaskResult('${task.id}')">Ver Resultado</button>` : ''}
                                ${task.status !== 'running' ? `<button class="btn btn-xs" onclick="taskQueue.removeTask('${task.id}')">Remover</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }
        };

        function toggleTaskPanel() {
            const panel = document.getElementById('task-panel');
            panel.classList.toggle('show');
        }

        function clearCompletedTasks() {
            taskQueue.clearCompleted();
        }

        function viewTaskResult(taskId) {
            const task = taskQueue.tasks.find(t => t.id === taskId);
            if (task && task.result) {
                showResultado(task.type, task.atividadeId, task.alunoId, task.result, task.id);
            }
        }

        function showResultado(type, atividadeId, alunoId, result, taskId) {
            const backButton = atividadeId ?
                `<button class="btn" onclick="showAtividade('${atividadeId}')">← Voltar para Atividade</button>` :
                `<button class="btn" onclick="showDashboard()">← Voltar</button>`;

            const deleteButton = taskId ?
                `<button class="btn btn-danger btn-sm" onclick="deleteResultado('${taskId}')">🗑️ Excluir Visualização</button>` : '';

            document.getElementById('content').innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 class="page-title">Resultado: ${escapeHtml(type)}</h1>
                    ${deleteButton}
                </div>
                <div style="margin-bottom: 16px;">
                    ${backButton}
                </div>
                ${renderResultsNav(atividadeId, alunoId, taskId)}
                <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto; white-space: pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
            `;
        }

        function renderResultsNav(currentAtividadeId, currentAlunoId, currentTaskId) {
            const relevantResults = taskQueue.results.filter(r =>
                r.atividadeId === currentAtividadeId &&
                (!currentAlunoId || r.alunoId === currentAlunoId)
            );

            if (relevantResults.length <= 1) return '';

            return `
                <div class="results-nav">
                    ${relevantResults.map(r => `
                        <div class="results-nav-item ${r.id === currentTaskId ? 'active' : ''}"
                             onclick="showResultado('${escapeHtml(r.type)}', '${r.atividadeId}', '${r.alunoId || ''}', taskQueue.results.find(x => x.id === '${r.id}')?.result, '${r.id}')">
                            ${r.type === 'etapa' ? '📄' : '🚀'} ${escapeHtml(r.description)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function deleteResultado(taskId) {
            if (!confirm('Excluir esta visualização do histórico?')) return;
            taskQueue.clearResult(taskId);
            taskQueue.removeTask(taskId);
            showToast('Visualização removida', 'success');
            // Voltar para atividade se possível
            if (currentAtividade) {
                showAtividade(currentAtividade);
            } else {
                showDashboard();
            }
        }

        // ============================================================
        // TUTORIAL & BOAS-VINDAS
        // ============================================================
        
        // Conteúdo do Tutorial
        const tutorialContent = {
            quick: [
                {
                    title: '👋 Bem-vindo ao Prova AI!',
                    subtitle: 'Vamos conhecer o sistema em 3 passos simples',
                    image: '/static/tutorial-images-v2/01-dashboard-anotado.png',
                    content: `
                        <p>Esta é a <strong>tela inicial</strong> do sistema. Aqui você vê um resumo de tudo:</p>
                        <ul>
                            <li><strong>① Menu Principal</strong> - Use para navegar pelo sistema</li>
                            <li><strong>② Resumo Geral</strong> - Quantas matérias, turmas e alunos você tem</li>
                            <li><strong>③ Botão "+ Nova Matéria"</strong> - Clique aqui para começar!</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>💡 Primeiro passo:</strong> Crie uma matéria para organizar suas turmas e provas.
                        </div>
                    `
                },
                {
                    title: '💬 Converse com a IA',
                    subtitle: 'Faça perguntas e peça relatórios sobre seus documentos',
                    image: '/static/tutorial-images-v2/03-chat-anotado.png',
                    content: `
                        <p>O <strong>Chat com IA</strong> é onde a mágica acontece! Você pode:</p>
                        <ul>
                            <li><strong>① Escolher documentos</strong> - Selecione quais provas e correções a IA deve ler</li>
                            <li><strong>② Filtrar por matéria/turma/aluno</strong> - Foque no que você precisa</li>
                            <li><strong>③ Escolher o modelo de IA</strong> - Claude faz relatórios mais detalhados</li>
                            <li><strong>④ Fazer sua pergunta</strong> - Digite o que você precisa!</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>💡 Experimente perguntar:</strong><br>
                            "Faça um relatório da turma" ou "Como está o desempenho do João?"
                        </div>
                    `
                },
                {
                    title: '📋 Corrija Provas Automaticamente',
                    subtitle: 'Envie as provas e deixe a IA fazer o trabalho pesado',
                    image: '/static/tutorial-images-v2/06-fluxo-correcao.png',
                    content: `
                        <p>Para corrigir provas automaticamente, siga estes <strong>4 passos</strong>:</p>
                        <ul>
                            <li><strong>① Upload do Enunciado</strong> - A prova em branco (PDF ou imagem)</li>
                            <li><strong>② Upload do Gabarito</strong> - As respostas corretas</li>
                            <li><strong>③ Upload das Provas dos Alunos</strong> - As provas respondidas</li>
                            <li><strong>④ Clique em "Pipeline"</strong> - A IA corrige tudo automaticamente!</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>⏱️ Economia de tempo:</strong> O que levaria horas, a IA faz em minutos!
                        </div>
                    `
                }
            ],
            full: [
                {
                    title: '🏠 Tela Inicial (Dashboard)',
                    subtitle: 'Seu painel de controle do sistema',
                    image: '/static/tutorial-images-v2/01-dashboard-anotado.png',
                    content: `
                        <p>A tela inicial mostra um <strong>resumo de tudo</strong> no sistema:</p>
                        <ul>
                            <li><strong>Números no topo:</strong> Total de matérias, turmas, alunos e atividades</li>
                            <li><strong>Alertas em amarelo:</strong> Atividades que ainda precisam de gabarito</li>
                            <li><strong>Cards de matérias:</strong> Clique em uma matéria para ver suas turmas</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>💡 Dica:</strong> Sempre que quiser voltar aqui, clique em "Início" no menu.
                        </div>
                    `
                },
                {
                    title: '📁 Menu de Navegação',
                    subtitle: 'Como se mover pelo sistema',
                    image: '/static/tutorial-images-v2/02-sidebar-anotado.png',
                    content: `
                        <p>O menu do lado esquerdo organiza tudo em uma <strong>árvore</strong>:</p>
                        <ul>
                            <li><strong>① Início</strong> - Volta para a tela inicial</li>
                            <li><strong>② Chat com IA</strong> - Converse sobre seus documentos</li>
                            <li><strong>③ Suas Matérias</strong> - Clique para expandir e ver turmas</li>
                            <li><strong>④ Botão de Ajuda (?)</strong> - Abre este tutorial novamente</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>💡 Estrutura:</strong> Matéria → Turma → Atividade (prova/trabalho)
                        </div>
                    `
                },
                {
                    title: '📚 Criando uma Matéria',
                    subtitle: 'O primeiro passo para organizar suas aulas',
                    image: '/static/tutorial-images-v2/05-nova-materia-anotado.png',
                    content: `
                        <p>Para criar uma nova matéria:</p>
                        <ol>
                            <li>Clique no botão <strong>"+ Nova Matéria"</strong> (no canto inferior do menu)</li>
                            <li><strong>① Nome:</strong> Digite o nome da disciplina (ex: "Matemática")</li>
                            <li><strong>② Descrição:</strong> Opcional - adicione detalhes se quiser</li>
                            <li><strong>③ Nível:</strong> Escolha o nível de ensino</li>
                            <li>Clique em <strong>"Salvar"</strong></li>
                        </ol>
                        <div class="tutorial-highlight">
                            <strong>📝 Próximo passo:</strong> Depois de criar a matéria, adicione uma turma dentro dela!
                        </div>
                    `
                },
                {
                    title: '👥 Adicionando Alunos',
                    subtitle: 'Cadastre os estudantes da sua turma',
                    image: '/static/tutorial-images-v2/03-chat-anotado.png',
                    content: `
                        <p>Existem <strong>duas formas</strong> de adicionar alunos:</p>
                        <ul>
                            <li><strong>Um por um:</strong> Clique em "+ Adicionar Aluno" e preencha nome e matrícula</li>
                            <li><strong>Vários de uma vez:</strong> Use "Importar CSV" para subir uma planilha</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>📋 Formato do CSV:</strong><br>
                            Crie uma planilha com colunas "nome" e "matricula", salve como CSV e faça upload.
                        </div>
                    `
                },
                {
                    title: '📄 Enviando Documentos',
                    subtitle: 'Upload de provas, gabaritos e critérios',
                    image: '/static/tutorial-images-v2/06-fluxo-correcao.png',
                    content: `
                        <p>Para cada atividade, você pode enviar:</p>
                        <ul>
                            <li><strong>Enunciado:</strong> A prova em branco (PDF ou imagem)</li>
                            <li><strong>Gabarito:</strong> As respostas corretas</li>
                            <li><strong>Critérios:</strong> Como você quer que a IA corrija (opcional)</li>
                            <li><strong>Provas respondidas:</strong> O que cada aluno escreveu</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>📸 Formatos aceitos:</strong> PDF, imagens (JPG, PNG), documentos de texto
                        </div>
                    `
                },
                {
                    title: '⚙️ Correção Automática',
                    subtitle: 'Deixe a IA corrigir as provas para você',
                    image: '/static/tutorial-images-v2/06-fluxo-correcao.png',
                    content: `
                        <p>A <strong>correção automática</strong> funciona em etapas:</p>
                        <ol>
                            <li><strong>① Extrai questões</strong> - A IA lê o enunciado da prova</li>
                            <li><strong>② Extrai respostas</strong> - Identifica o que o aluno escreveu</li>
                            <li><strong>③ Compara com gabarito</strong> - Verifica acertos e erros</li>
                            <li><strong>④ Gera relatório</strong> - Cria feedback detalhado</li>
                        </ol>
                        <div class="tutorial-highlight">
                            <strong>🚀 Dica:</strong> Use "Pipeline Turma Toda" para corrigir todos os alunos de uma vez!
                        </div>
                    `
                },
                {
                    title: '💬 Usando o Chat',
                    subtitle: 'Converse com a IA sobre seus documentos',
                    image: '/static/tutorial-images-v2/03-chat-anotado.png',
                    content: `
                        <p>O Chat é muito <strong>poderoso</strong>! Você pode:</p>
                        <ul>
                            <li><strong>Fazer perguntas:</strong> "Quais questões os alunos mais erraram?"</li>
                            <li><strong>Pedir relatórios:</strong> "Faça um resumo do desempenho da turma"</li>
                            <li><strong>Analisar alunos:</strong> "Como está o João em matemática?"</li>
                            <li><strong>Comparar:</strong> "Compare o desempenho das turmas A e B"</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>🎯 Lembre-se:</strong> Use os filtros para a IA focar nos documentos certos!
                        </div>
                    `
                },
                {
                    title: '🔍 Usando Filtros no Chat',
                    subtitle: 'Foque a IA nos documentos que você precisa',
                    image: '/static/tutorial-images-v2/04-chat-exemplos.png',
                    content: `
                        <p>Os <strong>filtros</strong> controlam quais documentos a IA vai ler:</p>
                        <ul>
                            <li><strong>Filtrar por Matéria:</strong> Relatório geral da disciplina</li>
                            <li><strong>Filtrar por Turma:</strong> Visão específica de uma turma</li>
                            <li><strong>Filtrar por Aluno:</strong> Desempenho individual</li>
                            <li><strong>Combinar filtros:</strong> Ex: "João" + "Matemática" = desempenho do João em Matemática</li>
                        </ul>
                        <div class="tutorial-highlight">
                            <strong>💡 Exemplo:</strong> Para ver todos os alunos com dificuldade, filtre por turma e pergunte: 
                            "Quais alunos precisam de atenção especial?"
                        </div>
                    `
                }
            ]
        };
        
        let currentTutorialMode = 'quick';
        let currentTutorialStep = 0;
        
        // ========================================
        // SISTEMA DE TOOLTIPS E AJUDA CONTEXTUAL
        // ========================================
        
        // Descrições dos tipos de documento para hints dinâmicos
        const tipoDocumentoDescricoes = {
            'enunciado': '📄 PDF ou imagem da prova original com as questões',
            'gabarito': '✅ Documento com as respostas corretas de cada questão',
            'criterios_correcao': '📋 Instruções de como avaliar (pontuação, critérios parciais)',
            'prova_respondida': '👤 Prova preenchida por um aluno - selecione o aluno abaixo',
            'correcao_professor': '🧑‍🏫 Sua correção manual para comparar com a IA'
        };
        
        // Atualiza hint quando muda tipo de documento
        function onUploadTipoChange() {
            const tipo = document.getElementById('input-upload-tipo').value;
            const hint = document.getElementById('upload-tipo-hint');
            if (hint && tipoDocumentoDescricoes[tipo]) {
                hint.textContent = tipoDocumentoDescricoes[tipo];
            }
            // Chama função original se existir (para mostrar/esconder seletor de aluno)
            if (typeof atualizarCampoAluno === 'function') {
                atualizarCampoAluno();
            }
        }
        
        // Descrições das etapas do pipeline
        const etapaDescricoes = {
            'extracao_questoes': '🔎 A IA lê o enunciado e identifica cada questão, tipo (múltipla escolha, dissertativa) e pontuação',
            'extracao_gabarito': '🧩 A IA extrai as respostas corretas do gabarito em formato estruturado',
            'extracao_respostas': '📝 A IA lê a prova do aluno e extrai o que ele respondeu em cada questão',
            'correcao': '✅ A IA compara as respostas do aluno com o gabarito e atribui notas',
            'analise_habilidades': '📊 A IA identifica pontos fortes e fracos do aluno por habilidade/competência',
            'relatorio_final': '📄 A IA gera um relatório completo com feedback personalizado para o aluno'
        };
        
        // Textos de ajuda contextual por seção
        const ajudaContextual = {
            'dashboard': {
                titulo: '🏠 Página Inicial',
                conteudo: `
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <div class="help-step-text">Crie uma <strong>Matéria</strong> (ex: Matemática, História)</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">2</div>
                        <div class="help-step-text">Dentro da matéria, crie uma <strong>Turma</strong> (ex: 9º Ano A)</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">3</div>
                        <div class="help-step-text">Adicione <strong>Alunos</strong> à turma</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">4</div>
                        <div class="help-step-text">Crie uma <strong>Atividade</strong> (a prova) e envie os documentos</div>
                    </div>
                    <p style="margin-top: 12px;">A hierarquia é: <strong>Matéria → Turma → Alunos + Atividades</strong></p>
                `
            },
            'atividade': {
                titulo: '📋 Atividade (Prova)',
                conteudo: `
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <div class="help-step-text"><strong>Envie o Enunciado:</strong> PDF da prova original com as questões</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">2</div>
                        <div class="help-step-text"><strong>Envie o Gabarito:</strong> Respostas corretas (pode ser PDF ou texto)</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">3</div>
                        <div class="help-step-text"><strong>Envie as Provas dos Alunos:</strong> Uma por aluno, selecionando quem fez cada uma</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">4</div>
                        <div class="help-step-text"><strong>Execute o Pipeline:</strong> A IA corrige automaticamente todas as provas</div>
                    </div>
                    <p style="margin-top: 12px;">💡 <strong>Dica:</strong> Use "📚 Upload em Lote" para enviar várias provas de uma vez!</p>
                `
            },
            'chat': {
                titulo: '💬 Chat com IA',
                conteudo: `
                    <p>Converse com a IA sobre os documentos que você enviou!</p>
                    <ul>
                        <li><strong>Filtro de Contexto:</strong> Escolha uma atividade para a IA ter acesso aos documentos dela</li>
                        <li><strong>Sem filtro:</strong> A IA responde com conhecimento geral</li>
                        <li><strong>Perguntas úteis:</strong> "Resuma as dificuldades da turma", "Que questões tiveram mais erros?"</li>
                    </ul>
                    <p style="margin-top: 12px;">💡 A IA só vê os documentos do contexto selecionado, não todos os arquivos!</p>
                `
            },
            'prompts': {
                titulo: '🧠 Prompts (Instruções da IA)',
                conteudo: `
                    <p>⚠️ <strong>Área técnica!</strong> Prompts são as instruções que dizem à IA como executar cada etapa.</p>
                    <ul>
                        <li><strong>Prompt de Sistema:</strong> Define o "personagem" da IA (ex: você é um professor)</li>
                        <li><strong>Prompt de Usuário:</strong> O que a IA deve fazer com os documentos</li>
                        <li><strong>Variáveis:</strong> Palavras entre {chaves} são substituídas automaticamente</li>
                    </ul>
                    <p style="margin-top: 12px; color: var(--warning);">⚠️ Modificar prompts pode afetar a qualidade das correções!</p>
                `
            },
            'providers': {
                titulo: '🤖 Modelos de IA',
                conteudo: `
                    <p>⚠️ <strong>Área técnica!</strong> Configure quais modelos de IA estão disponíveis.</p>
                    <ul>
                        <li><strong>API Keys:</strong> Chaves de acesso para cada provedor (OpenAI, Google, etc.)</li>
                        <li><strong>Modelos:</strong> Versões específicas (GPT-4o, Claude, Gemini)</li>
                        <li><strong>Local:</strong> Modelos rodando no seu computador (Ollama, LM Studio)</li>
                    </ul>
                    <p style="margin-top: 12px;">💡 As chaves já estão configuradas! Só mexa aqui se souber o que está fazendo.</p>
                `
            },
            'settings': {
                titulo: '⚙️ Configurações Avançadas',
                conteudo: `
                    <p>⚠️ <strong>Área técnica!</strong> Aqui você configura as conexões com os provedores de IA.</p>
                    <ul>
                        <li><strong>API Keys:</strong> Chaves secretas para acessar cada serviço</li>
                        <li><strong>Catálogo:</strong> Lista de modelos disponíveis por provedor</li>
                        <li><strong>Customizado:</strong> Endpoints personalizados (Azure, AWS, etc.)</li>
                    </ul>
                    <p style="margin-top: 12px; color: var(--warning);">⚠️ Se você não é desenvolvedor, provavelmente não precisa mexer aqui!</p>
                `
            },
            'turma': {
                titulo: '👨‍🎓 Turma',
                conteudo: `
                    <p>Gerencie os alunos e atividades desta turma.</p>
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <div class="help-step-text"><strong>Adicione Alunos:</strong> Clique em "+ Adicionar Aluno" ou importe uma lista CSV</div>
                    </div>
                    <div class="help-step">
                        <div class="help-step-number">2</div>
                        <div class="help-step-text"><strong>Crie Atividades:</strong> Clique em "+ Nova Atividade" para adicionar provas</div>
                    </div>
                    <p style="margin-top: 12px;">💡 Uma turma pode ter vários alunos e várias atividades (provas).</p>
                `
            },
            'materia': {
                titulo: '📚 Matéria',
                conteudo: `
                    <p>Organize suas turmas por matéria.</p>
                    <div class="help-step">
                        <div class="help-step-number">1</div>
                        <div class="help-step-text"><strong>Crie Turmas:</strong> Clique em "+ Nova Turma" para organizar por período/série</div>
                    </div>
                    <p style="margin-top: 12px;">💡 Exemplo: Matéria "Matemática" → Turmas "9º A", "9º B", "1º EM"</p>
                `
            }
        };
        
        // Mostra/esconde painel de ajuda
        function toggleHelpPanel(secao) {
            const panelId = `help-panel-${secao}`;
            let panel = document.getElementById(panelId);
            
            if (panel) {
                panel.classList.toggle('show');
                return;
            }
            
            // Se não existe, cria dinamicamente
            const ajuda = ajudaContextual[secao];
            if (!ajuda) return;
            
            // Encontra onde inserir
            const content = document.getElementById('content');
            const firstChild = content.firstElementChild;
            
            if (firstChild) {
                panel = document.createElement('div');
                panel.id = panelId;
                panel.className = 'help-panel show';
                panel.innerHTML = `
                    <div class="help-panel-header">
                        <div class="help-panel-title">💡 ${ajuda.titulo}</div>
                        <button class="help-panel-close" onclick="toggleHelpPanel('${secao}')">×</button>
                    </div>
                    <div class="help-panel-content">
                        ${ajuda.conteudo}
                        <a class="help-link" onclick="openTutorial()">📖 Ver tutorial completo →</a>
                    </div>
                `;
                content.insertBefore(panel, firstChild);
            }
        }
        
        // Remove painéis de ajuda ao mudar de seção
        function clearHelpPanels() {
            document.querySelectorAll('.help-panel').forEach(p => p.remove());
        }
        
        // ============================================================
        // TOGGLE VISUAL / JSON
        // ============================================================
        
        // Preferência de visualização (localStorage)
        let viewPreference = localStorage.getItem('prova-ai-view-mode') || 'visual';
        
        // Renderiza toggle de visualização
        function renderViewToggle(containerId) {
            return `
                <div class="view-toggle" id="view-toggle-${containerId}">
                    <button class="view-toggle-btn ${viewPreference === 'visual' ? 'active' : ''}" 
                            onclick="setViewMode('visual', '${containerId}')">
                        📊 Visual
                    </button>
                    <button class="view-toggle-btn ${viewPreference === 'json' ? 'active' : ''}" 
                            onclick="setViewMode('json', '${containerId}')">
                        { } JSON
                    </button>
                </div>
            `;
        }
        
        // Alterna modo de visualização
        function setViewMode(mode, containerId) {
            viewPreference = mode;
            localStorage.setItem('prova-ai-view-mode', mode);
            
            // Atualiza botões
            const toggle = document.getElementById(`view-toggle-${containerId}`);
            if (toggle) {
                toggle.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent.includes(mode === 'visual' ? 'Visual' : 'JSON'));
                });
            }
            
            // Atualiza containers
            const visualContainer = document.getElementById(`${containerId}-visual`);
            const jsonContainer = document.getElementById(`${containerId}-json`);
            
            if (visualContainer) visualContainer.style.display = mode === 'visual' ? 'block' : 'none';
            if (jsonContainer) jsonContainer.style.display = mode === 'json' ? 'block' : 'none';
        }
        
        // Renderiza dados visuais do resultado do aluno
        function renderResultadoVisual(resultado) {
            if (!resultado || Object.keys(resultado).length === 0) {
                return '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-title">Sem dados</div></div>';
            }
            
            let html = '<div class="visual-data">';
            
            // Resumo geral (nota, acertos, etc)
            const nota = resultado.nota_final ?? resultado.nota ?? resultado.pontuacao ?? null;
            const acertos = resultado.acertos ?? resultado.questoes_corretas ?? null;
            const total = resultado.total_questoes ?? resultado.questoes?.length ?? null;
            
            if (nota !== null || acertos !== null) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">📊 Resumo</div>
                        <div class="data-grid">
                `;
                
                if (nota !== null) {
                    const notaClass = nota >= 7 ? 'success' : nota >= 5 ? 'warning' : 'danger';
                    html += `
                        <div class="data-item">
                            <div class="data-label">Nota Final</div>
                            <div class="data-value large ${notaClass}">${typeof nota === 'number' ? nota.toFixed(1) : nota}</div>
                        </div>
                    `;
                }
                
                if (acertos !== null && total !== null) {
                    const pct = Math.round((acertos / total) * 100);
                    html += `
                        <div class="data-item">
                            <div class="data-label">Acertos</div>
                            <div class="data-value large">${acertos}/${total}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Aproveitamento</div>
                            <div class="data-value large ${pct >= 70 ? 'success' : pct >= 50 ? 'warning' : 'danger'}">${pct}%</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
            }
            
            // Questões detalhadas
            const questoes = resultado.questoes || resultado.correcoes || resultado.itens || [];
            if (questoes.length > 0) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">📝 Questões (${questoes.length})</div>
                `;
                
                questoes.forEach((q, i) => {
                    const num = q.numero ?? q.questao ?? (i + 1);
                    const pontosObtidos = q.pontos_obtidos ?? q.pontuacao ?? q.nota ?? null;
                    const pontosMax = q.pontos_maximos ?? q.valor ?? q.peso ?? null;
                    const correta = q.correta ?? q.correto ?? (pontosObtidos === pontosMax);
                    const parcial = pontosObtidos !== null && pontosMax !== null && pontosObtidos > 0 && pontosObtidos < pontosMax;
                    
                    const statusClass = parcial ? 'parcial' : (correta ? 'correta' : 'incorreta');
                    const pontuacaoClass = parcial ? 'warning' : (correta ? 'success' : 'danger');
                    
                    html += `
                        <div class="questao-card ${statusClass}">
                            <div class="questao-header">
                                <span class="questao-numero">Questão ${num}</span>
                                ${pontosObtidos !== null && pontosMax !== null ? 
                                    `<span class="questao-pontuacao ${pontuacaoClass}">${pontosObtidos}/${pontosMax} pts</span>` : 
                                    `<span class="questao-pontuacao ${pontuacaoClass}">${correta ? '✓ Correta' : '✗ Incorreta'}</span>`
                                }
                            </div>
                            ${q.resposta_aluno ? `<div class="questao-resposta"><strong>Resposta:</strong> ${escapeHtml(String(q.resposta_aluno))}</div>` : ''}
                            ${q.resposta_correta && !correta ? `<div class="questao-resposta" style="color: var(--success);"><strong>Esperado:</strong> ${escapeHtml(String(q.resposta_correta))}</div>` : ''}
                            ${q.feedback || q.comentario ? `<div class="questao-feedback">${escapeHtml(q.feedback || q.comentario)}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Habilidades/competências
            const habilidades = resultado.habilidades || resultado.competencias || resultado.analise_habilidades || null;
            if (habilidades && (Array.isArray(habilidades) || typeof habilidades === 'object')) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">🎯 Habilidades</div>
                `;
                
                const habArray = Array.isArray(habilidades) ? habilidades : Object.entries(habilidades).map(([k,v]) => ({nome: k, valor: v}));
                
                habArray.forEach(h => {
                    const nome = h.nome || h.habilidade || h.competencia || 'Habilidade';
                    const valor = h.valor ?? h.nivel ?? h.desempenho ?? h.pontuacao ?? 0;
                    const valorNum = typeof valor === 'number' ? valor : parseInt(valor) || 0;
                    const pct = valorNum > 1 ? valorNum : valorNum * 100;
                    const cor = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
                    
                    html += `
                        <div class="habilidade-item">
                            <span class="habilidade-nome">${escapeHtml(nome)}</span>
                            <div class="habilidade-barra">
                                <div class="habilidade-barra-fill" style="width: ${Math.min(pct, 100)}%; background: ${cor};"></div>
                            </div>
                            <span class="habilidade-valor" style="color: ${cor};">${Math.round(pct)}%</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Feedback geral
            const feedback = resultado.feedback || resultado.comentario_geral || resultado.observacoes || null;
            if (feedback) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">💬 Feedback</div>
                        <p style="line-height: 1.6; color: var(--text-secondary);">${escapeHtml(feedback)}</p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Renderiza dashboard visual genérico
        function renderDashboardVisual(data, tipo) {
            if (!data || Object.keys(data).length === 0) {
                return '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-title">Sem dados</div></div>';
            }
            
            let html = '<div class="visual-data">';
            
            // Estatísticas principais
            const stats = [];
            
            // Detecta campos comuns de dashboards
            if (data.total_alunos !== undefined) stats.push({label: 'Total de Alunos', value: data.total_alunos, icon: '👥'});
            if (data.total_atividades !== undefined) stats.push({label: 'Atividades', value: data.total_atividades, icon: '📝'});
            if (data.media_geral !== undefined) stats.push({label: 'Média Geral', value: typeof data.media_geral === 'number' ? data.media_geral.toFixed(1) : data.media_geral, icon: '📊', class: data.media_geral >= 7 ? 'success' : data.media_geral >= 5 ? 'warning' : 'danger'});
            if (data.media !== undefined) stats.push({label: 'Média', value: typeof data.media === 'number' ? data.media.toFixed(1) : data.media, icon: '📊', class: data.media >= 7 ? 'success' : data.media >= 5 ? 'warning' : 'danger'});
            if (data.aprovados !== undefined) stats.push({label: 'Aprovados', value: data.aprovados, icon: '✅', class: 'success'});
            if (data.reprovados !== undefined) stats.push({label: 'Reprovados', value: data.reprovados, icon: '❌', class: 'danger'});
            if (data.pendentes !== undefined) stats.push({label: 'Pendentes', value: data.pendentes, icon: '⏳', class: 'warning'});
            if (data.concluidas !== undefined) stats.push({label: 'Concluídas', value: data.concluidas, icon: '✅', class: 'success'});
            
            if (stats.length > 0) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">📊 Estatísticas</div>
                        <div class="data-grid">
                            ${stats.map(s => `
                                <div class="data-item">
                                    <div class="data-label">${s.icon} ${s.label}</div>
                                    <div class="data-value large ${s.class || ''}">${s.value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Lista de alunos se existir
            if (data.alunos && Array.isArray(data.alunos)) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">👥 Alunos (${data.alunos.length})</div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Média</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.alunos.slice(0, 10).map(a => `
                                    <tr>
                                        <td><strong>${escapeHtml(a.nome || a.aluno_nome || 'Aluno')}</strong></td>
                                        <td>${a.media !== undefined ? (typeof a.media === 'number' ? a.media.toFixed(1) : a.media) : '-'}</td>
                                        <td>${a.status ? `<span class="badge badge-${a.status === 'aprovado' ? 'success' : a.status === 'reprovado' ? 'danger' : 'warning'}">${a.status}</span>` : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${data.alunos.length > 10 ? `<p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">... e mais ${data.alunos.length - 10} alunos</p>` : ''}
                    </div>
                `;
            }
            
            // Atividades se existir
            if (data.atividades && Array.isArray(data.atividades)) {
                html += `
                    <div class="data-section">
                        <div class="data-section-title">📝 Atividades (${data.atividades.length})</div>
                        ${data.atividades.slice(0, 5).map(a => `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <span>${escapeHtml(a.nome || a.titulo || 'Atividade')}</span>
                                <span style="color: var(--text-secondary);">${a.data || a.criado_em || ''}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // Container com toggle visual/json
        function renderDataWithToggle(containerId, data, visualRenderer) {
            const visualHtml = visualRenderer(data);
            const jsonHtml = `<pre style="background: var(--bg); padding: 16px; border-radius: 8px; overflow:auto; max-height: 500px;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
            
            return `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                    ${renderViewToggle(containerId)}
                </div>
                <div id="${containerId}-visual" style="display: ${viewPreference === 'visual' ? 'block' : 'none'};">
                    ${visualHtml}
                </div>
                <div id="${containerId}-json" style="display: ${viewPreference === 'json' ? 'block' : 'none'};">
                    ${jsonHtml}
                </div>
            `;
        }

        function openWelcome() {
            document.getElementById('modal-welcome').classList.add('active');
            // Remove pulse animation after first click
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) helpBtn.classList.remove('pulse');
        }
        
        function closeWelcome() {
            const dontShow = document.getElementById('welcome-dont-show').checked;
            if (dontShow) {
                localStorage.setItem('prova-ai-welcomed', 'true');
            }
            document.getElementById('modal-welcome').classList.remove('active');
            // Also stop pulsing when user closes welcome
            const helpBtn = document.getElementById('help-btn');
            if (helpBtn) helpBtn.classList.remove('pulse');
        }
        
        function openTutorial() {
            document.getElementById('modal-welcome').classList.remove('active');
            document.getElementById('modal-tutorial').classList.add('active');
            currentTutorialStep = 0;
            renderTutorialStep();
        }
        
        function closeTutorial() {
            document.getElementById('modal-tutorial').classList.remove('active');
        }
        
        function switchTutorialMode(mode) {
            currentTutorialMode = mode;
            currentTutorialStep = 0;
            
            // Update tabs
            document.querySelectorAll('.tutorial-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mode === mode);
            });
            
            renderTutorialStep();
        }
        
        function renderTutorialStep() {
            const steps = tutorialContent[currentTutorialMode];
            const step = steps[currentTutorialStep];
            
            const content = document.getElementById('tutorial-content');
            content.innerHTML = `
                <div class="tutorial-step active">
                    <h2 class="tutorial-step-title">${step.title}</h2>
                    <p class="tutorial-step-subtitle">${step.subtitle}</p>
                    <div class="tutorial-image-container">
                        <img src="${step.image}" alt="${step.title}" class="tutorial-image" 
                             onload="this.parentElement.style.minHeight='auto'"
                             onerror="this.outerHTML='<div class=tutorial-image-placeholder><span class=tutorial-image-placeholder-icon>🖼️</span><span>Imagem indisponível</span></div>'">
                    </div>
                    <div class="tutorial-text">${step.content}</div>
                </div>
            `;
            
            // Update navigation
            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');
            
            prevBtn.disabled = currentTutorialStep === 0;
            prevBtn.style.visibility = currentTutorialStep === 0 ? 'hidden' : 'visible';
            
            if (currentTutorialStep === steps.length - 1) {
                nextBtn.textContent = 'Concluir ✓';
                nextBtn.onclick = closeTutorial;
            } else {
                nextBtn.textContent = 'Próximo →';
                nextBtn.onclick = nextTutorialStep;
            }
            
            // Update dots
            const dotsContainer = document.getElementById('tutorial-dots');
            dotsContainer.innerHTML = steps.map((_, i) => `
                <span class="tutorial-dot ${i === currentTutorialStep ? 'active' : ''} ${i < currentTutorialStep ? 'completed' : ''}"></span>
            `).join('');
            
            // Update progress text
            document.getElementById('tutorial-progress-text').textContent = 
                `${currentTutorialStep + 1} de ${steps.length}`;
        }
        
        function nextTutorialStep() {
            const steps = tutorialContent[currentTutorialMode];
            if (currentTutorialStep < steps.length - 1) {
                currentTutorialStep++;
                renderTutorialStep();
            }
        }
        
        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                renderTutorialStep();
            }
        }
        
        function checkFirstVisit() {
            const welcomed = localStorage.getItem('prova-ai-welcomed');
            if (!welcomed) {
                setTimeout(() => openWelcome(), 500);
            }
        }

        // ============================================================
        // INICIALIZAÇÃO
        // ============================================================

        document.addEventListener('DOMContentLoaded', () => {
            loadNavTree();
            showDashboard();
            setupUploadZone();
            setupBusca();
            loadTiposDocumentos();
            loadNiveisEnsino();
            loadChatGeralProviders();
            checkFirstVisit();
        });
        
        // ============================================================
        // API HELPERS
        // ============================================================
        async function parseApiResponse(response) {
            const text = await response.text();
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return text ? JSON.parse(text) : {};
            }
            try {
                return text ? JSON.parse(text) : {};
            } catch (e) {
                return { raw: text };
            }
        }

        async function api(endpoint, options = {}) {
            try {
                const response = await fetch(`${API}${endpoint}`, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', ...options.headers }
                });
                const data = await parseApiResponse(response);
                if (!response.ok) {
                    const message = data?.detail || data?.message || data?.raw || 'Erro na requisição';
                    throw new Error(message);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }
        
        async function apiForm(endpoint, formData) {
            try {
                const response = await fetch(`${API}${endpoint}`, { method: 'POST', body: formData });
                const data = await parseApiResponse(response);
                if (!response.ok) {
                    const message = data?.detail || data?.message || data?.raw || 'Erro na requisição';
                    throw new Error(message);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }
        
        // ============================================================
        // NAVEGAÇÃO - ÁRVORE
        // ============================================================
        async function loadNavTree() {
            try {
                const data = await api('/navegacao/arvore');
                renderNavTree(data.materias);
            } catch (e) {
                console.error('Erro ao carregar árvore:', e);
            }
        }
        
        function renderNavTree(materias) {
            const container = document.getElementById('tree-materias');
            if (materias.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--text-muted); font-size: 0.85rem;">Nenhuma matéria ainda</div>';
                return;
            }
            
            container.innerHTML = materias.map(materia => `
                <div class="tree-item" onclick="showMateria('${materia.id}')">
                    <span class="tree-toggle ${materia.turmas.length > 0 ? '' : 'hidden'}" onclick="event.stopPropagation(); toggleTree(this)">▶</span>
                    <span class="tree-item-icon">📚</span>
                    <span class="tree-item-name">${materia.nome}</span>
                    <span class="tree-item-count">${materia.turmas.length}</span>
                </div>
                <div class="tree-children" id="tree-materia-${materia.id}">
                    ${materia.turmas.map(turma => `
                        <div class="tree-item" onclick="showTurma('${turma.id}')">
                            <span class="tree-toggle ${turma.atividades.length > 0 ? '' : 'hidden'}" onclick="event.stopPropagation(); toggleTree(this)">▶</span>
                            <span class="tree-item-icon">👥</span>
                            <span class="tree-item-name">${turma.nome}</span>
                            <span class="tree-item-count">${turma.total_alunos}</span>
                        </div>
                        <div class="tree-children" id="tree-turma-${turma.id}">
                            ${turma.atividades.map(ativ => `
                                <div class="tree-item" onclick="showAtividade('${ativ.id}')">
                                    <span class="tree-item-icon">📝</span>
                                    <span class="tree-item-name">${ativ.nome}</span>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        function toggleTree(el) {
            el.classList.toggle('expanded');
            const children = el.closest('.tree-item').nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('expanded');
            }
        }
        
        // ============================================================
        // VIEWS
        // ============================================================
        async function showDashboard() {
            currentView = 'dashboard';
            currentMateria = currentTurma = currentAtividade = null;
            setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}]);
            clearHelpPanels();
            
            try {
                const stats = await api('/estatisticas');
                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">
                            Dashboard
                            <button class="section-help" onclick="toggleHelpPanel('dashboard')" title="Como usar esta página?">?</button>
                        </h1>
                        <p class="page-subtitle">Visão geral do sistema</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value">${stats.total_materias}</div><div class="stat-label">Matérias</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_turmas}</div><div class="stat-label">Turmas</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_alunos}</div><div class="stat-label">Alunos</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_atividades}</div><div class="stat-label">Atividades</div></div>
                    </div>
                    ${stats.alertas.atividades_sem_gabarito > 0 ? `
                        <div class="alert alert-warning">
                            <span class="alert-icon">⚠️</span>
                            <div class="alert-content">
                                <div class="alert-title">Atenção</div>
                                <div class="alert-text">${stats.alertas.atividades_sem_gabarito} atividade(s) sem gabarito</div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Matérias</h3>
                            <button class="btn btn-primary btn-sm" onclick="openModal('modal-materia')">+ Nova</button>
                        </div>
                        <div class="card-grid" id="grid-materias"><div style="color: var(--text-muted);">Carregando...</div></div>
                    </div>
                `;
                
                const materiasData = await api('/materias');
                const gridMaterias = document.getElementById('grid-materias');
                if (materiasData.materias.length === 0) {
                    gridMaterias.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">📚</div><div class="empty-title">Nenhuma matéria</div><div class="empty-text">Comece criando sua primeira matéria</div><button class="btn btn-primary" onclick="openModal('modal-materia')">+ Criar Matéria</button></div>`;
                } else {
                    gridMaterias.innerHTML = materiasData.materias.map(m => `<div class="card-grid-item" onclick="showMateria('${m.id}')"><div class="card-icon">📚</div><div class="card-name">${m.nome}</div><div class="card-meta">${m.descricao || 'Sem descrição'}</div></div>`).join('');
                }
            } catch (e) {
                document.getElementById('content').innerHTML = `<div class="alert alert-danger"><span class="alert-icon">❌</span><div class="alert-content"><div class="alert-title">Erro ao carregar</div><div class="alert-text">Verifique se o servidor está rodando corretamente</div></div></div>`;
            }
        }
        
        async function showMateria(materiaId) {
            currentView = 'materia';
            currentMateria = materiaId;
            currentTurma = currentAtividade = null;
            
            try {
                const data = await api(`/materias/${materiaId}`);
                setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: data.materia.nome, onclick: `showMateria('${materiaId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div><h1 class="page-title">${data.materia.nome}</h1><p class="page-subtitle">${data.materia.descricao || 'Sem descrição'}</p></div>
                        <button class="btn btn-danger btn-sm" onclick="excluirMateria('${materiaId}')">🗑️ Excluir Matéria</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Turmas (${data.total_turmas})</h3><button class="btn btn-primary btn-sm" onclick="openModalTurma('${materiaId}')">+ Nova Turma</button></div>
                        ${data.turmas.length === 0 ? `<div class="empty-state"><div class="empty-icon">👥</div><div class="empty-title">Nenhuma turma</div><div class="empty-text">Crie uma turma para começar</div></div>` : `<div class="card-grid">${data.turmas.map(t => `<div class="card-grid-item" onclick="showTurma('${t.id}')"><div class="card-icon">👥</div><div class="card-name">${t.nome}</div><div class="card-meta">${t.ano_letivo || ''} ${t.periodo || ''}</div></div>`).join('')}</div>`}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar matéria', 'error'); }
        }
        
        async function showTurma(turmaId) {
            currentView = 'turma';
            currentTurma = turmaId;
            currentAtividade = null;
            
            try {
                const data = await api(`/turmas/${turmaId}`);
                currentMateria = data.turma.materia_id;
                setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: data.materia.nome, onclick: `showMateria('${data.materia.id}')`}, {nome: data.turma.nome, onclick: `showTurma('${turmaId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div><h1 class="page-title">${data.turma.nome}</h1><p class="page-subtitle">${data.materia.nome} • ${data.turma.ano_letivo || ''}</p></div>
                        <button class="btn btn-danger btn-sm" onclick="excluirTurma('${turmaId}')">🗑️ Excluir Turma</button>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="showDashboardTurma('${turmaId}')">📊 Dashboard da Turma</button>
                        <button class="btn" onclick="openModalImportarCsv('${turmaId}')">⬇️ Importar Alunos (CSV)</button>
                        <button class="btn" onclick="exportarAlunosCsv('${turmaId}')">📤 Exportar Alunos (CSV)</button>
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="showTurmaTab('atividades', '${turmaId}')">Atividades (${data.total_atividades})</div>
                        <div class="tab" onclick="showTurmaTab('alunos', '${turmaId}')">Alunos (${data.total_alunos})</div>
                    </div>
                    <div id="turma-content">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Atividades</h3><button class="btn btn-primary btn-sm" onclick="openModalAtividade('${turmaId}')">+ Nova Atividade</button></div>
                            ${data.atividades.length === 0 ? `<div class="empty-state"><div class="empty-icon">📝</div><div class="empty-title">Nenhuma atividade</div></div>` : `<div class="card-grid">${data.atividades.map(a => `<div class="card-grid-item" onclick="showAtividade('${a.id}')"><div class="card-icon">📝</div><div class="card-name">${a.nome}</div><div class="card-meta"><span class="badge badge-${a.tipo === 'prova' ? 'primary' : 'purple'}">${a.tipo || 'outro'}</span> Nota máx: ${a.nota_maxima}</div></div>`).join('')}</div>`}
                        </div>
                    </div>
                `;
                window._turmaData = data;
            } catch (e) { showToast('Erro ao carregar turma', 'error'); }
        }
        
        async function showTurmaTab(tab, turmaId) {
            document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', (tab === 'atividades' && i === 0) || (tab === 'alunos' && i === 1)));
            const data = window._turmaData;
            const container = document.getElementById('turma-content');
            
            if (tab === 'alunos') {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModalAluno('${data.turma.id}')">+ Novo Aluno</button></div>
                        ${data.alunos.length === 0 ? `<div class="empty-state"><div class="empty-icon">👤</div><div class="empty-title">Nenhum aluno</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Nome</th><th>Matrícula</th><th>Email</th><th>Ações</th></tr></thead><tbody>
                                ${data.alunos.map(a => `<tr><td><strong>${a.nome}</strong></td><td>${a.matricula || '-'}</td><td>${a.email || '-'}</td><td><button class="btn btn-sm" onclick="showAluno('${a.id}')">Ver</button> <button class="btn btn-sm btn-danger" onclick="excluirAluno('${a.id}')">🗑️</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } else {
                showTurma(turmaId);
            }
        }
        
        async function showAtividade(atividadeId) {
            currentView = 'atividade';
            currentAtividade = atividadeId;
            currentAluno = null;
            clearHelpPanels();
            
            try {
                const data = await api(`/atividades/${atividadeId}`);
                const turma = await api(`/turmas/${data.atividade.turma_id}`);
                currentTurma = turma.turma.id;
                currentMateria = turma.materia.id;
                
                setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: turma.materia.nome, onclick: `showMateria('${turma.materia.id}')`}, {nome: turma.turma.nome, onclick: `showTurma('${turma.turma.id}')`}, {nome: data.atividade.nome, onclick: `showAtividade('${atividadeId}')`}]);
                
                let alertas = data.documentos_base.faltando.length > 0 ? `<div class="alert alert-warning"><span class="alert-icon">⚠️</span><div class="alert-content"><div class="alert-title">Documentos faltando</div><div class="alert-text">${data.documentos_base.faltando.map(d => `<span class="badge badge-warning">${d}</span>`).join(' ')}</div></div></div>` : '';

                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">
                            ${data.atividade.nome}
                            <button class="section-help" onclick="toggleHelpPanel('atividade')" title="Como corrigir provas?">?</button>
                        </h1>
                        <p class="page-subtitle">${turma.turma.nome} • Nota máx: ${data.atividade.nota_maxima}</p>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="openModalExecucao('${atividadeId}')" data-tooltip="Execute uma etapa específica do pipeline de correção" data-tooltip-pos="bottom">⚙️ Executar Etapa</button>
                        <button class="btn btn-primary" onclick="openModalPipelineCompleto('${atividadeId}', 'aluno')" data-tooltip="Corrige automaticamente a prova de um aluno específico" data-tooltip-pos="bottom">⚡ Pipeline Aluno</button>
                        <button class="btn btn-success" onclick="openModalPipelineCompleto('${atividadeId}', 'turma')" data-tooltip="Corrige automaticamente as provas de TODOS os alunos da turma" data-tooltip-pos="bottom">🚀 Pipeline Turma Toda</button>
                        <button class="btn" onclick="openModalUploadProvas('${atividadeId}')" data-tooltip="Envie várias provas de alunos de uma vez (PDF ou imagens)" data-tooltip-pos="bottom">📚 Upload Provas em Lote</button>
                    </div>
                    ${alertas}
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-card"><div class="stat-value">${data.alunos.total}</div><div class="stat-label">Alunos na turma</div></div>
                        <div class="stat-card"><div class="stat-value">${data.alunos.com_prova}</div><div class="stat-label">Provas entregues</div></div>
                        <div class="stat-card"><div class="stat-value">${data.alunos.corrigidos}</div><div class="stat-label">Corrigidos</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">📄 Documentos da Atividade</h3><button class="btn btn-primary btn-sm" onclick="openModalUpload('${atividadeId}', 'base')">+ Upload</button></div>
                        <div id="docs-base">${renderDocsBase(data.documentos_base.existentes, atividadeId, data.documentos_base.detalhes || {})}</div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">👥 Provas dos Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModalUpload('${atividadeId}', 'aluno')">+ Upload Prova</button></div>
                        <div class="table-container"><table><thead><tr><th>Aluno</th><th>Prova</th><th>Correção</th><th>Relatório</th><th>Ações</th></tr></thead><tbody>
                            ${data.alunos.detalhes.map(a => `<tr><td><strong>${a.aluno_nome}</strong></td><td>${a.tem_prova ? '<span class="badge badge-success">✓</span>' : '<span class="badge badge-danger">Falta</span>'}</td><td>${a.tem_correcao ? '<span class="badge badge-success">✓</span>' : '<span class="badge badge-warning">Pendente</span>'}</td><td>${a.tem_relatorio ? '<span class="badge badge-success">✓</span>' : '<span class="badge badge-warning">Pendente</span>'}</td><td><button class="btn btn-sm" onclick="showResultadoAluno('${atividadeId}', '${a.aluno_id}')">Ver Resultado</button></td></tr>`).join('')}
                        </tbody></table></div>
                    </div>
                `;
                window._atividadeData = data;
                window._turmaData = turma;
            } catch (e) { showToast('Erro ao carregar atividade', 'error'); }
        }
        
        function formatDateTime(value) {
            if (!value) return '';
            try {
                return new Date(value).toLocaleString('pt-BR');
            } catch (e) {
                return value;
            }
        }

        function renderDocumentoItem(doc, options = {}) {
            const metaItems = [];
            if (doc.criado_em) metaItems.push(`Enviado: ${formatDateTime(doc.criado_em)}`);
            if (doc.criado_por) metaItems.push(`Por: ${doc.criado_por}`);
            if (doc.ia_provider) metaItems.push(`IA: ${doc.ia_provider}`);
            if (doc.ia_modelo) metaItems.push(`Modelo: ${doc.ia_modelo}`);
            if (doc.prompt_usado) metaItems.push(`Prompt: ${doc.prompt_usado}`);
            if (doc.prompt_versao) metaItems.push(`Versão: ${doc.prompt_versao}`);
            if (doc.tokens_usados) metaItems.push(`Tokens: ${doc.tokens_usados}`);
            if (doc.tempo_processamento_ms) metaItems.push(`Tempo: ${Math.round(doc.tempo_processamento_ms)}ms`);

            const metaHtml = metaItems.length
                ? `<div class="doc-meta-stack">${metaItems.map(item => `<span class="doc-meta-pill">${escapeHtml(item)}</span>`).join('')}</div>`
                : '';

            const actions = [];
            if (options.showVisualizar) {
                actions.push(`<button class="btn btn-sm" onclick="visualizarDocumento('${doc.id}')">Visualizar</button>`);
            }
            actions.push(`<button class="btn btn-sm" onclick="openDocumento('${doc.id}')">Baixar</button>`);
            if (options.showTrocar && options.onTrocar) {
                actions.push(`<button class="btn btn-sm btn-primary" onclick="${options.onTrocar}">Trocar</button>`);
            }
            if (options.showExcluir) {
                actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteDocumento('${doc.id}')">Excluir</button>`);
            }

            return `
                <div class="doc-item doc-item-static">
                    <div class="doc-icon">${options.icon || '📄'}</div>
                    <div class="doc-info">
                        <div class="doc-name">${escapeHtml(doc.nome_arquivo || doc.id)}</div>
                        ${metaHtml}
                    </div>
                    <div class="doc-actions">${actions.join('')}</div>
                </div>
            `;
        }

        function renderDocumentoGrupo({ titulo, tipo, atividadeId, alunoId, docs, onAdicionar, icon, showVisualizar }) {
            const list = docs || [];
            const adicionarLabel = list.length ? '+ Novo' : 'Upload';
            const btnAdicionar = onAdicionar
                ? `<button class="btn btn-sm btn-primary" onclick="${onAdicionar}">${adicionarLabel}</button>`
                : '';
            const itens = list.length
                ? list.map(doc => renderDocumentoItem(doc, {
                    icon,
                    showVisualizar,
                    showTrocar: Boolean(onAdicionar),
                    showExcluir: true,
                    onTrocar: `openModalUploadSubstituir('${atividadeId}', '${tipo}', '${alunoId || ''}', '${doc.id}')`
                })).join('')
                : `<div class="doc-meta" style="padding: 8px 0;">Nenhum documento enviado.</div>`;
            return `
                <div class="doc-group">
                    <div class="doc-group-header">
                        <div class="doc-group-title">${titulo}${list.length ? ` (${list.length})` : ''}</div>
                        ${btnAdicionar}
                    </div>
                    ${itens}
                </div>
            `;
        }

        function renderDocsBase(existentes, atividadeId, detalhes = {}) {
            const tipos = ['enunciado', 'gabarito', 'criterios_correcao'];
            const nomes = {'enunciado': '📄 Enunciado', 'gabarito': '✅ Gabarito', 'criterios_correcao': '📋 Critérios de Correção'};
            return tipos.map(tipo => {
                const detalhe = detalhes[tipo];
                const docs = Array.isArray(detalhe) ? detalhe : (detalhe ? [detalhe] : []);
                return renderDocumentoGrupo({
                    titulo: nomes[tipo],
                    tipo,
                    atividadeId,
                    docs,
                    icon: tipo === 'gabarito' ? '✅' : (tipo === 'criterios_correcao' ? '📋' : '📄'),
                    onAdicionar: `openModalUploadTipo('${atividadeId}', '${tipo}')`,
                    showVisualizar: true
                });
            }).join('');
        }

        function groupDocumentosPorTipo(documentos) {
            return documentos.reduce((acc, doc) => {
                if (!acc[doc.tipo]) acc[doc.tipo] = [];
                acc[doc.tipo].push(doc);
                return acc;
            }, {});
        }
        
        async function showAlunos() {
            currentView = 'alunos';
            setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: 'Todos os Alunos', onclick: 'showAlunos()'}]);
            
            try {
                const data = await api('/alunos');
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Todos os Alunos</h1><p class="page-subtitle">${data.alunos.length} aluno(s)</p></div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Lista de Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModal('modal-aluno')">+ Novo</button></div>
                        ${data.alunos.length === 0 ? `<div class="empty-state"><div class="empty-icon">👥</div><div class="empty-title">Nenhum aluno</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Nome</th><th>Matrícula</th><th>Email</th><th>Ações</th></tr></thead><tbody>
                                ${data.alunos.map(a => `<tr><td><strong>${a.nome}</strong></td><td>${a.matricula || '-'}</td><td>${a.email || '-'}</td><td><button class="btn btn-sm" onclick="showAluno('${a.id}')">Ver Turmas</button> <button class="btn btn-sm btn-danger" onclick="excluirAluno('${a.id}')">🗑️</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar alunos', 'error'); }
        }

        async function showPrompts() {
            currentView = 'prompts';
            setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: 'Prompts', onclick: 'showPrompts()'}]);
            clearHelpPanels();
            try {
                const [promptsData, etapasData, materiasData] = await Promise.all([
                    api('/prompts'),
                    api('/prompts/etapas'),
                    api('/materias')
                ]);
                const materiaMap = materiasData.materias.reduce((acc, m) => {
                    acc[m.id] = m.nome;
                    return acc;
                }, {});

                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">
                            Prompts
                            <button class="section-help" onclick="toggleHelpPanel('prompts')" title="O que são prompts?">?</button>
                        </h1>
                        <p class="page-subtitle">${promptsData.total} prompt(s) ativos</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Novo Prompt</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-input" id="input-prompt-nome" placeholder="Ex: Extrair gabarito - Matemática">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Etapa *</label>
                            <select class="form-select" id="input-prompt-etapa">
                                ${etapasData.etapas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Matéria (opcional)</label>
                            <select class="form-select" id="input-prompt-materia">
                                <option value="">Global</option>
                                ${materiasData.materias.map(m => `<option value="${m.id}">${m.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-input" id="input-prompt-descricao" placeholder="Descrição opcional">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prompt de Sistema (opcional)</label>
                            <textarea class="form-textarea" id="input-prompt-texto-sistema" placeholder="Instruções de sistema para o modelo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prompt do Usuário *</label>
                            <textarea class="form-textarea" id="input-prompt-texto" placeholder="Digite o prompt do usuário aqui..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="criarPrompt()">Salvar Prompt</button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Prompts Existentes</h3>
                        </div>
                        ${promptsData.prompts.length === 0 ? `<div class="empty-state"><div class="empty-icon">🧠</div><div class="empty-title">Nenhum prompt</div></div>` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Etapa</th>
                                            <th>Matéria</th>
                                            <th>Prompt de Sistema</th>
                                            <th>Prompt do Usuário</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${promptsData.prompts.map(p => `
                                            <tr>
                                                <td><strong>${p.nome}</strong></td>
                                                <td>${p.etapa}</td>
                                                <td>${p.materia_id ? (materiaMap[p.materia_id] || p.materia_id) : 'Global'}</td>
                                                <td title="${escapeHtml(p.texto_sistema || 'Sem prompt de sistema')}">${escapeHtml(truncateText(p.texto_sistema || '—', 80))}</td>
                                                <td title="${escapeHtml(p.texto || '')}">${escapeHtml(truncateText(p.texto || '—', 80))}</td>
                                                <td style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                    <button class="btn btn-sm" onclick="openPromptPreview('${p.id}')">Preview</button>
                                                    <button class="btn btn-sm" onclick="duplicarPrompt('${p.id}')">Duplicar</button>
                                                    <button class="btn btn-sm btn-primary" onclick="definirPromptPadrao('${p.id}')">Definir padrão</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            } catch (e) {
                showToast('Erro ao carregar prompts', 'error');
            }
        }

        async function showProviders() {
            currentView = 'providers';
            setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: 'Modelos de LLM', onclick: 'showProviders()'}]);
            clearHelpPanels();
            try {
                const data = await api('/providers');
                window._providersCache = data.providers || [];
                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">
                            Modelos de LLM
                            <button class="section-help" onclick="toggleHelpPanel('providers')" title="O que são modelos de LLM?">?</button>
                        </h1>
                        <p class="page-subtitle">${data.providers.length} provider(s) disponíveis</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Adicionar / Atualizar Provider</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Provider *</label>
                            <select class="form-select" id="input-provider-tipo">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="ollama">Ollama (Local)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome do Provider *</label>
                            <input type="text" class="form-input" id="input-provider-nome" placeholder="Ex: openai-gpt4o ou meu-provider">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo (nome do API) *</label>
                            <input type="text" class="form-input" id="input-provider-modelo" placeholder="Ex: gpt-4o, claude-sonnet-4-20250514, llama3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key (empresa)</label>
                            <input type="password" class="form-input" id="input-provider-api-key" placeholder="Opcional para OpenAI/Anthropic">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base URL (Ollama)</label>
                            <input type="text" class="form-input" id="input-provider-base-url" placeholder="http://localhost:11434">
                        </div>
                        <button class="btn btn-primary" onclick="criarProvider()">Salvar Provider</button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Providers Existentes</h3>
                        </div>
                        ${data.providers.length === 0 ? `<div class="empty-state"><div class="empty-icon">🤖</div><div class="empty-title">Nenhum provider</div></div>` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Tipo</th>
                                            <th>Modelo</th>
                                            <th>Identificador</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.providers.map(p => `
                                            <tr>
                                                <td><strong>${p.name}</strong></td>
                                                <td>${p.provider_type}</td>
                                                <td>${p.model}</td>
                                                <td>${p.identifier}</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editarProvider('${p.name}')">Editar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            } catch (e) {
                showToast('Erro ao carregar providers', 'error');
            }
        }

        // ============================================================
        // CHAT GERAL
        // ============================================================
        async function showChatGeral(preselectedAtividadeId = null, preselectedAlunoId = null) {
            currentView = 'chat_geral';
            clearHelpPanels();

            // Guardar referência ao aluno pré-selecionado para uso no chat
            window._chatGeralAlunoId = preselectedAlunoId;

            // Breadcrumb dinâmico baseado no contexto
            let breadcrumbItems = [
                {nome: 'Início', onclick: 'showDashboard()'}
            ];
            if (preselectedAtividadeId && window._atividadeData?.atividade) {
                breadcrumbItems.push({nome: window._atividadeData.atividade.nome, onclick: `showAtividade('${preselectedAtividadeId}')`});
            }
            breadcrumbItems.push({nome: 'Chat', onclick: preselectedAtividadeId ? `showChatGeral('${preselectedAtividadeId}')` : 'showChatGeral()'});
            setBreadcrumb(breadcrumbItems);

            // Carregar atividades para contexto
            let atividadesOptions = '<option value="">Sem contexto específico</option>';
            try {
                const data = await api('/atividades');
                if (data.atividades) {
                    atividadesOptions += data.atividades.map(a =>
                        `<option value="${a.id}" ${a.id === preselectedAtividadeId ? 'selected' : ''}>${escapeHtml(a.nome)}</option>`
                    ).join('');
                }
            } catch (e) {}
            
            // Carregar modelos
            let modelsOptions = '<option value="">Selecione um modelo...</option>';
            try {
                const data = await api('/settings/models');
                chatGeralProviders = data.models || [];  // Mantém nome da variável para compatibilidade
                modelsOptions = chatGeralProviders.map(m =>
                    `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${getProviderIcon(m.tipo)} ${escapeHtml(m.nome)} (${m.modelo})</option>`
                ).join('');
                if (chatGeralProviders.length === 0) {
                    modelsOptions = '<option value="">Nenhum modelo configurado</option>';
                }
            } catch (e) {}
            
            document.getElementById('content').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">
                        💬 Chat Geral
                        <button class="section-help" onclick="toggleHelpPanel('chat')" title="Como usar o chat?">?</button>
                    </h1>
                    <p class="page-subtitle">Converse com a IA sobre qualquer assunto ou analise documentos</p>
                </div>
                
                <div class="chat-panel">
                    <div class="chat-panel-header">
                        <div class="chat-provider-info">
                            <span class="chat-provider-icon" id="chat-geral-icon">🤖</span>
                            <span class="chat-provider-name" id="chat-geral-provider-name">Selecione um modelo</span>
                            <span class="chat-provider-model" id="chat-geral-model"></span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select class="form-select" id="chat-geral-model-select" style="width: 250px;" onchange="updateChatGeralHeader()">
                                ${modelsOptions}
                            </select>
                            <button class="btn btn-sm" onclick="limparChatGeral()" title="Limpar conversa">🗑️</button>
                        </div>
                    </div>
                    
                    <div class="chat-context-bar">
                        <span>📎 Contexto (atividade):</span>
                        <select class="form-select" id="chat-geral-context" style="max-width: 300px;">
                            ${atividadesOptions}
                        </select>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">
                            Os documentos da atividade serão anexados automaticamente
                        </span>
                    </div>
                    
                    <div class="chat-messages-container" id="chat-geral-messages">
                        <div class="chat-message assistant">
                            ${preselectedAtividadeId
                                ? `Olá! Estou pronto para ajudar com esta atividade.<br><br>
                                   Os documentos da atividade já estão carregados como contexto. Você pode:<br><br>
                                   • 📄 Perguntar sobre os documentos<br>
                                   • ❓ Tirar dúvidas sobre as questões<br>
                                   • ✅ Discutir correções e respostas<br>
                                   • 📊 Solicitar análises e relatórios<br><br>
                                   Selecione um modelo acima e comece a conversar!`
                                : `Olá! Sou seu assistente educacional. Posso ajudar você a:<br><br>
                                   • 📄 Analisar documentos e provas<br>
                                   • ❓ Extrair e formatar questões<br>
                                   • ✅ Corrigir respostas de alunos<br>
                                   • 📊 Gerar relatórios e análises<br><br>
                                   Selecione um modelo acima e comece a conversar!`}
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="form-textarea" 
                                id="chat-geral-input" 
                                placeholder="Digite sua mensagem... (Enter para enviar, Shift+Enter para nova linha)"
                                rows="1"
                            ></textarea>
                            <button class="btn btn-primary" onclick="enviarMensagemChatGeral()" id="chat-geral-send-btn">
                                Enviar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup do textarea
            const textarea = document.getElementById('chat-geral-input');
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensagemChatGeral();
                }
            });
            
            // Auto-resize do textarea
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            
            updateChatGeralHeader();
        }
        
        function getProviderIcon(tipo) {
            const icons = {
                'openai': '🟢',
                'anthropic': '🟠',
                'google': '🔵',
                'ollama': '🦙',
                'groq': '⚡',
                'openrouter': '🔀'
            };
            return icons[tipo] || '🤖';
        }
        
        function updateChatGeralHeader() {
            const select = document.getElementById('chat-geral-model-select');
            if (!select) return;

            const selectedId = select.value;
            const model = chatGeralProviders.find(m => m.id === selectedId);

            const iconEl = document.getElementById('chat-geral-icon');
            const nameEl = document.getElementById('chat-geral-provider-name');
            const modelEl = document.getElementById('chat-geral-model');

            if (model) {
                iconEl.textContent = getProviderIcon(model.tipo);
                nameEl.textContent = model.nome;
                modelEl.textContent = `(${model.modelo})`;
            } else {
                iconEl.textContent = '🤖';
                nameEl.textContent = 'Selecione um modelo';
                modelEl.textContent = '';
            }
        }

        async function loadChatGeralProviders() {
            try {
                const data = await api('/settings/models');
                chatGeralProviders = data.models || [];
            } catch (e) {
                chatGeralProviders = [];
            }
        }
        
        async function enviarMensagemChatGeral() {
            const input = document.getElementById('chat-geral-input');
            const mensagem = input.value.trim();
            if (!mensagem) return;

            const modelId = document.getElementById('chat-geral-model-select').value;
            if (!modelId) {
                showToast('Selecione um modelo de IA', 'error');
                return;
            }
            
            const atividadeId = document.getElementById('chat-geral-context').value;
            const container = document.getElementById('chat-geral-messages');
            const sendBtn = document.getElementById('chat-geral-send-btn');
            
            // Adicionar mensagem do usuário
            container.innerHTML += `
                <div class="chat-message user">${escapeHtml(mensagem)}</div>
            `;
            input.value = '';
            input.style.height = 'auto';
            container.scrollTop = container.scrollHeight;
            
            // Indicador de digitação
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `
                <div class="chat-message assistant" id="${typingId}">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
            sendBtn.disabled = true;
            
            try {
                // Usar endpoint de chat com documentos
                const result = await api('/chat/com-documentos', {
                    method: 'POST',
                    body: JSON.stringify({
                        mensagem: mensagem,
                        model_id: modelId,
                        atividade_id: atividadeId || null
                    })
                });
                
                // Remover indicador de digitação
                document.getElementById(typingId)?.remove();
                
                if (result.sucesso) {
                    let html = formatChatMessage(result.resposta || 'Sem resposta');
                    
                    // Metadados
                    html += `
                        <div class="chat-message-meta">
                            <span>🤖 ${escapeHtml(result.provider || '')} / ${escapeHtml(result.modelo || '')}</span>
                            ${result.anexos_confirmados ? '<span>📎 Documentos processados</span>' : ''}
                        </div>
                    `;
                    
                    // Arquivos anexados
                    if (result.anexos_enviados && result.anexos_enviados.length > 0) {
                        html += `
                            <div class="chat-message-files">
                                ${result.anexos_enviados.map(a => 
                                    `<span class="chat-message-file">📄 ${escapeHtml(a.nome || 'arquivo')}</span>`
                                ).join('')}
                            </div>
                        `;
                    }
                    
                    container.innerHTML += `<div class="chat-message assistant">${html}</div>`;
                } else {
                    container.innerHTML += `
                        <div class="chat-message assistant" style="border-color: var(--danger);">
                            ❌ Erro: ${escapeHtml(result.erro || 'Erro desconhecido')}
                        </div>
                    `;
                }
                
            } catch (e) {
                document.getElementById(typingId)?.remove();
                container.innerHTML += `
                    <div class="chat-message assistant" style="border-color: var(--danger);">
                        ❌ Erro ao enviar mensagem: ${escapeHtml(e.message)}
                    </div>
                `;
            }
            
            sendBtn.disabled = false;
            container.scrollTop = container.scrollHeight;
        }
        
        function formatChatMessage(text) {
            if (!text) return '';

            // DEBUG
            console.log('formatChatMessage chamada, tamanho:', text.length);

            // 1. PRIMEIRO: Detectar blocos de documento
            const documentBlocks = [];
            const docRegex = /```\s*documento\s*:\s*([^\n\r]+)[\r\n]+([\s\S]*?)```/gi;
            text = text.replace(docRegex, (match, titulo, conteudo) => {
                console.log('Documento encontrado:', titulo);
                documentBlocks.push({ titulo: titulo.trim(), conteudo: conteudo.trim() });
                return `@@DOCBLOCK${documentBlocks.length - 1}@@`;
            });

            // 2. Blocos de código normais
            const codeBlocks = [];
            text = text.replace(/```(\w*)[\r\n]+([\s\S]*?)```/g, (match, lang, code) => {
                codeBlocks.push({ lang, code });
                return `@@CODEBLOCK${codeBlocks.length - 1}@@`;
            });

            // 3. Tabelas markdown
            text = text.replace(/^\|(.+)\|\s*\n\|[-:\s|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm, (match, header, rows) => {
                const headers = header.split('|').map(h => h.trim()).filter(Boolean);
                const bodyRows = rows.trim().split('\n').map(row =>
                    row.split('|').map(c => c.trim()).filter(Boolean)
                );
                let table = '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:0.85rem;"><thead><tr>';
                headers.forEach(h => table += `<th style="border:1px solid var(--border);padding:8px;background:var(--bg-hover);">${h}</th>`);
                table += '</tr></thead><tbody>';
                bodyRows.forEach(row => {
                    table += '<tr>';
                    row.forEach(cell => table += `<td style="border:1px solid var(--border);padding:8px;">${cell}</td>`);
                    table += '</tr>';
                });
                table += '</tbody></table>';
                return table;
            });

            // 4. Títulos
            text = text.replace(/^######\s+(.+)$/gm, '<h6 style="margin:10px 0 6px;font-size:0.9rem;">$1</h6>');
            text = text.replace(/^#####\s+(.+)$/gm, '<h5 style="margin:10px 0 6px;font-size:0.95rem;">$1</h5>');
            text = text.replace(/^####\s+(.+)$/gm, '<h4 style="margin:12px 0 8px;font-size:1rem;">$1</h4>');
            text = text.replace(/^###\s+(.+)$/gm, '<h3 style="margin:14px 0 8px;font-size:1.1rem;">$1</h3>');
            text = text.replace(/^##\s+(.+)$/gm, '<h2 style="margin:16px 0 10px;font-size:1.25rem;">$1</h2>');
            text = text.replace(/^#\s+(.+)$/gm, '<h1 style="margin:18px 0 12px;font-size:1.4rem;border-bottom:2px solid var(--primary);padding-bottom:6px;">$1</h1>');

            // 5. Linha horizontal
            text = text.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">');

            // 6. Blockquotes
            text = text.replace(/^>\s+(.+)$/gm, '<blockquote style="border-left:4px solid var(--primary);padding:8px 16px;margin:12px 0;background:rgba(59,130,246,0.1);font-style:italic;">$1</blockquote>');

            // 7. Listas não ordenadas
            text = text.replace(/^[\*\-]\s+(.+)$/gm, '<li style="margin:4px 0;">$1</li>');
            text = text.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul style="margin:10px 0;padding-left:24px;">$&</ul>');

            // 8. Links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--primary);">$1</a>');

            // 9. Negrito e itálico
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // 10. Código inline
            text = text.replace(/`([^`]+)`/g, '<code style="background:var(--bg-hover);padding:2px 6px;border-radius:4px;">$1</code>');

            // 11. Quebras de linha
            text = text.replace(/\n(?!<)/g, '<br>');
            text = text.replace(/(<\/h[1-6]>|<\/ul>|<\/table>|<\/blockquote>|<hr[^>]*>)<br>/g, '$1');

            // 12. Restaurar blocos de código
            codeBlocks.forEach((block, i) => {
                const escaped = block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text = text.replace(`@@CODEBLOCK${i}@@`, `<pre style="background:var(--bg-hover);padding:12px;border-radius:6px;overflow-x:auto;margin:8px 0;"><code>${escaped}</code></pre>`);
            });

            // 13. Restaurar blocos de documento
            documentBlocks.forEach((block, i) => {
                const docId = `doc_${Date.now()}_${i}`;
                window._documentContents = window._documentContents || {};
                window._documentContents[docId] = block;

                text = text.replace(`@@DOCBLOCK${i}@@`,
                    `<div style="background:linear-gradient(135deg,var(--bg-hover),var(--bg-card));border:2px solid var(--primary);border-radius:12px;padding:16px;margin:12px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                            <span style="font-size:1.5rem;">📄</span>
                            <span style="font-weight:600;">${block.titulo.replace(/</g, '&lt;')}</span>
                        </div>
                        <button onclick="abrirDocumentoGerado('${docId}')" style="background:var(--primary);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;">
                            Abrir Documento
                        </button>
                    </div>`
                );
            });

            return text;
        }

        // Função para abrir documento gerado
        function abrirDocumentoGerado(docId) {
            const docData = window._documentContents?.[docId];
            if (!docData) {
                alert('Documento não encontrado');
                return;
            }

            const htmlContent = convertMarkdownParaHtml(docData.conteudo);
            const htmlCompleto = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>${docData.titulo.replace(/</g, '&lt;')} - Prova AI</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #1f2937; background: #f9fafb; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #3b82f6; }
        .header h1 { color: #1e40af; font-size: 1.8rem; }
        h1 { font-size: 1.5rem; color: #1e40af; margin: 20px 0 12px; border-bottom: 2px solid #3b82f6; padding-bottom: 6px; }
        h2 { font-size: 1.3rem; color: #1e3a8a; margin: 18px 0 10px; }
        h3 { font-size: 1.1rem; margin: 14px 0 8px; }
        table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        th, td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
        th { background: #f3f4f6; }
        blockquote { border-left: 4px solid #3b82f6; padding: 12px 20px; margin: 16px 0; background: #eff6ff; font-style: italic; }
        ul, ol { margin: 12px 0; padding-left: 28px; }
        li { margin: 6px 0; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
        pre { background: #1f2937; color: #f9fafb; padding: 14px; border-radius: 6px; overflow-x: auto; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        pre code { background: none; padding: 0; }
        .print-bar { position: fixed; top: 0; left: 0; right: 0; background: #1e40af; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .print-bar button { background: white; color: #1e40af; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        body { padding-top: 60px; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.85rem; }
        @media print { .print-bar { display: none !important; } body { padding: 0; background: white; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="print-bar">
        <span>${docData.titulo.replace(/</g, '&lt;')}</span>
        <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>
    <div class="container">
        <div class="header">
            <h1>${docData.titulo.replace(/</g, '&lt;')}</h1>
            <div style="color:#6b7280;font-size:0.9rem;">Gerado em ${new Date().toLocaleDateString('pt-BR')}</div>
        </div>
        <div class="content">${htmlContent}</div>
        <div class="footer">Documento gerado por Prova AI</div>
    </div>
</body>
</html>`;

            const novaJanela = window.open('', '_blank');
            if (novaJanela) {
                novaJanela.document.write(htmlCompleto);
                novaJanela.document.close();
            } else {
                alert('Popup bloqueado! Permita popups para este site.');
            }
        }

        function convertMarkdownParaHtml(md) {
            if (!md) return '';
            let html = md;
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => `<pre><code>${code.replace(/</g, '&lt;')}</code></pre>`);
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/^---+$/gm, '<hr>');
            html = html.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            html = html.replace(/^\|(.+)\|\s*\n\|[-:\s|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm, (m, hdr, rows) => {
                const hs = hdr.split('|').map(h => h.trim()).filter(Boolean);
                const rs = rows.trim().split('\n').map(r => r.split('|').map(c => c.trim()).filter(Boolean));
                let t = '<table><thead><tr>' + hs.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                rs.forEach(r => { t += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>'; });
                return t + '</tbody></table>';
            });
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }
        
        function limparChatGeral() {
            if (!confirm('Limpar toda a conversa?')) return;
            chatGeralConversationId = 'chat_' + Date.now();
            const container = document.getElementById('chat-geral-messages');
            if (container) {
                container.innerHTML = `
                    <div class="chat-message assistant">
                        Conversa limpa! Como posso ajudar?
                    </div>
                `;
            }
        }
        
        async function showAluno(alunoId) {
            try {
                const data = await api(`/alunos/${alunoId}`);
                setBreadcrumb([{nome: 'Início', onclick: 'showDashboard()'}, {nome: 'Alunos', onclick: 'showAlunos()'}, {nome: data.aluno.nome, onclick: `showAluno('${alunoId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">${data.aluno.nome}</h1><p class="page-subtitle">Matrícula: ${data.aluno.matricula || 'Não informada'}</p></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="showDashboardAluno('${alunoId}')">📊 Dashboard do Aluno</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Turmas do Aluno (${data.total_turmas})</h3></div>
                        ${data.turmas.length === 0 ? `<div class="empty-state"><div class="empty-icon">👥</div><div class="empty-title">Nenhuma turma</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Matéria</th><th>Turma</th><th>Ano</th><th>Ações</th></tr></thead><tbody>
                                ${data.turmas.map(t => `<tr><td><strong>${t.materia_nome}</strong></td><td>${t.nome}</td><td>${t.ano_letivo || '-'}</td><td><button class="btn btn-sm" onclick="showTurma('${t.id}')">Ver Turma</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar aluno', 'error'); }
        }
        
        // ============================================================
        // BREADCRUMB
        // ============================================================
        function setBreadcrumb(items) {
            document.getElementById('breadcrumb').innerHTML = items.map((item, i) => `<span class="breadcrumb-item ${i === items.length - 1 ? 'current' : ''}" onclick="${item.onclick}">${item.nome}</span>${i < items.length - 1 ? '<span class="breadcrumb-sep">/</span>' : ''}`).join('');
        }
        
        // ============================================================
        // MODAIS
        // ============================================================
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openModalTurma(materiaId) { document.getElementById('input-turma-materia-id').value = materiaId; openModal('modal-turma'); }
        function openModalAtividade(turmaId) { document.getElementById('input-ativ-turma-id').value = turmaId; openModal('modal-atividade'); }
        // ============================================================
        // MODAL ALUNO - Seleção e Criação
        // ============================================================

        let todosAlunos = [];  // Cache de todos os alunos para filtragem
        let alunosDisponiveis = [];  // Alunos que não estão na turma atual
        let alunoSelecionadoId = null;
        let alunoTabAtual = 'selecionar';

        async function openModalAluno(turmaId) {
            document.getElementById('input-aluno-turma-id').value = turmaId || '';
            document.getElementById('input-aluno-selecionado-id').value = '';
            document.getElementById('input-busca-aluno').value = '';
            document.getElementById('input-aluno-nome').value = '';
            document.getElementById('input-aluno-matricula').value = '';
            document.getElementById('input-aluno-email').value = '';
            alunoSelecionadoId = null;

            // Reset to first tab
            switchAlunoTab('selecionar');

            // Load students for selection
            await carregarAlunosParaSelecao(turmaId);

            openModal('modal-aluno');
        }

        function switchAlunoTab(tab) {
            alunoTabAtual = tab;
            const tabSelecionar = document.getElementById('tab-selecionar-aluno');
            const tabCriar = document.getElementById('tab-criar-aluno');
            const btnSelecionar = document.getElementById('tab-btn-selecionar');
            const btnCriar = document.getElementById('tab-btn-criar');
            const btnConfirmar = document.getElementById('btn-confirmar-aluno');

            if (tab === 'selecionar') {
                tabSelecionar.style.display = 'block';
                tabCriar.style.display = 'none';
                btnSelecionar.classList.add('active');
                btnCriar.classList.remove('active');
                btnConfirmar.textContent = 'Adicionar';
            } else {
                tabSelecionar.style.display = 'none';
                tabCriar.style.display = 'block';
                btnSelecionar.classList.remove('active');
                btnCriar.classList.add('active');
                btnConfirmar.textContent = 'Criar e Adicionar';
            }
        }

        async function carregarAlunosParaSelecao(turmaId) {
            const listaEl = document.getElementById('lista-alunos');
            listaEl.innerHTML = '<div class="aluno-list-empty">Carregando...</div>';

            try {
                // Get all students
                const resultAll = await api('/alunos');
                todosAlunos = resultAll.alunos || [];

                // Get students already in this class
                let alunosNaTurma = [];
                if (turmaId) {
                    const resultTurma = await api(`/alunos?turma_id=${turmaId}`);
                    alunosNaTurma = resultTurma.alunos || [];
                }

                // Filter: show only students NOT in the class
                const idsNaTurma = new Set(alunosNaTurma.map(a => a.id));
                alunosDisponiveis = todosAlunos.filter(a => !idsNaTurma.has(a.id));

                // Sort alphabetically
                alunosDisponiveis.sort((a, b) => a.nome.localeCompare(b.nome));

                renderizarListaAlunos(alunosDisponiveis);
            } catch (e) {
                listaEl.innerHTML = '<div class="aluno-list-empty">Erro ao carregar alunos</div>';
            }
        }

        function renderizarListaAlunos(alunos) {
            const listaEl = document.getElementById('lista-alunos');

            if (alunos.length === 0) {
                listaEl.innerHTML = '<div class="aluno-list-empty">Nenhum aluno disponível. Crie um novo na aba "Criar Novo".</div>';
                return;
            }

            listaEl.innerHTML = alunos.map(aluno => {
                const detalhes = [aluno.matricula, aluno.email].filter(Boolean).join(' • ');
                const isSelected = alunoSelecionadoId === aluno.id;
                return `
                    <div class="aluno-item ${isSelected ? 'selected' : ''}" onclick="selecionarAluno('${aluno.id}')">
                        <div class="aluno-item-info">
                            <div class="aluno-item-nome">${aluno.nome}</div>
                            ${detalhes ? `<div class="aluno-item-detalhes">${detalhes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarAlunos() {
            const busca = document.getElementById('input-busca-aluno').value.toLowerCase().trim();

            if (!busca) {
                renderizarListaAlunos(alunosDisponiveis);
                return;
            }

            const filtrados = alunosDisponiveis.filter(aluno =>
                aluno.nome.toLowerCase().includes(busca) ||
                (aluno.matricula && aluno.matricula.toLowerCase().includes(busca)) ||
                (aluno.email && aluno.email.toLowerCase().includes(busca))
            );

            renderizarListaAlunos(filtrados);
        }

        function selecionarAluno(alunoId) {
            alunoSelecionadoId = alunoId;
            document.getElementById('input-aluno-selecionado-id').value = alunoId;

            // Re-render to show selection
            const busca = document.getElementById('input-busca-aluno').value.toLowerCase().trim();
            if (busca) {
                filtrarAlunos();
            } else {
                renderizarListaAlunos(alunosDisponiveis);
            }
        }

        async function confirmarAluno() {
            const turmaId = document.getElementById('input-aluno-turma-id').value;

            if (alunoTabAtual === 'selecionar') {
                // Tab: Select existing student
                if (!alunoSelecionadoId) {
                    showToast('Selecione um aluno da lista', 'error');
                    return;
                }

                try {
                    await api('/alunos/vincular', {
                        method: 'POST',
                        body: JSON.stringify({ aluno_id: alunoSelecionadoId, turma_id: turmaId })
                    });
                    showToast('Aluno adicionado à turma!', 'success');
                    closeModal('modal-aluno');
                    if (turmaId) showTurma(turmaId); else showAlunos();
                } catch (e) {
                    showToast(e.message || 'Erro ao adicionar aluno', 'error');
                }
            } else {
                // Tab: Create new student
                await criarAluno();
            }
        }

        function openModalImportarCsv(turmaId) { document.getElementById('input-importar-turma-id').value = turmaId || ''; openModal('modal-importar-csv'); }

        function openDocumento(documentoId) {
            if (!documentoId) return;
            window.open(`${API}/documentos/${documentoId}/download`, '_blank');
        }



        async function downloadDocumento(documentoId) {
            if (!documentoId) return;
            try {
                const response = await fetch(`${API}/documentos/${documentoId}/download`);
                if (!response.ok) throw new Error('Erro ao baixar');
                
                const blob = await response.blob();
                const contentDisposition = response.headers.get('content-disposition');
                let filename = 'documento';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?(.+)"?/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (e) {
                showToast('Erro ao baixar documento', 'error');
            }
        }

        async function visualizarDocumento(documentoId) {
            if (!documentoId) return;
            try {
                const data = await api(`/documentos/${documentoId}/conteudo`);
                const doc = data.documento || {};
                const titulo = doc.nome_arquivo ? `Visualizar: ${doc.nome_arquivo}` : 'Visualizar Documento';
                document.getElementById('titulo-documento-conteudo').textContent = titulo;
                const meta = [];
                if (doc.tipo) meta.push(`Tipo: ${doc.tipo}`);
                if (doc.ia_provider) meta.push(`IA: ${doc.ia_provider}`);
                if (doc.ia_modelo) meta.push(`Modelo: ${doc.ia_modelo}`);
                if (doc.prompt_usado) meta.push(`Prompt: ${doc.prompt_usado}`);
                if (doc.criado_em) meta.push(`Criado em: ${formatDateTime(doc.criado_em)}`);
                document.getElementById('documento-conteudo-meta').textContent = meta.join(' • ');

                const output = document.getElementById('output-documento-conteudo');
                if (data.pode_visualizar) {
                    const content = data.tipo_conteudo === 'json'
                        ? JSON.stringify(data.conteudo, null, 2)
                        : (data.conteudo || '');
                    output.textContent = content;
                    openModal('modal-documento-conteudo');
                } else {
                    showToast('Documento não possui visualização. Faça o download para ver.', 'warning');
                    openDocumento(documentoId);
                }
            } catch (e) {}
        }

        async function deleteDocumento(documentoId) {
            if (!documentoId) return;
            if (!confirm('Deseja excluir este documento? Esta ação não pode ser desfeita.')) return;
            try {
                await api(`/documentos/${documentoId}`, { method: 'DELETE' });
                showToast('Documento excluído', 'success');
                refreshCurrentView();
            } catch (e) {}
        }

        function refreshCurrentView() {
            if (currentView === 'atividade' && currentAtividade) {
                showAtividade(currentAtividade);
                return;
            }
            if (currentView === 'resultado_aluno' && currentAtividade && currentAluno) {
                showResultadoAluno(currentAtividade, currentAluno);
                return;
            }
            if (currentView === 'turma' && currentTurma) {
                showTurma(currentTurma);
                return;
            }
            if (currentView === 'alunos') {
                showAlunos();
            }
        }

        async function ensureAtividadeData(atividadeId) {
            if (!atividadeId) return null;
            if (!window._atividadeData || window._atividadeData?.atividade?.id !== atividadeId) {
                try {
                    window._atividadeData = await api(`/atividades/${atividadeId}`);
                } catch (e) {
                    window._atividadeData = null;
                }
            }
            return window._atividadeData;
        }

        function renderAlunoOptions(alunos = [], includeEmpty = false) {
            const options = alunos.map(a => {
                const label = a.aluno_nome
                    ? `${a.aluno_nome}${a.aluno_id ? ` • ${a.aluno_id}` : ''}`
                    : (a.aluno_id || 'Aluno');
                return `<option value="${a.aluno_id}">${label}</option>`;
            });
            if (includeEmpty) {
                options.unshift('<option value="">Sem aluno</option>');
            }
            return options.join('');
        }

        function openModalUploadProvas(atividadeId) {
            document.getElementById('input-upload-provas-atividade-id').value = atividadeId;
            openModal('modal-upload-provas');
        }

        async function openModalExecucao(atividadeId) {
            document.getElementById('input-execucao-atividade-id').value = atividadeId;
            await ensureAtividadeData(atividadeId);
            await carregarEtapasExecucao();
            await carregarProvidersExecucao();
            carregarAlunosExecucao();
            openModal('modal-execucao');
        }

        async function openModalPipelineCompleto(atividadeId, modo = 'aluno') {
            try {
                document.getElementById('input-pipeline-atividade-id').value = atividadeId;
                await ensureAtividadeData(atividadeId);
                await carregarPipelineAlunos();
                await carregarPipelineProviders();

                // Definir modo e atualizar UI
                document.querySelector(`input[name="pipeline-modo"][value="${modo}"]`).checked = true;
                onPipelineModoChange();

                // Calcular resumo da turma
                const atividadeData = window._atividadeData;
                const alunosDetalhes = atividadeData?.alunos?.detalhes || [];
                const alunosComProva = alunosDetalhes.filter(a => a.tem_prova);
                document.getElementById('pipeline-turma-resumo').innerHTML = `<strong>${alunosComProva.length}</strong> aluno(s) com prova enviada`;

                openModal('modal-pipeline-completo');
            } catch (e) {
                console.error('Erro ao abrir modal pipeline:', e);
                showToast('Erro ao carregar dados do pipeline', 'error');
            }
        }
        
        async function openModalUpload(atividadeId, modo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            resetUploadReplace();
            const grupoAluno = document.getElementById('grupo-aluno-upload');
            const selectTipo = document.getElementById('input-upload-tipo');
            if (modo === 'aluno') {
                selectTipo.value = 'prova_respondida';
                grupoAluno.style.display = 'block';
                await ensureAtividadeData(atividadeId);
                carregarAlunosParaUpload();
            } else {
                selectTipo.value = 'enunciado';
                grupoAluno.style.display = 'none';
            }
            openModal('modal-upload');
        }
        
        async function openModalUploadTipo(atividadeId, tipo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('grupo-aluno-upload').style.display = 'none';
            await ensureAtividadeData(atividadeId);
            openModal('modal-upload');
        }

        async function openModalUploadAlunoTipo(atividadeId, alunoId, tipo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('grupo-aluno-upload').style.display = 'block';
            await ensureAtividadeData(atividadeId);
            carregarAlunosParaUpload();
            const selectAluno = document.getElementById('input-upload-aluno');
            if (selectAluno) {
                selectAluno.value = alunoId || '';
            }
            openModal('modal-upload');
        }

        async function openModalUploadSubstituir(atividadeId, tipo, alunoId, documentoId) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('input-upload-documento-id').value = documentoId || '';
            const replaceInfo = document.getElementById('upload-replace-info');
            replaceInfo.textContent = 'Substituir documento selecionado: o novo upload excluirá o arquivo anterior. Tipo e aluno ficam bloqueados.';
            replaceInfo.style.display = 'block';
            const selectTipo = document.getElementById('input-upload-tipo');
            const selectAluno = document.getElementById('input-upload-aluno');
            selectTipo.disabled = true;
            selectAluno.disabled = true;
            if ((window._documentosBase || []).includes(tipo)) {
                document.getElementById('grupo-aluno-upload').style.display = 'none';
            } else {
                document.getElementById('grupo-aluno-upload').style.display = 'block';
                if (!window._atividadeData || window._atividadeData?.atividade?.id !== atividadeId) {
                    try {
                        window._atividadeData = await api(`/atividades/${atividadeId}`);
                    } catch (e) {}
                }
                carregarAlunosParaUpload();
                if (selectAluno) {
                    selectAluno.value = alunoId || '';
                }
            }
            openModal('modal-upload');
        }

        function resetUploadReplace() {
            // Limpar estado de substituição
            document.getElementById('input-upload-documento-id').value = '';
            document.getElementById('upload-replace-info').style.display = 'none';
            document.getElementById('upload-replace-info').textContent = '';
            // Reabilitar selects
            document.getElementById('input-upload-tipo').disabled = false;
            const selectAluno = document.getElementById('input-upload-aluno');
            if (selectAluno) selectAluno.disabled = false;
        }

        function carregarAlunosParaUpload() {
            const data = window._atividadeData;
            const select = document.getElementById('input-upload-aluno');
            if (data) {
                select.innerHTML = renderAlunoOptions(data.alunos?.detalhes || []);
            } else if (select) {
                select.innerHTML = '<option value="">Nenhum aluno encontrado</option>';
            }
        }

        function carregarAlunosExecucao() {
            const data = window._atividadeData;
            const select = document.getElementById('input-execucao-aluno');
            if (!select) return;
            if (data && data.alunos?.detalhes) {
                select.innerHTML = renderAlunoOptions(data.alunos.detalhes, true);
            } else {
                select.innerHTML = `<option value="">Sem aluno</option>`;
            }
        }

        async function carregarEtapasExecucao() {
            try {
                const data = await api('/prompts/etapas');
                const select = document.getElementById('input-execucao-etapa');
                select.innerHTML = data.etapas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
                window._etapasData = data.etapas;
                // Atualizar prompts para etapa selecionada
                onEtapaChange();
            } catch (e) {
                console.error('Erro ao carregar etapas:', e);
            }
        }

        // Etapas que não precisam de aluno
        const ETAPAS_SEM_ALUNO = ['extrair_questoes', 'extrair_gabarito'];

        async function onEtapaChange() {
            const etapa = document.getElementById('input-execucao-etapa').value;
            const hint = document.getElementById('input-execucao-aluno-hint');
            const etapaHint = document.getElementById('execucao-etapa-hint');

            // Atualizar hint do aluno
            if (ETAPAS_SEM_ALUNO.includes(etapa)) {
                hint.textContent = 'Esta etapa extrai dados da atividade, não precisa de aluno.';
            } else {
                hint.textContent = 'Selecione o aluno para executar esta etapa.';
            }
            
            // Atualizar hint da etapa com descrição contextual
            if (etapaHint && etapaDescricoes[etapa]) {
                etapaHint.textContent = etapaDescricoes[etapa];
            } else if (etapaHint) {
                etapaHint.textContent = 'Selecione uma etapa para ver sua descrição';
            }

            // Carregar prompts para esta etapa
            await carregarPromptsEtapa(etapa);
        }

        async function carregarPromptsEtapa(etapa) {
            const select = document.getElementById('input-execucao-prompt');
            try {
                const data = await api(`/prompts?etapa=${etapa}`);
                const prompts = data.prompts || [];
                window._promptsEtapa = prompts;

                select.innerHTML = '<option value="">Usar prompt padrão</option>' +
                    prompts.map(p => `<option value="${p.id}">${p.nome}${p.is_padrao ? ' (Padrão)' : ''}</option>`).join('');

                // Mostrar opção de editar
                document.getElementById('grupo-prompt-customizado').style.display = 'block';
                document.getElementById('input-execucao-editar-prompt').checked = false;
                document.getElementById('grupo-prompt-texto').style.display = 'none';
            } catch (e) {
                select.innerHTML = '<option value="">Usar prompt padrão</option>';
                console.error('Erro ao carregar prompts:', e);
            }
        }

        async function onPromptChange() {
            const promptId = document.getElementById('input-execucao-prompt').value;
            if (!promptId) {
                document.getElementById('input-execucao-prompt-texto').value = '';
                return;
            }

            // Buscar texto do prompt selecionado
            const prompts = window._promptsEtapa || [];
            const prompt = prompts.find(p => p.id === promptId);
            if (prompt) {
                document.getElementById('input-execucao-prompt-texto').value = prompt.texto || '';
            }
        }

        function toggleEditarPrompt() {
            const editando = document.getElementById('input-execucao-editar-prompt').checked;
            document.getElementById('grupo-prompt-texto').style.display = editando ? 'block' : 'none';

            // Se habilitou edição, carregar texto do prompt selecionado
            if (editando) {
                onPromptChange();
            }
        }

        async function carregarProvidersExecucao() {
            try {
                const data = await api('/settings/models').catch(() => ({ models: [] }));
                const models = data.models || [];
                const options = models.map(m => `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)} (${m.modelo})</option>`).join('');
                document.getElementById('input-execucao-model').innerHTML = options || '<option value="">Nenhum modelo configurado</option>';
            } catch (e) {}
        }

        async function carregarPipelineAlunos() {
            const data = window._atividadeData;
            const select = document.getElementById('input-pipeline-aluno');
            if (!select) return;

            const detalhes = data?.alunos?.detalhes || [];
            // Filtrar apenas alunos com prova para o pipeline
            const alunosComProva = detalhes.filter(a => a.tem_prova);

            if (alunosComProva.length > 0) {
                select.innerHTML = alunosComProva.map(a =>
                    `<option value="${a.aluno_id}">${a.aluno_nome || a.aluno_id}</option>`
                ).join('');
            } else if (detalhes.length > 0) {
                // Se não tem ninguém com prova, mostrar todos
                select.innerHTML = detalhes.map(a =>
                    `<option value="${a.aluno_id}">${a.aluno_nome || a.aluno_id}</option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">Nenhum aluno na turma</option>';
            }
        }

        async function carregarPipelineProviders() {
            try {
                const [etapasData, modelsData] = await Promise.all([
                    api('/prompts/etapas'),
                    api('/settings/models').catch(() => ({ models: [] }))
                ]);

                const models = modelsData.models || [];
                const defaultModel = models.find(m => m.is_default)?.id || '';
                const modelOptions = models.map(m => `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)} (${m.modelo})</option>`).join('');

                const defaultSelect = document.getElementById('input-pipeline-provider-default');
                if (defaultSelect) {
                    defaultSelect.innerHTML = modelOptions || '<option value="">Nenhum modelo configurado</option>';
                    if (defaultModel) {
                        defaultSelect.value = defaultModel;
                    }
                }

                const etapasPermitidas = [
                    'extrair_questoes',
                    'extrair_gabarito',
                    'extrair_respostas',
                    'corrigir',
                    'analisar_habilidades',
                    'gerar_relatorio'
                ];
                const etapas = (etapasData.etapas || []).filter(e => etapasPermitidas.includes(e.id));
                const container = document.getElementById('pipeline-provider-stages');
                if (container) {
                    container.innerHTML = etapas.map(etapa => `
                        <div style="display: flex; gap: 12px; align-items: center; padding: 8px; border-radius: 6px; background: var(--bg-hover);">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; min-width: 24px;">
                                <input type="checkbox" data-step="${etapa.id}" class="pipeline-step-checkbox" checked>
                            </label>
                            <div style="flex: 1; font-size: 0.85rem; color: var(--text-primary);">${etapa.nome}</div>
                            <select class="form-select" data-etapa="${etapa.id}" style="flex: 1;">
                                <option value="">Usar padrão</option>
                                ${modelOptions}
                            </select>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Erro ao carregar modelos:', e);
            }
        }
        
        // ============================================================
        // CRUD OPERATIONS
        // ============================================================
        async function criarMateria() {
            const nome = document.getElementById('input-materia-nome').value.trim();
            const descricao = document.getElementById('input-materia-desc').value.trim();
            const nivel = document.getElementById('input-materia-nivel').value;
            if (!nome) { showToast('Digite o nome da matéria', 'error'); return; }
            try {
                await api('/materias', { method: 'POST', body: JSON.stringify({ nome, descricao, nivel }) });
                showToast('Matéria criada!', 'success');
                closeModal('modal-materia');
                document.getElementById('input-materia-nome').value = '';
                document.getElementById('input-materia-desc').value = '';
                loadNavTree();
                showDashboard();
            } catch (e) {}
        }
        
        async function criarTurma() {
            const nome = document.getElementById('input-turma-nome').value.trim();
            const anoLetivo = document.getElementById('input-turma-ano').value;
            const periodo = document.getElementById('input-turma-periodo').value.trim();
            const materiaId = document.getElementById('input-turma-materia-id').value;
            if (!nome) { showToast('Digite o nome da turma', 'error'); return; }
            try {
                await api('/turmas', { method: 'POST', body: JSON.stringify({ materia_id: materiaId, nome, ano_letivo: anoLetivo ? parseInt(anoLetivo) : null, periodo: periodo || null }) });
                showToast('Turma criada!', 'success');
                closeModal('modal-turma');
                document.getElementById('input-turma-nome').value = '';
                loadNavTree();
                showMateria(materiaId);
            } catch (e) {}
        }
        
        async function criarAtividade() {
            const nome = document.getElementById('input-ativ-nome').value.trim();
            const tipo = document.getElementById('input-ativ-tipo').value;
            const notaMaxima = document.getElementById('input-ativ-nota').value;
            const turmaId = document.getElementById('input-ativ-turma-id').value;
            if (!nome) { showToast('Digite o nome da atividade', 'error'); return; }
            try {
                await api('/atividades', { method: 'POST', body: JSON.stringify({ turma_id: turmaId, nome, tipo, nota_maxima: parseFloat(notaMaxima) || 10 }) });
                showToast('Atividade criada!', 'success');
                closeModal('modal-atividade');
                document.getElementById('input-ativ-nome').value = '';
                loadNavTree();
                showTurma(turmaId);
            } catch (e) {}
        }
        
        async function criarAluno() {
            const nome = document.getElementById('input-aluno-nome').value.trim();
            const matricula = document.getElementById('input-aluno-matricula').value.trim();
            const email = document.getElementById('input-aluno-email').value.trim();
            const turmaId = document.getElementById('input-aluno-turma-id').value;
            if (!nome) { showToast('Digite o nome do aluno', 'error'); return; }
            try {
                const result = await api('/alunos', { method: 'POST', body: JSON.stringify({ nome, matricula: matricula || null, email: email || null }) });
                if (turmaId && result.aluno) {
                    await api('/alunos/vincular', { method: 'POST', body: JSON.stringify({ aluno_id: result.aluno.id, turma_id: turmaId }) });
                }
                showToast('Aluno criado!', 'success');
                closeModal('modal-aluno');
                document.getElementById('input-aluno-nome').value = '';
                document.getElementById('input-aluno-matricula').value = '';
                document.getElementById('input-aluno-email').value = '';
                if (turmaId) showTurma(turmaId); else showAlunos();
            } catch (e) {}
        }

        async function excluirMateria(id) {
            if (!confirm('Excluir matéria e todas as turmas/atividades relacionadas?')) return;
            try {
                await api(`/materias/${id}`, { method: 'DELETE' });
                showToast('Matéria excluída!', 'success');
                loadNavTree();
                showDashboard();
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function excluirTurma(id) {
            if (!confirm('Excluir turma e todas as atividades relacionadas?')) return;
            try {
                await api(`/turmas/${id}`, { method: 'DELETE' });
                showToast('Turma excluída!', 'success');
                loadNavTree();
                showMateria(currentMateria);
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function excluirAluno(id) {
            if (!confirm('Excluir aluno?')) return;
            try {
                await api(`/alunos/${id}`, { method: 'DELETE' });
                showToast('Aluno excluído!', 'success');
                if (currentTurma) showTurma(currentTurma);
                else if (currentView === 'alunos') showAlunos();
                else showDashboard();
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function criarProvider() {
            const providerType = document.getElementById('input-provider-tipo')?.value;
            const name = document.getElementById('input-provider-nome')?.value.trim();
            const model = document.getElementById('input-provider-modelo')?.value.trim();
            const apiKey = document.getElementById('input-provider-api-key')?.value.trim();
            const baseUrl = document.getElementById('input-provider-base-url')?.value.trim();
            if (!providerType || !name || !model) {
                showToast('Preencha tipo, nome e modelo do provider', 'error');
                return;
            }
            try {
                await api('/providers', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        provider_type: providerType,
                        model,
                        api_key: apiKey || null,
                        base_url: baseUrl || null
                    })
                });
                showToast('Provider salvo!', 'success');
                showProviders();
                carregarProvidersExecucao();
            } catch (e) {
                showToast('Erro ao salvar provider', 'error');
            }
        }

        function editarProvider(providerName) {
            const provider = (window._providersCache || []).find(p => p.name === providerName);
            if (!provider) {
                showToast('Provider não encontrado', 'error');
                return;
            }
            document.getElementById('input-provider-tipo').value = provider.provider_type;
            document.getElementById('input-provider-nome').value = provider.name;
            document.getElementById('input-provider-modelo').value = provider.model;
            document.getElementById('input-provider-api-key').value = '';
            document.getElementById('input-provider-base-url').value = '';
            showToast('Atualize os campos e salve o provider', 'success');
        }

        async function criarPrompt() {
            const nome = document.getElementById('input-prompt-nome').value.trim();
            const etapa = document.getElementById('input-prompt-etapa').value;
            const materiaId = document.getElementById('input-prompt-materia').value;
            const descricao = document.getElementById('input-prompt-descricao').value.trim();
            const textoSistema = document.getElementById('input-prompt-texto-sistema').value.trim();
            const texto = document.getElementById('input-prompt-texto').value.trim();
            if (!nome || !texto) { showToast('Preencha nome e texto do prompt', 'error'); return; }
            try {
                await api('/prompts', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome,
                        etapa,
                        texto,
                        texto_sistema: textoSistema || null,
                        descricao: descricao || null,
                        materia_id: materiaId || null
                    })
                });
                showToast('Prompt criado!', 'success');
                showPrompts();
            } catch (e) {}
        }

        async function duplicarPrompt(promptId) {
            const novoNome = prompt('Nome do novo prompt');
            if (!novoNome) return;
            try {
                const formData = new FormData();
                formData.append('novo_nome', novoNome);
                await apiForm(`/prompts/${promptId}/duplicar`, formData);
                showToast('Prompt duplicado!', 'success');
                showPrompts();
            } catch (e) {}
        }

        async function definirPromptPadrao(promptId) {
            try {
                const formData = new FormData();
                await apiForm(`/prompts/${promptId}/definir-padrao`, formData);
                showToast('Prompt definido como padrão', 'success');
            } catch (e) {}
        }

        function openPromptPreview(promptId) {
            document.getElementById('input-prompt-id').value = promptId;
            document.getElementById('output-prompt-preview-sistema').value = '';
            document.getElementById('output-prompt-preview').value = '';
            openModal('modal-prompt-preview');
        }

        async function renderPrompt() {
            const promptId = document.getElementById('input-prompt-id').value;
            const variaveisRaw = document.getElementById('input-prompt-variaveis').value.trim();
            let variaveis = {};
            if (variaveisRaw) {
                try {
                    variaveis = JSON.parse(variaveisRaw);
                } catch (e) {
                    showToast('JSON inválido', 'error');
                    return;
                }
            }
            try {
                const data = await api('/prompts/render', {
                    method: 'POST',
                    body: JSON.stringify({ prompt_id: promptId, variaveis })
                });
                document.getElementById('output-prompt-preview-sistema').value = data.texto_sistema_renderizado || '';
                document.getElementById('output-prompt-preview').value = data.texto_renderizado || '';
            } catch (e) {}
        }
        
        async function uploadDocumento() {
            const tipo = document.getElementById('input-upload-tipo').value;
            const atividadeId = document.getElementById('input-upload-atividade-id').value;
            const fileInput = document.getElementById('input-upload-file');
            const alunoId = document.getElementById('input-upload-aluno').value;
            const replaceId = document.getElementById('input-upload-documento-id').value;
            if (!fileInput.files.length) { showToast('Selecione ao menos um arquivo', 'error'); return; }
            const isBase = (window._documentosBase || []).includes(tipo);
            if (!isBase && !alunoId) { showToast('Selecione o aluno', 'error'); return; }
            try {
                const files = Array.from(fileInput.files);
                if (replaceId && files.length > 1) {
                    showToast('Para substituir, selecione apenas um arquivo.', 'warning');
                    return;
                }
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('tipo', tipo);
                    formData.append('atividade_id', atividadeId);
                    if (!isBase && alunoId) formData.append('aluno_id', alunoId);
                    await apiForm('/documentos/upload', formData);
                }
                if (replaceId) {
                    await api(`/documentos/${replaceId}`, { method: 'DELETE' });
                }
                showToast('Documento(s) enviado(s)!', 'success');
                closeModal('modal-upload');
                fileInput.value = '';
                document.getElementById('upload-file-name').textContent = '';
                resetUploadReplace();
                refreshCurrentView();
            } catch (e) {}
        }

        async function importarAlunosCsv() {
            const fileInput = document.getElementById('input-importar-csv');
            const turmaId = document.getElementById('input-importar-turma-id').value;
            if (!fileInput.files.length) { showToast('Selecione um arquivo CSV', 'error'); return; }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (turmaId) formData.append('turma_id', turmaId);
            try {
                const result = await apiForm('/alunos/importar-csv', formData);
                showToast(`Importados: ${result.criados || 0}`, 'success');
                closeModal('modal-importar-csv');
                if (turmaId) showTurma(turmaId); else showAlunos();
            } catch (e) {}
        }

        async function exportarAlunosCsv(turmaId) {
            try {
                const data = await api(`/exportar/alunos-csv${turmaId ? `?turma_id=${turmaId}` : ''}`);
                const blob = new Blob([data.csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'alunos.csv';
                link.click();
                URL.revokeObjectURL(url);
            } catch (e) {}
        }

        async function uploadProvasEmLote() {
            const filesInput = document.getElementById('input-upload-provas-files');
            const atividadeId = document.getElementById('input-upload-provas-atividade-id').value;
            const modo = document.getElementById('input-upload-provas-modo').value;
            if (!filesInput.files.length) { showToast('Selecione arquivos', 'error'); return; }
            const formData = new FormData();
            Array.from(filesInput.files).forEach(file => formData.append('files', file));
            formData.append('atividade_id', atividadeId);
            formData.append('modo_nome', modo);
            try {
                const result = await apiForm('/documentos/upload-provas-alunos', formData);
                showToast(`Enviados: ${result.salvos || 0}`, 'success');
                closeModal('modal-upload-provas');
                showAtividade(atividadeId);
            } catch (e) {}
        }

        function onPipelineModoChange() {
            const modo = document.querySelector('input[name="pipeline-modo"]:checked').value;
            document.getElementById('pipeline-aluno-container').style.display = modo === 'aluno' ? 'block' : 'none';
            document.getElementById('pipeline-turma-info').style.display = modo === 'turma' ? 'block' : 'none';
            document.getElementById('btn-executar-pipeline').textContent = modo === 'turma' ? 'Executar para Turma Toda' : 'Executar Pipeline';
        }

        async function executarPipelineCompleto() {
            const atividadeId = document.getElementById('input-pipeline-atividade-id').value;
            const modo = document.querySelector('input[name="pipeline-modo"]:checked').value;
            const defaultModelId = document.getElementById('input-pipeline-provider-default').value;
            const forceRerun = document.getElementById('input-pipeline-force-rerun').checked;

            // Coletar etapas selecionadas
            const selectedSteps = [];
            document.querySelectorAll('.pipeline-step-checkbox:checked').forEach(cb => {
                selectedSteps.push(cb.dataset.step);
            });

            if (selectedSteps.length === 0) {
                showToast('Selecione pelo menos uma etapa para executar', 'error');
                return;
            }

            const modelsPerStage = {};
            document.querySelectorAll('#pipeline-provider-stages select[data-etapa]').forEach(select => {
                if (select.value && select.value !== defaultModelId) {
                    modelsPerStage[select.dataset.etapa] = select.value;
                }
            });

            // Renomear providers para manter compatibilidade com backend
            const providers = modelsPerStage;
            const btn = document.getElementById('btn-executar-pipeline');

            // Validações
            if (modo === 'aluno') {
                const alunoId = document.getElementById('input-pipeline-aluno').value;
                if (!atividadeId || !alunoId) {
                    showToast('Selecione o aluno para executar o pipeline', 'error');
                    return;
                }
                // Verificar se já está executando
                if (taskQueue.isRunning('pipeline', atividadeId, alunoId)) {
                    showToast('Já existe um pipeline em execução para este aluno', 'warning');
                    return;
                }
            } else {
                if (taskQueue.isRunning('pipeline-turma', atividadeId)) {
                    showToast('Já existe um pipeline de turma em execução', 'warning');
                    return;
                }
            }

            // Fechar modal imediatamente e iniciar tarefa em background
            closeModal('modal-pipeline-completo');

            const taskType = modo === 'turma' ? 'pipeline-turma' : 'pipeline';
            const stepsInfo = selectedSteps.length < 6 ? ` (${selectedSteps.length} etapas)` : '';
            const description = modo === 'turma' ? `Pipeline Turma Toda${stepsInfo}` : `Pipeline Aluno${stepsInfo}`;
            const alunoIdForTask = modo === 'aluno' ? document.getElementById('input-pipeline-aluno').value : null;

            const task = taskQueue.addTask(taskType, description, atividadeId, alunoIdForTask);
            showToast('🚀 Pipeline iniciado! Acompanhe no painel de tarefas.', 'success');

            // Abrir painel de tarefas
            document.getElementById('task-panel').classList.add('show');

            try {
                let result;
                if (modo === 'turma') {
                    const formData = new FormData();
                    formData.append('atividade_id', atividadeId);
                    formData.append('apenas_com_prova', 'true');
                    if (defaultModelId) formData.append('model_id', defaultModelId);
                    if (Object.keys(modelsPerStage).length) formData.append('providers', JSON.stringify(modelsPerStage));
                    formData.append('selected_steps', JSON.stringify(selectedSteps));
                    formData.append('force_rerun', forceRerun ? 'true' : 'false');

                    result = await apiForm('/executar/pipeline-turma', formData);
                } else {
                    const alunoId = document.getElementById('input-pipeline-aluno').value;
                    const formData = new FormData();
                    formData.append('atividade_id', atividadeId);
                    formData.append('aluno_id', alunoId);
                    if (defaultModelId) formData.append('model_id', defaultModelId);
                    if (Object.keys(modelsPerStage).length) formData.append('providers', JSON.stringify(modelsPerStage));
                    formData.append('selected_steps', JSON.stringify(selectedSteps));
                    formData.append('force_rerun', forceRerun ? 'true' : 'false');

                    result = await apiForm('/executar/pipeline-completo', formData);
                }

                taskQueue.completeTask(task.id, result);
            } catch (e) {
                taskQueue.failTask(task.id, e.message || 'Erro ao executar pipeline');
            }
        }

        async function executarEtapa(preview = false) {
            const etapa = document.getElementById('input-execucao-etapa').value;
            const atividadeId = document.getElementById('input-execucao-atividade-id').value;
            const alunoId = document.getElementById('input-execucao-aluno').value || null;
            const modelId = document.getElementById('input-execucao-model').value || null;
            const promptId = document.getElementById('input-execucao-prompt').value || null;
            const editandoPrompt = document.getElementById('input-execucao-editar-prompt').checked;
            const promptTexto = editandoPrompt ? document.getElementById('input-execucao-prompt-texto').value : null;

            if (!etapa || !atividadeId) { showToast('Selecione a etapa', 'error'); return; }

            // Chat Geral: redireciona para a página de chat com a atividade pré-selecionada
            if (etapa === 'chat_geral') {
                closeModal('modal-execucao');
                showChatGeral(atividadeId, alunoId);
                return;
            }

            // Verificar se etapa precisa de aluno
            if (!ETAPAS_SEM_ALUNO.includes(etapa) && !alunoId) {
                showToast('Esta etapa requer um aluno selecionado', 'error');
                return;
            }

            // Para preview, executar diretamente (é rápido)
            if (preview) {
                try {
                    const payload = {
                        etapa,
                        atividade_id: atividadeId,
                        aluno_id: alunoId,
                        model_id: modelId,
                        prompt_id: promptId
                    };
                    if (editandoPrompt && promptTexto) {
                        payload.prompt_customizado = promptTexto;
                    }
                    const result = await api('/executar/etapa-preview', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showToast('Preview gerado', 'success');
                    closeModal('modal-execucao');
                    if (result?.resultado) {
                        showResultado('preview-' + etapa, atividadeId, alunoId, result.resultado, null);
                    }
                } catch (e) {
                    showToast(e.message || 'Erro ao gerar preview', 'error');
                }
                return;
            }

            // Verificar se já está executando esta etapa
            const taskKey = `etapa-${etapa}`;
            if (taskQueue.isRunning(taskKey, atividadeId, alunoId)) {
                showToast('Esta etapa já está em execução', 'warning');
                return;
            }

            // Fechar modal e executar em background
            closeModal('modal-execucao');

            const etapaLabel = window._etapasData?.find(e => e.id === etapa)?.nome || etapa;
            const task = taskQueue.addTask(taskKey, `Etapa: ${etapaLabel}`, atividadeId, alunoId);
            showToast(`🔄 Executando "${etapaLabel}"... Acompanhe no painel de tarefas.`, 'success');

            // Abrir painel de tarefas
            document.getElementById('task-panel').classList.add('show');

            try {
                const payload = {
                    etapa,
                    atividade_id: atividadeId,
                    aluno_id: alunoId,
                    model_id: modelId,
                    prompt_id: promptId
                };
                if (editandoPrompt && promptTexto) {
                    payload.prompt_customizado = promptTexto;
                }

                const result = await api('/executar/etapa', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                taskQueue.completeTask(task.id, result?.resultado || result);
            } catch (e) {
                console.error('Erro ao executar etapa:', e);
                taskQueue.failTask(task.id, e.message || 'Erro ao executar etapa');
            }
        }

        async function showStatusProcessamento(atividadeId) {
            const alunoId = prompt('ID do aluno (opcional)', '');
            const query = alunoId ? `?aluno_id=${alunoId}` : '';
            try {
                const data = await api(`/processamento/status/${atividadeId}${query}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Status de Processamento</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }

        async function showRanking(atividadeId) {
            try {
                const data = await api(`/resultados/${atividadeId}/ranking`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Ranking</h1></div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>Posição</th><th>Aluno</th><th>Nota</th><th>Percentual</th></tr>
                                </thead>
                                <tbody>
                                    ${data.ranking.map(r => `
                                        <tr>
                                            <td>${r.posicao}</td>
                                            <td>${r.aluno_nome}</td>
                                            <td>${r.nota ?? '-'}/${r.nota_maxima ?? '-'}</td>
                                            <td>${r.percentual ?? '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (e) {}
        }

        async function showEstatisticasAtividade(atividadeId) {
            try {
                const data = await api(`/resultados/${atividadeId}/estatisticas`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Estatísticas da Atividade</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }

        async function showResultadoAluno(atividadeId, alunoId) {
            try {
                currentView = 'resultado_aluno';
                currentAtividade = atividadeId;
                currentAluno = alunoId;
                const [resultadoResp, documentosResp] = await Promise.allSettled([
                    api(`/resultados/${atividadeId}/${alunoId}`),
                    api(`/documentos?atividade_id=${atividadeId}&aluno_id=${alunoId}`)
                ]);
                
                // Nova lógica: endpoint agora retorna resultados parciais em vez de 404
                const resultadoData = resultadoResp.status === 'fulfilled' ? resultadoResp.value : null;
                const isComplete = resultadoData?.completo === true;
                const resultado = isComplete ? (resultadoData.resultado || {}) : {};
                const documentos = documentosResp.status === 'fulfilled' ? (documentosResp.value.documentos || []) : [];
                
                // Renderizar status do pipeline se não está completo
                let pipelineStatus = '';
                if (resultadoData && !isComplete) {
                    const progresso = resultadoData.progresso || 0;
                    const etapas = resultadoData.etapas || {};
                    const dadosParciais = resultadoData.dados_parciais || {};
                    
                    pipelineStatus = `
                        <div class="card" style="border-left: 4px solid var(--warning);">
                            <div class="card-header">
                                <h3 class="card-title">⏳ Pipeline em Progresso</h3>
                                <span style="font-size: 14px; color: var(--text-secondary);">${progresso}% concluído</span>
                            </div>
                            <div style="background: var(--bg); border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                                <div style="background: var(--primary); height: 100%; width: ${progresso}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                                ${Object.entries(etapas).map(([key, etapa]) => `
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg); border-radius: 6px;">
                                        <span style="font-size: 16px;">${etapa.completa ? '✅' : '⏳'}</span>
                                        <span style="font-size: 13px; ${etapa.completa ? '' : 'color: var(--text-secondary);'}">${etapa.nome}</span>
                                        ${etapa.doc_id ? `<button class="btn btn-sm" onclick="visualizarDocumento('${etapa.doc_id}')" style="margin-left: auto; padding: 2px 6px;">👁️</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ${Object.keys(dadosParciais).length > 0 ? `
                                <details style="margin-top: 16px;">
                                    <summary style="cursor: pointer; font-weight: 500;">📊 Dados Parciais Disponíveis</summary>
                                    <pre style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 12px; overflow: auto; max-height: 300px;">${escapeHtml(JSON.stringify(dadosParciais, null, 2))}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else if (!resultadoData) {
                    pipelineStatus = '<div class="alert alert-warning"><span class="alert-icon">⚠️</span><div class="alert-content"><div class="alert-title">Resultado indisponível</div><div class="alert-text">Ainda não há correção para este aluno. Inicie o pipeline.</div></div></div>';
                }
                
                const docsPorTipo = groupDocumentosPorTipo(documentos);
                const labels = {
                    enunciado: '📄 Enunciado',
                    gabarito: '✅ Gabarito',
                    criterios_correcao: '📋 Critérios de Correção',
                    prova_respondida: '📝 Prova Respondida',
                    correcao_professor: '🧑‍🏫 Correção do Professor',
                    extracao_questoes: '🔎 Extração de Questões da Atividade',
                    extracao_gabarito: '🧩 Extração de Gabarito',
                    extracao_respostas: '📝 Extração de Respostas do Aluno',
                    correcao: '✅ Correção da IA',
                    analise_habilidades: '📊 Análise de Habilidades',
                    relatorio_final: '📄 Relatório Final'
                };
                const tiposAluno = window._documentosAluno || ['prova_respondida', 'correcao_professor'];
                const tiposGerados = window._documentosGerados || [
                    'extracao_questoes',
                    'extracao_gabarito',
                    'extracao_respostas',
                    'correcao',
                    'analise_habilidades',
                    'relatorio_final'
                ];
                const gruposAluno = tiposAluno.map(tipo => renderDocumentoGrupo({
                    titulo: labels[tipo] || tipo,
                    tipo,
                    atividadeId,
                    alunoId,
                    docs: docsPorTipo[tipo] || [],
                    icon: tipo === 'correcao_professor' ? '🧑‍🏫' : '👤',
                    onAdicionar: `openModalUploadAlunoTipo('${atividadeId}', '${alunoId}', '${tipo}')`,
                    showVisualizar: true
                })).join('');
                const gruposGerados = tiposGerados.map(tipo => renderDocumentoGrupo({
                    titulo: labels[tipo] || tipo,
                    tipo,
                    atividadeId,
                    alunoId,
                    docs: docsPorTipo[tipo] || [],
                    icon: '🤖',
                    onAdicionar: '',
                    showVisualizar: true
                })).join('');
                
                // Só mostrar resultado final se completo
                const resultadoFinal = isComplete ? `
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <h3 class="card-title" style="margin: 0;">📊 Resultado Final</h3>
                            ${renderViewToggle('resultado')}
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <a class="btn" href="${API}/resultados/${atividadeId}/${alunoId}/exportar/json" target="_blank">⬇️ Exportar JSON</a>
                            <a class="btn" href="${API}/resultados/${atividadeId}/${alunoId}/exportar/markdown" target="_blank">📄 Exportar Markdown</a>
                        </div>
                        <div id="resultado-visual" style="display: ${viewPreference === 'visual' ? 'block' : 'none'};">
                            ${renderResultadoVisual(resultado)}
                        </div>
                        <div id="resultado-json" style="display: ${viewPreference === 'json' ? 'block' : 'none'};">
                            <pre style="background: var(--bg); padding: 16px; border-radius: 8px; overflow:auto; max-height: 500px;">${escapeHtml(JSON.stringify(resultado, null, 2))}</pre>
                        </div>
                    </div>
                ` : '';
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Resultado do Aluno</h1></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="openModalExecucao('${atividadeId}')">⚙️ Executar Etapa</button>
                        <button class="btn btn-primary" onclick="openModalPipelineCompleto('${atividadeId}', 'aluno')">⚡ Pipeline Aluno</button>
                        <button class="btn" onclick="showAtividade('${atividadeId}')">← Voltar para Atividade</button>
                    </div>
                    ${pipelineStatus}
                    ${resultadoFinal}
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">📌 Documentos do Aluno</h3></div>
                        ${gruposAluno || '<div class="empty-state"><div class="empty-icon">📄</div><div class="empty-title">Nenhum documento do aluno</div></div>'}
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">🤖 Comparativo das Etapas (IA)</h3></div>
                        ${gruposGerados || '<div class="empty-state"><div class="empty-icon">🤖</div><div class="empty-title">Nenhuma etapa gerada</div></div>'}
                    </div>
                `;
            } catch (e) {
                console.error('Erro ao carregar resultado:', e);
            }
        }

        async function showDashboardTurma(turmaId) {
            try {
                const data = await api(`/dashboard/turma/${turmaId}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Dashboard da Turma</h1></div>
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <h3 class="card-title" style="margin: 0;">📊 Estatísticas da Turma</h3>
                            ${renderViewToggle('dash-turma')}
                        </div>
                        <div id="dash-turma-visual" style="display: ${viewPreference === 'visual' ? 'block' : 'none'};">
                            ${renderDashboardVisual(data, 'turma')}
                        </div>
                        <div id="dash-turma-json" style="display: ${viewPreference === 'json' ? 'block' : 'none'};">
                            <pre style="background: var(--bg); padding: 16px; border-radius: 8px; overflow:auto; max-height: 500px;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                        </div>
                    </div>
                `;
            } catch (e) {}
        }

        async function showDashboardAluno(alunoId) {
            try {
                const data = await api(`/dashboard/aluno/${alunoId}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Dashboard do Aluno</h1></div>
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <h3 class="card-title" style="margin: 0;">📊 Estatísticas do Aluno</h3>
                            ${renderViewToggle('dash-aluno')}
                        </div>
                        <div id="dash-aluno-visual" style="display: ${viewPreference === 'visual' ? 'block' : 'none'};">
                            ${renderDashboardVisual(data, 'aluno')}
                        </div>
                        <div id="dash-aluno-json" style="display: ${viewPreference === 'json' ? 'block' : 'none'};">
                            <pre style="background: var(--bg); padding: 16px; border-radius: 8px; overflow:auto; max-height: 500px;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                        </div>
                    </div>
                `;
            } catch (e) {}
        }
        
        // ============================================================
        // UPLOAD ZONE
        // ============================================================
        function setupUploadZone() {
            const zone = document.getElementById('upload-zone-modal');
            const input = document.getElementById('input-upload-file');
            const fileName = document.getElementById('upload-file-name');
            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    const names = Array.from(e.dataTransfer.files).map(file => file.name);
                    fileName.textContent = `📎 ${names.join(', ')}`;
                }
            });
            input.addEventListener('change', () => {
                if (input.files.length) {
                    const names = Array.from(input.files).map(file => file.name);
                    fileName.textContent = `📎 ${names.join(', ')}`;
                }
            });
            document.getElementById('input-upload-tipo').addEventListener('change', (e) => {
                const isBase = (window._documentosBase || []).includes(e.target.value);
                document.getElementById('grupo-aluno-upload').style.display = isBase ? 'none' : 'block';
                resetUploadReplace();
            });
            document.getElementById('input-upload-aluno').addEventListener('change', () => {
                resetUploadReplace();
            });
        }
        
        // ============================================================
        // BUSCA
        // ============================================================
        function setupBusca() {
            const input = document.getElementById('input-busca');
            let timeout;
            input.addEventListener('input', () => { clearTimeout(timeout); timeout = setTimeout(() => buscar(input.value), 300); });
        }
        
        async function buscar(termo) {
            const container = document.getElementById('resultados-busca');
            if (termo.length < 2) { container.innerHTML = '<div style="color: var(--text-muted); padding: 20px; text-align: center;">Digite pelo menos 2 caracteres</div>'; return; }
            try {
                const data = await api(`/busca?q=${encodeURIComponent(termo)}`);
                if (data.total === 0) { container.innerHTML = '<div style="color: var(--text-muted); padding: 20px; text-align: center;">Nenhum resultado</div>'; return; }
                let html = '';
                if (data.resultados.alunos.length > 0) { html += '<div style="margin-bottom: 12px;"><strong>Alunos</strong></div>' + data.resultados.alunos.map(a => `<div class="doc-item" onclick="closeModal('modal-busca'); showAluno('${a.id}')"><div class="doc-icon">👤</div><div class="doc-info"><div class="doc-name">${a.nome}</div><div class="doc-meta">${a.matricula || ''}</div></div></div>`).join(''); }
                if (data.resultados.materias.length > 0) { html += '<div style="margin: 12px 0;"><strong>Matérias</strong></div>' + data.resultados.materias.map(m => `<div class="doc-item" onclick="closeModal('modal-busca'); showMateria('${m.id}')"><div class="doc-icon">📚</div><div class="doc-info"><div class="doc-name">${m.nome}</div></div></div>`).join(''); }
                if (data.resultados.turmas.length > 0) { html += '<div style="margin: 12px 0;"><strong>Turmas</strong></div>' + data.resultados.turmas.map(t => `<div class="doc-item" onclick="closeModal('modal-busca'); showTurma('${t.id}')"><div class="doc-icon">👥</div><div class="doc-info"><div class="doc-name">${t.nome}</div><div class="doc-meta">${t.materia || ''}</div></div></div>`).join(''); }
                if (data.resultados.atividades.length > 0) { html += '<div style="margin: 12px 0;"><strong>Atividades</strong></div>' + data.resultados.atividades.map(a => `<div class="doc-item" onclick="closeModal('modal-busca'); showAtividade('${a.id}')"><div class="doc-icon">📝</div><div class="doc-info"><div class="doc-name">${a.nome}</div><div class="doc-meta">${a.turma || ''}</div></div></div>`).join(''); }
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<div style="color: var(--danger); padding: 20px;">Erro na busca</div>'; }
        }

        async function loadTiposDocumentos() {
            try {
                const data = await api('/tipos/documentos');
                const select = document.getElementById('input-upload-tipo');
                if (!select) return;
                window._documentosBase = data.tipos?.base || [];
                window._documentosAluno = data.tipos?.aluno || [];
                window._documentosGerados = data.tipos?.gerados || [];
                const labels = {
                    enunciado: '📄 Enunciado da Prova',
                    gabarito: '✅ Gabarito',
                    criterios_correcao: '📋 Critérios de Correção',
                    prova_respondida: '👤 Prova do Aluno',
                    correcao_professor: '🧑‍🏫 Correção do Professor',
                    extracao_questoes: '🔎 Extração de Questões',
                    extracao_gabarito: '🧩 Extração de Gabarito',
                    extracao_respostas: '📝 Extração de Respostas',
                    correcao: '✅ Correção',
                    analise_habilidades: '📊 Análise de Habilidades',
                    relatorio_final: '📄 Relatório Final'
                };
                select.innerHTML = data.todos.map(tipo => `<option value="${tipo}">${labels[tipo] || tipo}</option>`).join('');
            } catch (e) {}
        }

        async function loadNiveisEnsino() {
            try {
                const data = await api('/tipos/niveis');
                const select = document.getElementById('input-materia-nivel');
                if (!select) return;
                select.innerHTML = data.niveis.map(n => `<option value="${n}">${n.replace('_', ' ').toUpperCase()}</option>`).join('');
            } catch (e) {}
        }
        
        // ============================================================
        // TOAST
        // ============================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength - 1)}…`;
        }



        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }





        
        // ============================================================
        // SETTINGS - API KEYS E MODELOS
        // ============================================================
        let _modelosSugeridos = {};

        function showSettingsTab(tab) {
            const tabNames = ['api-keys', 'models', 'catalog', 'custom', 'local'];
            document.querySelectorAll('#modal-settings .tab').forEach((t, i) => {
                t.classList.toggle('active', tabNames[i] === tab);
            });
            tabNames.forEach(name => {
                const el = document.getElementById(`settings-tab-${name}`);
                if (el) el.style.display = name === tab ? 'block' : 'none';
            });
            if (tab === 'api-keys') carregarApiKeys();
            if (tab === 'models') carregarModelos();
            if (tab === 'catalog') carregarCatalogo();
            if (tab === 'local') detectAllLocalModels();
        }

        // ============================================================
        // CATALOG - CATÁLOGO DE MODELOS
        // ============================================================
        let _catalogData = null;
        let _catalogViewMode = 'cards';
        let _selectedForCompare = [];

        async function carregarCatalogo() {
            if (_catalogData) {
                renderCatalog();
                return;
            }
            try {
                _catalogData = await api('/settings/model-catalog');
                populateProviderFilter();
                renderCatalog();
            } catch (e) {
                document.getElementById('catalog-grid').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">⚠️</div><div class="empty-title">Erro ao carregar catálogo</div></div>';
            }
        }

        function populateProviderFilter() {
            if (!_catalogData || !_catalogData.providers) return;
            const select = document.getElementById('filter-provider');
            select.innerHTML = '<option value="">Todos Provedores</option>';
            for (const [key, prov] of Object.entries(_catalogData.providers)) {
                select.innerHTML += `<option value="${key}">${prov.name}</option>`;
            }
        }

        function setCatalogView(mode) {
            _catalogViewMode = mode;
            document.querySelectorAll('.view-mode-btn').forEach(btn =>
                btn.classList.toggle('active', btn.dataset.mode === mode)
            );
            document.getElementById('catalog-content').style.display = mode === 'compare' ? 'none' : 'block';
            document.getElementById('compare-content').style.display = mode === 'compare' ? 'block' : 'none';
            renderCatalog();
        }

        function filterCatalog() {
            renderCatalog();
        }

        function renderCatalog() {
            if (!_catalogData) return;
            const providerFilter = document.getElementById('filter-provider').value;
            const capFilter = document.getElementById('filter-capability').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            switch (_catalogViewMode) {
                case 'cards': renderCatalogCards(providerFilter, capFilter, searchFilter); break;
                case 'table': renderCatalogTable(providerFilter, capFilter, searchFilter); break;
                case 'compare': renderCatalogCompare(); break;
                case 'minimal': renderCatalogMinimal(providerFilter, capFilter, searchFilter); break;
            }
        }

        function getFilteredModels(providerFilter, capFilter, searchFilter) {
            const models = [];
            for (const [key, prov] of Object.entries(_catalogData.providers)) {
                if (providerFilter && key !== providerFilter) continue;
                for (const m of prov.models || []) {
                    if (capFilter) {
                        const capKey = `supports_${capFilter}`;
                        if (!m[capKey]) continue;
                    }
                    if (searchFilter) {
                        const searchIn = `${m.display_name} ${m.id} ${m.description || ''}`.toLowerCase();
                        if (!searchIn.includes(searchFilter)) continue;
                    }
                    models.push({ ...m, provider: key, providerName: prov.name });
                }
            }
            return models;
        }

        function renderCatalogCards(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = models.map(m => `
                <div class="model-card">
                    <div class="model-card-header">
                        <span class="provider-badge provider-${m.provider}">${m.providerName}</span>
                        <span class="model-card-name">${escapeHtml(m.display_name)}</span>
                    </div>
                    <div class="model-card-desc">${escapeHtml(m.description || '')}</div>
                    <div class="model-stats">
                        <div class="stat">
                            <span class="stat-label">Contexto</span>
                            <span class="stat-value">${formatContext(m.context_window)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Input</span>
                            <span class="stat-value">$${m.input_cost?.toFixed(2) || '0'}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Output</span>
                            <span class="stat-value">$${m.output_cost?.toFixed(2) || '0'}</span>
                        </div>
                    </div>
                    <div class="capability-badges">
                        ${m.supports_vision ? '<span class="badge-vision">👁️ Vision</span>' : ''}
                        ${m.supports_tools ? '<span class="badge-tools">🔧 Tools</span>' : ''}
                        ${m.supports_reasoning ? '<span class="badge-reasoning">🧠 Reasoning</span>' : ''}
                        ${m.supports_search ? '<span class="badge-search">🔍 Search</span>' : ''}
                        ${m.supports_json_mode ? '<span class="badge-json">📋 JSON</span>' : ''}
                    </div>
                    <div class="model-card-footer">
                        <button class="btn btn-sm btn-primary" onclick="addFromCatalog('${m.provider}', '${m.id}')">+ Adicionar</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCatalogTable(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = `
                <table class="catalog-table">
                    <thead>
                        <tr>
                            <th>Modelo</th>
                            <th>Contexto</th>
                            <th>Input</th>
                            <th>Output</th>
                            <th>👁️</th>
                            <th>🔧</th>
                            <th>🧠</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${models.map(m => `
                            <tr>
                                <td>
                                    <span class="provider-badge provider-${m.provider}" style="margin-right: 6px;">${m.providerName}</span>
                                    ${escapeHtml(m.display_name)}
                                </td>
                                <td>${formatContext(m.context_window)}</td>
                                <td>$${m.input_cost?.toFixed(2) || '0'}</td>
                                <td>$${m.output_cost?.toFixed(2) || '0'}</td>
                                <td class="${m.supports_vision ? 'check' : 'cross'}">${m.supports_vision ? '✓' : '−'}</td>
                                <td class="${m.supports_tools ? 'check' : 'cross'}">${m.supports_tools ? '✓' : '−'}</td>
                                <td class="${m.supports_reasoning ? 'check' : 'cross'}">${m.supports_reasoning ? '✓' : '−'}</td>
                                <td><button class="btn btn-xs btn-primary" onclick="addFromCatalog('${m.provider}', '${m.id}')">+</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderCatalogMinimal(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = `<div class="minimal-list">${models.map(m => `
                <div class="minimal-item" onclick="addFromCatalog('${m.provider}', '${m.id}')">
                    <span class="provider-dot" style="background: var(--${getProviderColor(m.provider)});"></span>
                    <span class="model-name" style="flex:1">${escapeHtml(m.display_name)}</span>
                    <span class="context-badge">${formatContext(m.context_window)}</span>
                </div>
            `).join('')}</div>`;
        }

        function renderCatalogCompare() {
            const allModels = getFilteredModels('', '', '');
            const chipsContainer = document.getElementById('compare-chips');
            chipsContainer.innerHTML = allModels.map(m => {
                const ref = `${m.provider}/${m.id}`;
                const isSelected = _selectedForCompare.some(s => s.ref === ref);
                return `<span class="compare-chip ${isSelected ? 'selected' : ''}"
                             onclick="toggleCompareModel('${m.provider}', '${m.id}', '${escapeHtml(m.display_name)}', ${m.input_cost || 0}, ${m.output_cost || 0})">
                    ${escapeHtml(m.display_name)}
                </span>`;
            }).join('');

            const grid = document.getElementById('compare-grid');
            if (_selectedForCompare.length === 0) {
                grid.innerHTML = '<div class="empty-hint">Selecione modelos acima para comparar</div>';
                document.getElementById('cost-results').innerHTML = '';
                return;
            }

            grid.innerHTML = _selectedForCompare.map(m => `
                <div class="model-card">
                    <div class="model-card-header">
                        <span class="model-card-name">${m.name}</span>
                    </div>
                    <div class="model-stats">
                        <div class="stat">
                            <span class="stat-label">Input</span>
                            <span class="stat-value">$${m.inputCost.toFixed(2)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Output</span>
                            <span class="stat-value">$${m.outputCost.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            calculateCosts();
        }

        function toggleCompareModel(provider, modelId, name, inputCost, outputCost) {
            const ref = `${provider}/${modelId}`;
            const idx = _selectedForCompare.findIndex(s => s.ref === ref);
            if (idx >= 0) {
                _selectedForCompare.splice(idx, 1);
            } else if (_selectedForCompare.length < 4) {
                _selectedForCompare.push({ ref, name, inputCost, outputCost });
            } else {
                showToast('Máximo 4 modelos para comparação', 'warning');
                return;
            }
            renderCatalogCompare();
        }

        function calculateCosts() {
            const inputTokens = parseInt(document.getElementById('calc-input-tokens').value) || 1000;
            const outputTokens = parseInt(document.getElementById('calc-output-tokens').value) || 500;
            const requests = parseInt(document.getElementById('calc-requests').value) || 100;

            const results = _selectedForCompare.map(m => {
                const costPerReq = (inputTokens * m.inputCost / 1000000) + (outputTokens * m.outputCost / 1000000);
                return {
                    name: m.name,
                    daily: costPerReq * requests,
                    monthly: costPerReq * requests * 30
                };
            });

            const container = document.getElementById('cost-results');
            if (results.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = results.map(r => `
                <div class="cost-card">
                    <div class="cost-card-title">${escapeHtml(r.name)}</div>
                    <div class="cost-card-value">$${r.monthly.toFixed(2)}/mês</div>
                    <div class="cost-card-sub">$${r.daily.toFixed(4)}/dia</div>
                </div>
            `).join('');
        }

        function formatContext(tokens) {
            if (!tokens) return '−';
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K';
            return tokens.toString();
        }

        function getProviderColor(provider) {
            const colors = {
                openai: 'success', anthropic: 'warning', google: 'primary',
                deepseek: 'primary', mistral: 'warning', xai: 'text',
                perplexity: 'success', cohere: 'danger', groq: 'danger',
                openrouter: 'purple', ollama: 'text', vllm: 'purple', lmstudio: 'success'
            };
            return colors[provider] || 'text';
        }

        async function addFromCatalog(provider, modelId) {
            try {
                // Buscar info completa do modelo
                const info = await api(`/settings/model-catalog/${provider}/${modelId}`);
                const model = info.model;

                // Reset modal primeiro
                resetModelModal();

                // Preencher o modal com dados do catálogo
                document.getElementById('input-model-nome').value = model.display_name;
                document.getElementById('input-model-tipo').value = provider;

                // Popular dropdown
                onProviderChange();

                // Tentar selecionar no dropdown, senão colocar no campo manual
                const select = document.getElementById('input-model-select');
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === modelId) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    document.getElementById('input-model-manual').value = modelId;
                }

                // Definir capacidades
                document.getElementById('input-model-vision').checked = model.supports_vision || false;
                document.getElementById('input-model-tools').checked = model.supports_tools || false;

                // Verificar se é reasoning
                const isReasoning = model.supports_reasoning || !model.requires_temperature;
                if (isReasoning) {
                    document.getElementById('input-model-is-reasoning').value = 'true';
                    document.getElementById('reasoning-warning').style.display = 'flex';
                    document.getElementById('temp-group').style.display = 'none';
                    document.getElementById('reasoning-group').style.display = 'block';
                } else {
                    document.getElementById('input-model-is-reasoning').value = 'false';
                }

                // Definir max_output se disponível
                if (model.max_output) {
                    document.getElementById('input-model-tokens').value = Math.min(model.max_output, 16384);
                }

                // Abrir modal
                openModal('modal-add-model');
                showToast(`Dados de ${model.display_name} carregados`, 'success');
            } catch (e) {
                console.error('Erro addFromCatalog:', e);
                showToast('Erro ao carregar modelo do catálogo', 'error');
            }
        }

        // ============================================================
        // CUSTOM ENDPOINT
        // ============================================================
        async function salvarCustomEndpoint() {
            const nome = document.getElementById('custom-nome').value;
            const tipo = document.getElementById('custom-compat').value;
            const modelId = document.getElementById('custom-model-id').value;
            const baseUrl = document.getElementById('custom-url').value;
            const apiVersion = document.getElementById('custom-api-version').value || null;
            const headersText = document.getElementById('custom-headers').value;
            const maxTokens = parseInt(document.getElementById('custom-tokens').value) || 4096;
            const temperature = parseFloat(document.getElementById('custom-temp').value) || 0.7;

            if (!nome || !modelId || !baseUrl) {
                showToast('Preencha os campos obrigatórios', 'error');
                return;
            }

            let extraHeaders = null;
            if (headersText) {
                try {
                    extraHeaders = JSON.parse(headersText);
                } catch (e) {
                    showToast('JSON de headers inválido', 'error');
                    return;
                }
            }

            try {
                await api('/settings/models/custom', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome,
                        tipo,
                        custom_model_id: modelId,
                        custom_base_url: baseUrl,
                        api_version: apiVersion,
                        extra_headers: extraHeaders,
                        max_tokens: maxTokens,
                        temperature
                    })
                });
                showToast('Endpoint customizado salvo!', 'success');
                // Limpar campos
                document.getElementById('custom-nome').value = '';
                document.getElementById('custom-model-id').value = '';
                document.getElementById('custom-url').value = '';
                document.getElementById('custom-api-version').value = '';
                document.getElementById('custom-headers').value = '';
                showSettingsTab('models');
            } catch (e) {
                showToast('Erro ao salvar endpoint', 'error');
            }
        }

        // ============================================================
        // LOCAL MODELS DETECTION
        // ============================================================
        async function detectAllLocalModels() {
            detectLocalModels('ollama');
            detectLocalModels('vllm');
            detectLocalModels('lmstudio');
        }

        async function detectLocalModels(provider) {
            const statusEl = document.getElementById(`${provider}-status`);
            const listEl = document.getElementById(`${provider}-models`);
            statusEl.textContent = '⏳';
            listEl.innerHTML = '<div class="empty-hint">Verificando...</div>';

            try {
                const data = await api(`/settings/local-models/${provider}`);
                if (data.online) {
                    statusEl.textContent = '🟢';
                    statusEl.title = 'Online';
                    if (data.models && data.models.length > 0) {
                        listEl.innerHTML = data.models.map(m => `
                            <div class="local-model-item">
                                <span class="model-name">${escapeHtml(m.display_name || m.id)}</span>
                                ${m.size ? `<span class="model-size">${formatBytes(m.size)}</span>` : ''}
                                <button class="btn btn-xs btn-primary" onclick="addLocalModel('${provider}', '${m.id}')">+</button>
                            </div>
                        `).join('');
                    } else {
                        listEl.innerHTML = '<div class="empty-hint">Nenhum modelo instalado</div>';
                    }
                } else {
                    statusEl.textContent = '🔴';
                    statusEl.title = 'Offline';
                    listEl.innerHTML = '<div class="empty-hint">Servidor não encontrado</div>';
                }
            } catch (e) {
                statusEl.textContent = '🔴';
                listEl.innerHTML = '<div class="empty-hint">Erro ao conectar</div>';
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb.toFixed(1) + ' GB';
        }

        async function addLocalModel(provider, modelId) {
            try {
                await api('/settings/models', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome: modelId,
                        tipo: provider,
                        modelo: modelId,
                        max_tokens: 4096,
                        temperature: 0.7
                    })
                });
                showToast(`Modelo ${modelId} adicionado!`, 'success');
                showSettingsTab('models');
            } catch (e) {
                showToast('Erro ao adicionar modelo', 'error');
            }
        }

        async function carregarApiKeys() {
            try {
                const data = await api('/settings/api-keys');
                const container = document.getElementById('api-keys-list');
                if (!data.api_keys || data.api_keys.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">🔑</div><div class="empty-title">Nenhuma API key configurada</div></div>';
                    return;
                }
                container.innerHTML = data.api_keys.map(k => `
                    <div class="doc-item" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                        <div class="doc-icon" style="background: var(--bg-hover);">🔑</div>
                        <div class="doc-info" style="flex: 1;">
                            <div class="doc-name">${escapeHtml(k.nome_exibicao || k.empresa)}</div>
                            <div class="doc-meta">${escapeHtml(k.empresa)} • ${k.api_key_preview || '***'}</div>
                        </div>
                        <div class="doc-actions">
                            <button class="btn btn-xs btn-danger" onclick="excluirApiKey('${k.id}')">🗑️</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('api-keys-list').innerHTML = '<div class="alert alert-warning">⚠️ Erro ao carregar API keys. Verifique se o routes_chat.py está instalado.</div>';
            }
        }

        async function salvarApiKey() {
            const empresa = document.getElementById('input-apikey-empresa').value;
            const apiKey = document.getElementById('input-apikey-key').value;
            const nome = document.getElementById('input-apikey-nome').value;
            if (!apiKey) { showToast('API key obrigatória', 'error'); return; }
            try {
                await api('/settings/api-keys', {
                    method: 'POST',
                    body: JSON.stringify({ empresa, api_key: apiKey, nome_exibicao: nome || null })
                });
                showToast('API key salva!', 'success');
                closeModal('modal-add-apikey');
                document.getElementById('input-apikey-key').value = '';
                document.getElementById('input-apikey-nome').value = '';
                carregarApiKeys();
            } catch (e) { /* erro já mostrado */ }
        }

        async function excluirApiKey(id) {
            if (!confirm('Excluir esta API key?')) return;
            try {
                await api(`/settings/api-keys/${id}`, { method: 'DELETE' });
                showToast('API key excluída!', 'success');
                carregarApiKeys();
            } catch (e) { /* erro já mostrado */ }
        }

        async function carregarModelos() {
            try {
                const data = await api('/settings/models');
                const container = document.getElementById('models-list');
                if (!data.models || data.models.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">🤖</div><div class="empty-title">Nenhum modelo configurado</div></div>';
                    return;
                }
                container.innerHTML = data.models.map(m => `
                    <div class="doc-item" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                        <div class="doc-icon" style="background: var(--bg-hover);">🤖</div>
                        <div class="doc-info" style="flex: 1;">
                            <div class="doc-name">${escapeHtml(m.nome)} ${m.is_default ? '<span class="badge badge-primary">Padrão</span>' : ''}</div>
                            <div class="doc-meta">${escapeHtml(m.tipo)} • ${escapeHtml(m.modelo)}</div>
                        </div>
                        <div class="doc-actions" style="display: flex; gap: 6px;">
                            ${!m.is_default ? `<button class="btn btn-xs" onclick="definirModeloPadrao('${m.id}')" title="Definir como padrão">⭐</button>` : ''}
                            <button class="btn btn-xs" onclick="testarModelo('${m.id}')" title="Testar">🧪</button>
                            <button class="btn btn-xs btn-danger" onclick="excluirModelo('${m.id}')" title="Excluir">🗑️</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('models-list').innerHTML = '<div class="alert alert-warning">⚠️ Erro ao carregar modelos. Verifique se o routes_chat.py está instalado.</div>';
            }
        }

        // Modelos de reasoning que não suportam temperatura
        const REASONING_MODELS = ['o1', 'o1-mini', 'o1-pro', 'o3', 'o3-mini', 'o4-mini', 'deepseek-reasoner'];

        async function carregarModelosSugeridosInicial() {
            try {
                const data = await api('/settings/models/sugeridos');
                _modelosSugeridos = data.modelos_por_tipo || {};
            } catch (e) { console.log('Modelos sugeridos não disponíveis'); }
        }

        function onProviderChange() {
            const tipo = document.getElementById('input-model-tipo').value;
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const modelos = _modelosSugeridos[tipo] || [];

            // Limpar campo manual
            manualInput.value = '';

            // Popular dropdown
            if (modelos.length === 0) {
                select.innerHTML = '<option value="">-- Nenhum modelo sugerido, digite abaixo --</option>';
            } else {
                select.innerHTML = '<option value="">-- Selecione ou digite abaixo --</option>' +
                    modelos.map(m => {
                        // Verifica se é reasoning: suporta_temperature deve ser EXPLICITAMENTE false
                        const isReasoning = m.suporta_temperature === false || m.suporta_reasoning === true;
                        const reasoningBadge = isReasoning ? ' [Reasoning]' : '';
                        return `<option value="${m.id}" data-reasoning="${isReasoning}" data-vision="${m.suporta_vision || false}">${escapeHtml(m.nome || m.id)}${reasoningBadge}</option>`;
                    }).join('');
            }

            // Verificar se modelo digitado é reasoning
            checkIfReasoningModel();
        }

        function onModelSelect() {
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const selectedOption = select.options[select.selectedIndex];

            if (select.value) {
                manualInput.value = '';  // Limpa manual se selecionou do dropdown
            }

            // Atualizar checkboxes de capacidades
            if (selectedOption && selectedOption.dataset) {
                const isVision = selectedOption.dataset.vision === 'true';
                document.getElementById('input-model-vision').checked = isVision;
            }

            checkIfReasoningModel();
        }

        function checkIfReasoningModel() {
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const selectedOption = select.options[select.selectedIndex];

            // Determinar qual modelo está selecionado
            const modelId = (manualInput.value.trim() || select.value).toLowerCase();

            // Verificar se é reasoning:
            // 1. Pelo dropdown (já calculado corretamente)
            // 2. Pelo ID manual (verifica se contém nomes de modelos reasoning)
            const isReasoningFromDropdown = selectedOption && selectedOption.dataset && selectedOption.dataset.reasoning === 'true';
            const isReasoningFromManual = modelId && REASONING_MODELS.some(r => modelId.includes(r));
            const isReasoning = isReasoningFromDropdown || isReasoningFromManual;

            // Mostrar/ocultar elementos
            document.getElementById('reasoning-warning').style.display = isReasoning ? 'flex' : 'none';
            document.getElementById('temp-group').style.display = isReasoning ? 'none' : 'block';
            document.getElementById('reasoning-group').style.display = isReasoning ? 'block' : 'none';
            document.getElementById('input-model-is-reasoning').value = isReasoning ? 'true' : 'false';
        }

        // Verificar reasoning quando digita manualmente
        document.addEventListener('DOMContentLoaded', function() {
            const manualInput = document.getElementById('input-model-manual');
            if (manualInput) {
                manualInput.addEventListener('input', checkIfReasoningModel);
            }
        });

        function preencherSystemPromptPadrao() {
            const systemPrompt = `Você é um assistente educacional especializado em correção de provas.

REGRA CRÍTICA PARA GERAÇÃO DE ARQUIVOS:
=========================================
Quando o usuário pedir para criar/gerar qualquer arquivo (Excel, PDF, Word, PowerPoint, imagem, CSV, etc.), você DEVE usar o formato python-exec.

FORMATO OBRIGATÓRIO:
\`\`\`python-exec:nome_arquivo.extensao
# código Python aqui
\`\`\`

NUNCA FAÇA ISSO:
- NÃO diga "copie e cole"
- NÃO diga "salve como"
- NÃO use blocos documento: ou document: ou arquivo:
- NÃO descreva como criar o arquivo - CRIE O ARQUIVO

Bibliotecas disponíveis: pandas, openpyxl, python-docx, reportlab, python-pptx, matplotlib, pillow, numpy

EXEMPLO CORRETO (Excel):
\`\`\`python-exec:notas.xlsx
import pandas as pd
df = pd.DataFrame({'Aluno': ['Ana', 'Bruno'], 'Nota': [9.0, 7.5]})
df.to_excel('notas.xlsx', index=False)
print('Criado!')
\`\`\`

Seja preciso e educativo nas correções.`;
            document.getElementById('input-model-system').value = systemPrompt;
        }

        async function salvarModelo() {
            const nome = document.getElementById('input-model-nome').value.trim();
            const tipo = document.getElementById('input-model-tipo').value;
            const modeloSelect = document.getElementById('input-model-select').value;
            const modeloManual = document.getElementById('input-model-manual').value.trim();
            const modelo = modeloManual || modeloSelect;  // Prioriza manual
            const maxTokens = parseInt(document.getElementById('input-model-tokens').value) || 4096;
            const systemPrompt = document.getElementById('input-model-system').value;
            const isReasoning = document.getElementById('input-model-is-reasoning').value === 'true';

            // Capacidades
            const suportaVision = document.getElementById('input-model-vision').checked;
            const suportaTools = document.getElementById('input-model-tools').checked;
            const suportaStreaming = document.getElementById('input-model-streaming').checked;

            // Validação
            if (!nome) { showToast('Apelido é obrigatório', 'error'); return; }
            if (!modelo) { showToast('Modelo (ID da API) é obrigatório', 'error'); return; }

            // Construir payload
            const payload = {
                nome,
                tipo,
                modelo,
                max_tokens: maxTokens,
                system_prompt: systemPrompt || null,
                suporta_vision: suportaVision,
                suporta_function_calling: suportaTools,
                suporta_streaming: suportaStreaming,
                suporta_temperature: !isReasoning
            };

            // Adicionar temperatura ou reasoning_effort
            if (isReasoning) {
                payload.temperature = null;
                payload.parametros = {
                    reasoning_effort: document.getElementById('input-model-reasoning').value
                };
            } else {
                payload.temperature = parseFloat(document.getElementById('input-model-temp').value) || 0.7;
                payload.parametros = {};
            }

            try {
                await api('/settings/models', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showToast('Modelo salvo!', 'success');
                closeModal('modal-add-model');
                resetModelModal();
                carregarModelos();
            } catch (e) { /* erro já mostrado */ }
        }

        function resetModelModal() {
            document.getElementById('input-model-nome').value = '';
            document.getElementById('input-model-select').selectedIndex = 0;
            document.getElementById('input-model-manual').value = '';
            document.getElementById('input-model-tokens').value = '4096';
            document.getElementById('input-model-temp').value = '0.7';
            document.getElementById('input-model-reasoning').value = 'medium';
            document.getElementById('input-model-system').value = '';
            document.getElementById('input-model-vision').checked = false;
            document.getElementById('input-model-tools').checked = false;
            document.getElementById('input-model-streaming').checked = true;
            document.getElementById('reasoning-warning').style.display = 'none';
            document.getElementById('temp-group').style.display = 'block';
            document.getElementById('reasoning-group').style.display = 'none';
        }

        function openAddModelModal() {
            resetModelModal();
            onProviderChange();  // Popular dropdown inicial
            openModal('modal-add-model');
        }

        async function definirModeloPadrao(id) {
            try {
                await api(`/settings/models/${id}/default`, { method: 'POST' });
                showToast('Modelo definido como padrão!', 'success');
                carregarModelos();
            } catch (e) { /* erro já mostrado */ }
        }

        async function testarModelo(id) {
            showToast('Testando conexão...', 'warning');
            try {
                const result = await api(`/settings/models/${id}/testar`, { method: 'POST' });
                if (result.success) {
                    showToast('✅ Modelo funcionando!', 'success');
                } else {
                    showToast(`❌ Erro: ${result.erro}`, 'error');
                }
            } catch (e) { /* erro já mostrado */ }
        }

        async function excluirModelo(id) {
            if (!confirm('Excluir este modelo?')) return;
            try {
                await api(`/settings/models/${id}`, { method: 'DELETE' });
                showToast('Modelo excluído!', 'success');
                carregarModelos();
            } catch (e) { /* erro já mostrado */ }
        }

        // ============================================================
        // CHAT COM IA
        // ============================================================
        async function abrirChat(atividadeId, alunoId = null, titulo = 'Chat com IA') {
            document.getElementById('chat-atividade-id').value = atividadeId || '';
            document.getElementById('chat-aluno-id').value = alunoId || '';
            document.getElementById('chat-titulo').textContent = '💬 ' + titulo;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';
            
            // Carregar modelos disponíveis
            try {
                const modelsData = await api('/settings/models');
                const select = document.getElementById('chat-model-select');
                if (modelsData.models && modelsData.models.length > 0) {
                    select.innerHTML = modelsData.models.map(m => 
                        `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)}</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="">Nenhum modelo configurado</option>';
                }
            } catch (e) {
                document.getElementById('chat-model-select').innerHTML = '<option value="">Erro ao carregar modelos</option>';
            }
            
            // Criar sessão de chat
            try {
                const sessaoData = await api('/chat/sessoes', {
                    method: 'POST',
                    body: JSON.stringify({
                        titulo: titulo,
                        atividade_id: atividadeId || null,
                        aluno_id: alunoId || null
                    })
                });
                document.getElementById('chat-session-id').value = sessaoData.sessao.id;
            } catch (e) {
                showToast('Erro ao criar sessão de chat', 'error');
            }
            
            openModal('modal-chat');
        }

        async function enviarMensagemChat() {
            const input = document.getElementById('chat-input');
            const mensagem = input.value.trim();
            if (!mensagem) return;
            
            const sessionId = document.getElementById('chat-session-id').value;
            const modelId = document.getElementById('chat-model-select').value;
            const container = document.getElementById('chat-messages');
            
            // Adicionar mensagem do usuário
            container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--primary); color: white; align-self: flex-end;">${escapeHtml(mensagem)}</div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;
            
            // Adicionar indicador de carregamento
            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `<div id="${loadingId}" style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--bg-hover); align-self: flex-start;"><span class="spinner"></span> Pensando...</div>`;
            container.scrollTop = container.scrollHeight;
            
            try {
                const result = await api(`/chat/sessoes/${sessionId}/mensagem`, {
                    method: 'POST',
                    body: JSON.stringify({
                        mensagem: mensagem,
                        model_id: modelId || null
                    })
                });
                
                // Remover loading e adicionar resposta
                document.getElementById(loadingId)?.remove();
                const resposta = result.resposta?.content || result.content || 'Sem resposta';
                container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--bg-hover); align-self: flex-start; white-space: pre-wrap;">${escapeHtml(resposta)}</div>`;
                container.scrollTop = container.scrollHeight;
            } catch (e) {
                document.getElementById(loadingId)?.remove();
                container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: rgba(239, 68, 68, 0.2); color: var(--danger); align-self: flex-start;">❌ Erro ao enviar mensagem</div>`;
            }
        }

        // Permitir enviar com Enter
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        enviarMensagemChat();
                    }
                });
            }
            // Carregar modelos sugeridos no início
            carregarModelosSugeridosInicial();
        });
    </script>
    <script src="/static/chat_system.js"></script>
</body>
</html>

