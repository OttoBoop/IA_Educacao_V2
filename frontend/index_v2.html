<!-- 
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  PROVA AI - FRONTEND v2.0 - PARTE 1 de 2                        ‚ïë
‚ïë                                                                  ‚ïë
‚ïë  INSTRU√á√ïES:                                                     ‚ïë
‚ïë  1. Copie TODO o conte√∫do deste arquivo                         ‚ïë
‚ïë  2. Cole no VSCode                                               ‚ïë
‚ïë  3. Depois, copie a PARTE 2 e cole NO FINAL deste arquivo       ‚ïë
‚ïë  4. Salve como: frontend/index_v2.html                          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prova AI v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f1117;
            --bg-card: #1a1d24;
            --bg-hover: #242830;
            --bg-input: #242830;
            --border: #2e3340;
            --text: #e4e4e7;
            --text-muted: #71717a;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --purple: #a855f7;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }
        
        .app { display: flex; min-height: 100vh; }
        
        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-tree {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .tree-section { margin-bottom: 8px; }
        
        .tree-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.15s;
        }
        
        .tree-item:hover { background: var(--bg-hover); }
        .tree-item.active { background: var(--primary); color: white; }
        
        .tree-item-icon { opacity: 0.7; font-size: 1rem; }
        .tree-item-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tree-item-count {
            font-size: 0.75rem;
            background: var(--bg-hover);
            padding: 2px 8px;
            border-radius: 10px;
            color: var(--text-muted);
        }
        
        .tree-children {
            margin-left: 20px;
            border-left: 1px solid var(--border);
            padding-left: 8px;
            display: none;
        }
        
        .tree-children.expanded { display: block; }
        
        .tree-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.5;
            transition: transform 0.2s;
        }
        
        .tree-toggle.expanded { transform: rotate(90deg); }
        .tree-toggle.hidden { visibility: hidden; }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        /* MAIN CONTENT */
        .main {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .breadcrumb-item {
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.15s;
        }
        
        .breadcrumb-item:hover { color: var(--text); }
        .breadcrumb-item.current { color: var(--text); font-weight: 500; }
        .breadcrumb-sep { color: var(--text-muted); opacity: 0.5; }
        
        .header-actions { display: flex; gap: 12px; }
        
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        /* PAGE HEADER */
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 4px; }
        .page-subtitle { color: var(--text-muted); font-size: 0.9rem; }
        
        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title { font-size: 1rem; font-weight: 600; }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .card-grid-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .card-grid-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-hover);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 12px;
        }
        
        .card-name { font-weight: 600; margin-bottom: 4px; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); }
        
        /* BUTTONS */
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }
        
        .btn:hover { background: var(--bg-hover); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); border-color: var(--success); color: white; }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* FORMS */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-muted);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.9rem;
            transition: border-color 0.15s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-textarea { min-height: 100px; resize: vertical; }
        
        /* TABLES */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        tr:hover { background: var(--bg-hover); }
        
        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .badge-warning { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-purple { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
        
        /* ALERTS */
        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .alert-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: var(--warning);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }
        
        .alert-icon { font-size: 1.2rem; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 4px; }
        .alert-text { font-size: 0.85rem; opacity: 0.9; }
        
        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-size: 1.1rem; font-weight: 600; }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
        }
        
        .modal-close:hover { color: var(--text); }
        .modal-body { padding: 20px; }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* UPLOAD ZONE */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .upload-zone.dragover {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .upload-icon { font-size: 3rem; opacity: 0.5; margin-bottom: 16px; }
        .upload-text { color: var(--text-muted); }
        .upload-text strong { color: var(--primary); }
        
        /* DOC ITEM */
        .doc-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .doc-item:hover { background: var(--bg-hover); }
        
        .doc-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-hover);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .doc-info { flex: 1; }
        .doc-actions { display: flex; gap: 8px; }
        .doc-name { font-weight: 500; font-size: 0.9rem; }
        .doc-meta { font-size: 0.8rem; color: var(--text-muted); }

        .doc-group {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-card);
        }

        .doc-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 8px;
        }

        .doc-group-title {
            font-weight: 600;
        }

        .doc-item-static { cursor: default; }
        .doc-item-static:hover { background: var(--bg-input); }

        .doc-meta-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 12px;
            margin-top: 4px;
            color: var(--text-muted);
            font-size: 0.78rem;
        }

        .doc-meta-pill {
            background: var(--bg-hover);
            border-radius: 999px;
            padding: 2px 8px;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-icon { font-size: 4rem; opacity: 0.3; margin-bottom: 16px; }
        .empty-title { font-size: 1.1rem; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .empty-text { margin-bottom: 20px; }
        
        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s;
        }
        
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        /* TOAST */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
            max-width: 400px;
        }
        
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        
        /* SPINNER */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* TASK PANEL */
        .task-panel {
            position: fixed;
            bottom: 80px;
            right: 24px;
            width: 380px;
            max-height: 400px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 150;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .task-panel.show { display: flex; }
        .task-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-hover);
        }
        .task-panel-header h4 { margin: 0; font-size: 0.9rem; }
        .task-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .task-item {
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-hover);
            margin-bottom: 8px;
            border-left: 3px solid var(--border);
        }
        .task-item.running { border-left-color: var(--primary); }
        .task-item.success { border-left-color: var(--success); }
        .task-item.error { border-left-color: var(--danger); }
        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .task-item-title { font-weight: 500; font-size: 0.85rem; }
        .task-item-status { font-size: 0.75rem; color: var(--text-muted); }
        .task-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .task-fab {
            position: fixed;
            bottom: 24px;
            right: 440px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            z-index: 151;
        }
        .task-fab.show { display: flex; }
        .task-fab .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* RESULTS NAV */
        .results-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .results-nav-item {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .results-nav-item:hover { background: var(--bg-hover); }
        .results-nav-item.active { border-color: var(--primary); background: rgba(139, 92, 246, 0.1); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }



        /* ============================================
           CHAT GERAL - ESTILOS
           ============================================ */
        .chat-panel {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .chat-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .chat-provider-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-provider-icon {
            font-size: 1.5rem;
        }
        
        .chat-provider-name {
            font-weight: 600;
        }
        
        .chat-provider-model {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .chat-context-bar {
            padding: 10px 20px;
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }
        
        .chat-context-bar select {
            flex: 1;
            max-width: 300px;
        }
        
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .chat-message.user {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: var(--bg-input);
            border: 1px solid var(--border);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message pre {
            background: var(--bg-dark);
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
        }
        
        .chat-message-meta {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 16px;
        }
        
        .chat-message-files {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .chat-message-file {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-hover);
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .chat-message-file:hover {
            background: var(--border);
        }
        
        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .chat-input-wrapper textarea {
            flex: 1;
            min-height: 44px;
            max-height: 150px;
            resize: none;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.95rem;
        }
        
        .chat-input-wrapper textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }
        
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing-bounce {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-4px); }
        }
        
        .alert-pipeline {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .alert-pipeline.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .alert-pipeline.warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        
        .alert-pipeline.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .alert-pipeline.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* ============================================================
           MODEL MODAL STYLES
           ============================================================ */

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .model-warning {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.3);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .model-warning .warning-icon {
            font-size: 1.5rem;
        }
        .model-warning .warning-text strong {
            display: block;
            color: var(--warning);
            margin-bottom: 4px;
        }
        .model-warning .warning-text p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        /* ============================================================
           CATALOG STYLES
           ============================================================ */

        /* View Mode Selector */
        .catalog-view-modes {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .view-mode-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }
        .view-mode-btn:hover { background: var(--bg-hover); }
        .view-mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Catalog Filters */
        .catalog-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        /* Model Card Grid */
        .model-catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .model-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.15s, transform 0.15s;
        }
        .model-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .model-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .model-card-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .model-card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* Model Stats */
        .model-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stat {
            flex: 1;
            text-align: center;
            padding: 8px 4px;
            background: var(--bg-dark);
            border-radius: 6px;
        }
        .stat-label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        .stat-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Capability Badges */
        .capability-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .capability-badges span {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        .badge-vision { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .badge-tools { background: rgba(168,85,247,0.2); color: #c084fc; }
        .badge-reasoning { background: rgba(234,179,8,0.2); color: #fbbf24; }
        .badge-search { background: rgba(34,197,94,0.2); color: #4ade80; }
        .badge-json { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .badge-code { background: rgba(236,72,153,0.2); color: #f472b6; }

        /* Provider Badges */
        .provider-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }
        .provider-openai { background: #10a37f; }
        .provider-anthropic { background: #d4a574; }
        .provider-google { background: #4285f4; }
        .provider-deepseek { background: #1890ff; }
        .provider-xai { background: #333; }
        .provider-perplexity { background: #20b2aa; }
        .provider-cohere { background: #ff6b6b; }
        .provider-mistral { background: #ff7000; }
        .provider-groq { background: #f55036; }
        .provider-openrouter { background: #6366f1; }
        .provider-ollama { background: #fff; color: #333; }
        .provider-vllm { background: #7c3aed; }
        .provider-lmstudio { background: #059669; }

        /* Model Card Footer */
        .model-card-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        /* Catalog Table (Table View) */
        .catalog-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .catalog-table th, .catalog-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .catalog-table th {
            background: var(--bg-input);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
        }
        .catalog-table tr:hover { background: var(--bg-hover); }
        .catalog-table .check { color: var(--success); }
        .catalog-table .cross { color: var(--text-muted); }

        /* Compare Grid */
        .compare-selector { margin-bottom: 16px; }
        .compare-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .compare-chip {
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .compare-chip:hover { border-color: var(--primary); }
        .compare-chip.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        /* Cost Results */
        .cost-results {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .cost-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }
        .cost-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .cost-card-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
        }
        .cost-card-sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Minimal View */
        .minimal-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .minimal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .minimal-item:hover { background: var(--bg-hover); }
        .provider-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .context-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            background: var(--bg-dark);
            border-radius: 4px;
            color: var(--text-muted);
        }

        /* Local Providers */
        .local-providers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        .local-provider-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }
        .local-provider-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .local-provider-icon { font-size: 1.2rem; }
        .local-provider-name {
            font-weight: 600;
            flex: 1;
        }
        .status-indicator { font-size: 0.9rem; }
        .local-provider-url {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .local-models-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .local-model-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-dark);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .local-model-item .model-name { flex: 1; }
        .local-model-item .model-size {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-right: 8px;
        }
        .empty-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            padding: 12px;
        }

        /* Modal Tabs for Student Selection */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
            padding: 0 20px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: var(--text-primary);
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Student Selection List */
        .aluno-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 12px;
        }
        .aluno-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .aluno-item:last-child {
            border-bottom: none;
        }
        .aluno-item:hover {
            background: var(--bg-hover);
        }
        .aluno-item.selected {
            background: var(--primary-alpha, rgba(74, 144, 226, 0.15));
            border-left: 3px solid var(--primary);
        }
        .aluno-item-info {
            flex: 1;
        }
        .aluno-item-nome {
            font-weight: 500;
            color: var(--text-primary);
        }
        .aluno-item-detalhes {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .aluno-list-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
        }

    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">üìù</div>
                    <span>Prova AI</span>
                </div>
            </div>
            
<nav class="nav-tree" id="nav-tree">
<div class="tree-section">
                    <div class="tree-section-header">
                        <span>Navega√ß√£o</span>
                    </div>
                    <div class="tree-item active" onclick="showDashboard()">
                        <span class="tree-item-icon">üè†</span>
                        <span class="tree-item-name">In√≠cio</span>
                    </div>
                    <div class="tree-item" onclick="showChat()">
                        <span class="tree-item-icon">üí¨</span>
                        <span class="tree-item-name">Chat com IA</span>
                    </div>
                    <div class="tree-item" onclick="showAlunos()">
                        <span class="tree-item-icon">üë•</span>
                        <span class="tree-item-name">Todos os Alunos</span>
                    </div>
                    <div class="tree-item" onclick="showPrompts()">
                        <span class="tree-item-icon">üß†</span>
                        <span class="tree-item-name">Prompts</span>
                    </div>
                    <div class="tree-item" onclick="showProviders()">
                        <span class="tree-item-icon">ü§ñ</span>
                        <span class="tree-item-name">Modelos de LLM</span>
                    </div>
                </div>
                
                <div class="tree-section">
                    <div class="tree-section-header">
                        <span>Mat√©rias</span>
                        <button class="btn btn-sm" onclick="openModal('modal-materia')">+</button>
                    </div>
                    <div id="tree-materias"></div>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn" style="width: 100%; margin-bottom: 8px;" onclick="openModal('modal-settings')">
                    ‚öôÔ∏è Configura√ß√µes IA
                </button>
                <button class="btn btn-primary" style="width: 100%;" onclick="openModal('modal-materia')">
                    + Nova Mat√©ria
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main">
            <header class="header">
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item current">In√≠cio</span>
                </div>
                <div class="header-actions">
                    <button class="btn" onclick="openModal('modal-busca')">üîç Buscar</button>
                </div>
            </header>
            
            <div class="content" id="content"></div>
        </main>
    </div>
    
    <!-- Modal: Nova Mat√©ria -->
    <div class="modal-overlay" id="modal-materia">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Mat√©ria</h3>
                <button class="modal-close" onclick="closeModal('modal-materia')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Mat√©ria *</label>
                    <input type="text" class="form-input" id="input-materia-nome" placeholder="Ex: Matem√°tica">
                </div>
                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="input-materia-desc" placeholder="Descri√ß√£o opcional"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">N√≠vel de Ensino</label>
                    <select class="form-select" id="input-materia-nivel">
                        <option value="outro">Outro</option>
                        <option value="fundamental_1">Fundamental I</option>
                        <option value="fundamental_2">Fundamental II</option>
                        <option value="medio">Ensino M√©dio</option>
                        <option value="superior">Ensino Superior</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-materia')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarMateria()">Criar Mat√©ria</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Nova Turma -->
    <div class="modal-overlay" id="modal-turma">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Turma</h3>
                <button class="modal-close" onclick="closeModal('modal-turma')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Turma *</label>
                    <input type="text" class="form-input" id="input-turma-nome" placeholder="Ex: 9¬∫ Ano A">
                </div>
                <div class="form-group">
                    <label class="form-label">Ano Letivo</label>
                    <input type="number" class="form-input" id="input-turma-ano" placeholder="2024" value="2024">
                </div>
                <div class="form-group">
                    <label class="form-label">Per√≠odo</label>
                    <input type="text" class="form-input" id="input-turma-periodo" placeholder="Ex: Manh√£">
                </div>
                <input type="hidden" id="input-turma-materia-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-turma')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarTurma()">Criar Turma</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Nova Atividade -->
    <div class="modal-overlay" id="modal-atividade">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Atividade</h3>
                <button class="modal-close" onclick="closeModal('modal-atividade')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome da Atividade *</label>
                    <input type="text" class="form-input" id="input-ativ-nome" placeholder="Ex: Prova 1 - Bimestre 1">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-select" id="input-ativ-tipo">
                        <option value="prova">Prova</option>
                        <option value="trabalho">Trabalho</option>
                        <option value="exercicio">Exerc√≠cio</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nota M√°xima</label>
                    <input type="number" class="form-input" id="input-ativ-nota" value="10" step="0.5">
                </div>
                <input type="hidden" id="input-ativ-turma-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-atividade')">Cancelar</button>
                <button class="btn btn-primary" onclick="criarAtividade()">Criar Atividade</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Adicionar Aluno -->
    <div class="modal-overlay" id="modal-aluno">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Aluno</h3>
                <button class="modal-close" onclick="closeModal('modal-aluno')">√ó</button>
            </div>

            <!-- Tab buttons -->
            <div class="modal-tabs">
                <button class="tab-btn active" id="tab-btn-selecionar" onclick="switchAlunoTab('selecionar')">Selecionar Existente</button>
                <button class="tab-btn" id="tab-btn-criar" onclick="switchAlunoTab('criar')">Criar Novo</button>
            </div>

            <div class="modal-body">
                <!-- Tab: Select Existing -->
                <div id="tab-selecionar-aluno">
                    <input type="text" class="form-input" id="input-busca-aluno"
                           placeholder="Buscar por nome..." oninput="filtrarAlunos()">
                    <div id="lista-alunos" class="aluno-list"></div>
                </div>

                <!-- Tab: Create New -->
                <div id="tab-criar-aluno" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" class="form-input" id="input-aluno-nome" placeholder="Ex: Jo√£o da Silva">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Matr√≠cula</label>
                        <input type="text" class="form-input" id="input-aluno-matricula" placeholder="Ex: 2024001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="input-aluno-email" placeholder="email@exemplo.com">
                    </div>
                </div>

                <input type="hidden" id="input-aluno-turma-id">
                <input type="hidden" id="input-aluno-selecionado-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-aluno')">Cancelar</button>
                <button class="btn btn-primary" id="btn-confirmar-aluno" onclick="confirmarAluno()">Adicionar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Upload Documento -->
    <div class="modal-overlay" id="modal-upload">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Documento</h3>
                <button class="modal-close" onclick="closeModal('modal-upload')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Tipo de Documento *</label>
                    <select class="form-select" id="input-upload-tipo">
                        <option value="enunciado">üìÑ Enunciado da Prova</option>
                        <option value="gabarito">‚úÖ Gabarito</option>
                        <option value="criterios_correcao">üìã Crit√©rios de Corre√ß√£o</option>
                        <option value="prova_respondida">üë§ Prova do Aluno</option>
                        <option value="correcao_professor">üßë‚Äçüè´ Corre√ß√£o do Professor</option>
                    </select>
                </div>
                <div class="form-group" id="grupo-aluno-upload" style="display: none;">
                    <label class="form-label">Aluno *</label>
                    <select class="form-select" id="input-upload-aluno"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Arquivo *</label>
                    <div class="upload-zone" id="upload-zone-modal">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">
                            Arraste o(s) arquivo(s) aqui ou <strong>clique para selecionar</strong>
                        </div>
                        <input type="file" id="input-upload-file" hidden multiple accept=".pdf,.docx,.doc,.png,.jpg,.jpeg">
                    </div>
                    <div id="upload-file-name" style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);"></div>
                </div>
                <input type="hidden" id="input-upload-atividade-id">
                <input type="hidden" id="input-upload-documento-id">
                <div id="upload-replace-info" style="display: none; margin-top: 8px; font-size: 0.85rem; color: var(--text-muted);"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-upload')">Cancelar</button>
                <button class="btn btn-primary" onclick="uploadDocumento()">Fazer Upload</button>
            </div>
        </div>
    </div>

    <!-- Modal: Visualizar Documento -->
    <div class="modal-overlay" id="modal-documento-conteudo">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="titulo-documento-conteudo">Visualizar Documento</h3>
                <button class="modal-close" onclick="closeModal('modal-documento-conteudo')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="documento-conteudo-meta" style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;"></div>
                <pre id="output-documento-conteudo" style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto; max-height: 60vh;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-documento-conteudo')">Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Busca -->
    <div class="modal-overlay" id="modal-busca">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buscar</h3>
                <button class="modal-close" onclick="closeModal('modal-busca')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-input" id="input-busca" placeholder="Digite para buscar...">
                </div>
                <div id="resultados-busca"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Alunos (CSV) -->
    <div class="modal-overlay" id="modal-importar-csv">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Importar Alunos (CSV)</h3>
                <button class="modal-close" onclick="closeModal('modal-importar-csv')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">
                    Cabe√ßalho esperado: nome,email,matricula
                </p>
                <div class="form-group">
                    <label class="form-label">Arquivo CSV *</label>
                    <input type="file" class="form-input" id="input-importar-csv" accept=".csv">
                </div>
                <input type="hidden" id="input-importar-turma-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-importar-csv')">Cancelar</button>
                <button class="btn btn-primary" onclick="importarAlunosCsv()">Importar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Upload Provas em Lote -->
    <div class="modal-overlay" id="modal-upload-provas">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Provas em Lote</h3>
                <button class="modal-close" onclick="closeModal('modal-upload-provas')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Modo de identifica√ß√£o</label>
                    <select class="form-select" id="input-upload-provas-modo">
                        <option value="matricula">Matr√≠cula no nome do arquivo</option>
                        <option value="nome">Nome do aluno no arquivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Arquivos *</label>
                    <input type="file" class="form-input" id="input-upload-provas-files" multiple accept=".pdf,.docx,.doc,.png,.jpg,.jpeg">
                </div>
                <input type="hidden" id="input-upload-provas-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-upload-provas')">Cancelar</button>
                <button class="btn btn-primary" onclick="uploadProvasEmLote()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Executar Etapa -->
    <div class="modal-overlay" id="modal-execucao">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Executar Etapa</h3>
                <button class="modal-close" onclick="closeModal('modal-execucao')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Etapa *</label>
                    <select class="form-select" id="input-execucao-etapa" onchange="onEtapaChange()"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Aluno (opcional para etapas da atividade)</label>
                    <select class="form-select" id="input-execucao-aluno"></select>
                    <small id="input-execucao-aluno-hint" style="color: var(--text-muted); font-size: 0.8rem;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt</label>
                    <select class="form-select" id="input-execucao-prompt" onchange="onPromptChange()">
                        <option value="">Usar prompt padr√£o</option>
                    </select>
                </div>
                <div class="form-group" id="grupo-prompt-customizado" style="display: none;">
                    <label class="form-label">
                        <input type="checkbox" id="input-execucao-editar-prompt" onchange="toggleEditarPrompt()">
                        Editar prompt antes de executar
                    </label>
                </div>
                <div class="form-group" id="grupo-prompt-texto" style="display: none;">
                    <label class="form-label">Texto do Prompt</label>
                    <textarea class="form-textarea" id="input-execucao-prompt-texto" rows="6" placeholder="Carregue um prompt ou escreva aqui..."></textarea>
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Vari√°veis dispon√≠veis: {conteudo_documento}, {questoes_extraidas}, {gabarito_extraido}, {respostas_extraidas}, {materia}, {atividade}, {nome_aluno}</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Modelo de IA</label>
                    <select class="form-select" id="input-execucao-model"></select>
                </div>
                <input type="hidden" id="input-execucao-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-execucao')">Cancelar</button>
                <button class="btn" onclick="executarEtapa(true)">Preview</button>
                <button class="btn btn-primary" onclick="executarEtapa(false)">Executar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Pipeline Completo -->
    <div class="modal-overlay" id="modal-pipeline-completo">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üöÄ Pipeline Completo</h3>
                <button class="modal-close" onclick="closeModal('modal-pipeline-completo')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Executar para:</label>
                    <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="pipeline-modo" value="aluno" checked onchange="onPipelineModoChange()"> Um aluno espec√≠fico
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="pipeline-modo" value="turma" onchange="onPipelineModoChange()"> Turma toda
                        </label>
                    </div>
                </div>
                <div class="form-group" id="pipeline-aluno-container">
                    <label class="form-label">Aluno *</label>
                    <select class="form-select" id="input-pipeline-aluno"></select>
                </div>
                <div id="pipeline-turma-info" style="display: none;">
                    <div class="alert alert-info" style="margin-bottom: 12px;">‚ö†Ô∏è Ser√° executado para todos os alunos que t√™m prova enviada</div>
                    <div id="pipeline-turma-resumo" style="padding: 10px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 12px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Modelo de IA padr√£o</label>
                    <select class="form-select" id="input-pipeline-provider-default"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Modelo por etapa (opcional)</label>
                    <div id="pipeline-provider-stages" style="display: flex; flex-direction: column; gap: 8px;"></div>
                    <small style="color: var(--text-muted); display: block; margin-top: 6px;">
                        Selecione um modelo diferente por etapa para personalizar a execu√ß√£o.
                    </small>
                </div>
                <input type="hidden" id="input-pipeline-atividade-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-pipeline-completo')">Cancelar</button>
                <button class="btn btn-primary" id="btn-executar-pipeline" onclick="executarPipelineCompleto()">Executar Pipeline</button>
            </div>
        </div>
    </div>

    <!-- Modal: Preview Prompt -->
    <div class="modal-overlay" id="modal-prompt-preview">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Preview de Prompt</h3>
                <button class="modal-close" onclick="closeModal('modal-prompt-preview')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Vari√°veis (JSON)</label>
                    <textarea class="form-textarea" id="input-prompt-variaveis" placeholder='{"materia":"Matem√°tica","atividade":"Prova 1"}'></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt de Sistema (preview)</label>
                    <textarea class="form-textarea" id="output-prompt-preview-sistema" readonly></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt do Usu√°rio (preview)</label>
                    <textarea class="form-textarea" id="output-prompt-preview" readonly></textarea>
                </div>
                <input type="hidden" id="input-prompt-id">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-prompt-preview')">Fechar</button>
                <button class="btn btn-primary" onclick="renderPrompt()">Gerar Preview</button>
            </div>
        </div>
    </div>

    <!-- Modal: Settings (API Keys e Modelos) -->
    <div class="modal-overlay" id="modal-settings">
        <div class="modal modal-lg" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">‚öôÔ∏è Configura√ß√µes de IA</h3>
                <button class="modal-close" onclick="closeModal('modal-settings')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="tabs" style="flex-wrap: wrap;">
                    <div class="tab active" onclick="showSettingsTab('api-keys')">üîë API Keys</div>
                    <div class="tab" onclick="showSettingsTab('models')">ü§ñ Modelos</div>
                    <div class="tab" onclick="showSettingsTab('catalog')">üìö Cat√°logo</div>
                    <div class="tab" onclick="showSettingsTab('custom')">‚öôÔ∏è Customizado</div>
                    <div class="tab" onclick="showSettingsTab('local')">üíª Local</div>
                </div>
                
                <!-- Tab: API Keys -->
                <div id="settings-tab-api-keys">
                    <div class="card-header" style="margin-bottom: 16px;">
                        <span class="card-title">API Keys por Empresa</span>
                        <button class="btn btn-primary btn-sm" onclick="openModal('modal-add-apikey')">+ Adicionar</button>
                    </div>
                    <div id="api-keys-list">
                        <div class="empty-state">
                            <div class="empty-icon">üîë</div>
                            <div class="empty-title">Nenhuma API key configurada</div>
                            <div class="empty-text">Adicione uma API key para come√ßar a usar a IA</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab: Models -->
                <div id="settings-tab-models" style="display: none;">
                    <div class="card-header" style="margin-bottom: 16px;">
                        <span class="card-title">Modelos Configurados</span>
                        <button class="btn btn-primary btn-sm" onclick="openAddModelModal()">+ Adicionar</button>
                    </div>
                    <div id="models-list">
                        <div class="empty-state">
                            <div class="empty-icon">ü§ñ</div>
                            <div class="empty-title">Nenhum modelo configurado</div>
                            <div class="empty-text">Adicione um modelo para usar nas corre√ß√µes</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Catalog -->
                <div id="settings-tab-catalog" style="display: none;">
                    <!-- View Mode Selector -->
                    <div class="catalog-view-modes">
                        <button class="view-mode-btn active" data-mode="cards" onclick="setCatalogView('cards')">‚ñ¶ Cards</button>
                        <button class="view-mode-btn" data-mode="table" onclick="setCatalogView('table')">‚ò∞ Tabela</button>
                        <button class="view-mode-btn" data-mode="compare" onclick="setCatalogView('compare')">‚áÜ Comparar</button>
                        <button class="view-mode-btn" data-mode="minimal" onclick="setCatalogView('minimal')">‚Ä¢ Minimal</button>
                    </div>

                    <!-- Filters -->
                    <div class="catalog-filters">
                        <select id="filter-provider" class="form-select" onchange="filterCatalog()" style="max-width: 180px;">
                            <option value="">Todos Provedores</option>
                        </select>
                        <select id="filter-capability" class="form-select" onchange="filterCatalog()" style="max-width: 180px;">
                            <option value="">Todas Capacidades</option>
                            <option value="vision">üëÅÔ∏è Vision</option>
                            <option value="tools">üîß Tool Use</option>
                            <option value="reasoning">üß† Reasoning</option>
                            <option value="search">üîç Search</option>
                            <option value="json_mode">üìã JSON Mode</option>
                        </select>
                        <input type="text" class="form-input" id="filter-search" placeholder="Buscar modelo..."
                               onkeyup="filterCatalog()" style="max-width: 180px;">
                    </div>

                    <!-- Catalog Content -->
                    <div id="catalog-content">
                        <div class="model-catalog-grid" id="catalog-grid"></div>
                    </div>

                    <!-- Compare Mode Content (hidden by default) -->
                    <div id="compare-content" style="display: none;">
                        <div class="compare-selector">
                            <label style="margin-bottom: 8px; display: block;">Selecione modelos para comparar (at√© 4):</label>
                            <div id="compare-chips" class="compare-chips"></div>
                        </div>
                        <div id="compare-grid" class="compare-grid"></div>

                        <!-- Cost Calculator -->
                        <div class="cost-calculator" style="margin-top: 20px;">
                            <h4 style="margin-bottom: 12px;">üí∞ Calculadora de Custos</h4>
                            <div class="form-row" style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Tokens Input/req</label>
                                    <input type="number" class="form-input" id="calc-input-tokens" value="1000" onchange="calculateCosts()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Tokens Output/req</label>
                                    <input type="number" class="form-input" id="calc-output-tokens" value="500" onchange="calculateCosts()">
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Requisi√ß√µes/dia</label>
                                    <input type="number" class="form-input" id="calc-requests" value="100" onchange="calculateCosts()">
                                </div>
                            </div>
                            <div id="cost-results" class="cost-results"></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Custom Endpoint -->
                <div id="settings-tab-custom" style="display: none;">
                    <div class="card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                        <h4 style="margin-bottom: 16px;">üîß Configura√ß√£o de Endpoint Customizado</h4>
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                            Configure endpoints espec√≠ficos (Azure, vers√µes antigas, proxies, etc.)
                        </p>

                        <div class="form-group">
                            <label class="form-label">Tipo de Compatibilidade *</label>
                            <select id="custom-compat" class="form-select">
                                <option value="openai">OpenAI-Compatible</option>
                                <option value="anthropic">Anthropic-Compatible</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nome de Exibi√ß√£o *</label>
                            <input type="text" class="form-input" id="custom-nome" placeholder="Ex: Azure GPT-4 Produ√ß√£o">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Base URL *</label>
                            <input type="text" class="form-input" id="custom-url" placeholder="https://my-resource.openai.azure.com/v1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ID Exato do Modelo *</label>
                            <input type="text" class="form-input" id="custom-model-id" placeholder="gpt-4o-2024-08-06">
                            <div class="form-hint">O identificador exato enviado nas requisi√ß√µes</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Vers√£o da API (opcional)</label>
                            <input type="text" class="form-input" id="custom-api-version" placeholder="2024-02-15-preview">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Headers Extras (JSON, opcional)</label>
                            <textarea class="form-input" id="custom-headers" rows="2" placeholder='{"x-custom-header": "value"}'></textarea>
                        </div>

                        <div class="form-row" style="display: flex; gap: 12px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Max Tokens</label>
                                <input type="number" class="form-input" id="custom-tokens" value="4096">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Temperatura</label>
                                <input type="number" class="form-input" id="custom-temp" value="0.7" step="0.1" min="0" max="2">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="salvarCustomEndpoint()" style="margin-top: 12px;">
                            üíæ Salvar Endpoint Customizado
                        </button>
                    </div>
                </div>

                <!-- Tab: Local Models -->
                <div id="settings-tab-local" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Detecta automaticamente modelos em servidores locais (Ollama, vLLM, LM Studio)
                        </p>
                        <button class="btn btn-sm" onclick="detectAllLocalModels()" style="margin-top: 8px;">
                            üîÑ Atualizar Todos
                        </button>
                    </div>

                    <div class="local-providers-grid">
                        <!-- Ollama -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">ü¶ô</span>
                                <span class="local-provider-name">Ollama</span>
                                <span id="ollama-status" class="status-indicator">‚è≥</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('ollama')">‚Üª</button>
                            </div>
                            <div class="local-provider-url">localhost:11434</div>
                            <div id="ollama-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>

                        <!-- vLLM -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">‚ö°</span>
                                <span class="local-provider-name">vLLM</span>
                                <span id="vllm-status" class="status-indicator">‚è≥</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('vllm')">‚Üª</button>
                            </div>
                            <div class="local-provider-url">localhost:8000</div>
                            <div id="vllm-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>

                        <!-- LM Studio -->
                        <div class="local-provider-card">
                            <div class="local-provider-header">
                                <span class="local-provider-icon">üñ•Ô∏è</span>
                                <span class="local-provider-name">LM Studio</span>
                                <span id="lmstudio-status" class="status-indicator">‚è≥</span>
                                <button class="btn btn-xs" onclick="detectLocalModels('lmstudio')">‚Üª</button>
                            </div>
                            <div class="local-provider-url">localhost:1234</div>
                            <div id="lmstudio-models" class="local-models-list">
                                <div class="empty-hint">Verificando...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar API Key -->
    <div class="modal-overlay" id="modal-add-apikey">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üîë Adicionar API Key</h3>
                <button class="modal-close" onclick="closeModal('modal-add-apikey')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Empresa *</label>
                    <select class="form-select" id="input-apikey-empresa">
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic</option>
                        <option value="google">Google (Gemini)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="mistral">Mistral</option>
                        <option value="xai">xAI (Grok)</option>
                        <option value="perplexity">Perplexity</option>
                        <option value="cohere">Cohere</option>
                        <option value="groq">Groq</option>
                        <option value="openrouter">OpenRouter</option>
                        <option value="ollama">Ollama (local)</option>
                        <option value="vllm">vLLM (local)</option>
                        <option value="lmstudio">LM Studio (local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key *</label>
                    <input type="password" class="form-input" id="input-apikey-key" placeholder="sk-...">
                    <div class="form-hint">Sua chave ser√° armazenada de forma segura</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome de exibi√ß√£o</label>
                    <input type="text" class="form-input" id="input-apikey-nome" placeholder="Ex: Minha conta OpenAI">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-apikey')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarApiKey()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Modelo -->
    <div class="modal-overlay" id="modal-add-model">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">ü§ñ Adicionar Modelo</h3>
                <button class="modal-close" onclick="closeModal('modal-add-model')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Linha 1: Apelido e Provider -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Apelido (Identificador) *</label>
                        <input type="text" class="form-input" id="input-model-nome" placeholder="Ex: GPT-4o Produ√ß√£o">
                        <div class="form-hint">Nome interno para identificar este modelo na lista</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Provedor *</label>
                        <select class="form-select" id="input-model-tipo" onchange="onProviderChange()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                            <option value="xai">xAI (Grok)</option>
                            <option value="perplexity">Perplexity</option>
                            <option value="cohere">Cohere</option>
                            <option value="groq">Groq</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (local)</option>
                            <option value="vllm">vLLM (local)</option>
                            <option value="lmstudio">LM Studio (local)</option>
                            <option value="custom">Customizado</option>
                        </select>
                    </div>
                </div>

                <!-- Linha 2: Modelo (select + input manual) -->
                <div class="form-group">
                    <label class="form-label">Modelo (ID da API) *</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select class="form-select" id="input-model-select" onchange="onModelSelect()" style="flex: 1;">
                            <option value="">-- Selecione ou digite abaixo --</option>
                        </select>
                        <span style="color: var(--text-muted);">ou</span>
                        <input type="text" class="form-input" id="input-model-manual" placeholder="gpt-4o-2024-08-06" style="flex: 1;">
                    </div>
                    <div class="form-hint">O ID exato do modelo enviado para a API (ex: gpt-4o, claude-sonnet-4-5-20250514)</div>
                </div>

                <!-- Aviso de Modelo Reasoning -->
                <div id="reasoning-warning" class="model-warning" style="display: none;">
                    <div class="warning-icon">üß†</div>
                    <div class="warning-text">
                        <strong>Modelo de Racioc√≠nio Detectado</strong>
                        <p>Este modelo usa "reasoning_effort" ao inv√©s de temperatura. Defina abaixo o n√≠vel de racioc√≠nio.</p>
                    </div>
                </div>

                <!-- Linha 3: Par√¢metros (dinamicamente mostra temp ou reasoning) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Max Tokens</label>
                        <input type="number" class="form-input" id="input-model-tokens" value="4096">
                        <div class="form-hint">M√°ximo de tokens na resposta</div>
                    </div>
                    <div class="form-group" id="temp-group">
                        <label class="form-label">Temperatura</label>
                        <input type="number" class="form-input" id="input-model-temp" value="0.7" step="0.1" min="0" max="2">
                        <div class="form-hint">0 = determin√≠stico, 2 = criativo</div>
                    </div>
                    <div class="form-group" id="reasoning-group" style="display: none;">
                        <label class="form-label">Reasoning Effort</label>
                        <select class="form-select" id="input-model-reasoning">
                            <option value="low">Low (r√°pido)</option>
                            <option value="medium" selected>Medium (balanceado)</option>
                            <option value="high">High (detalhado)</option>
                        </select>
                        <div class="form-hint">Profundidade do racioc√≠nio</div>
                    </div>
                </div>

                <!-- Linha 4: System Prompt com exemplo -->
                <div class="form-group">
                    <label class="form-label">System Prompt Padr√£o</label>
                    <textarea class="form-textarea" id="input-model-system" rows="4" placeholder="Instru√ß√µes que definem o comportamento do modelo..."></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                        <div class="form-hint">Deixe vazio para usar o prompt padr√£o do sistema</div>
                        <button class="btn btn-xs" onclick="preencherSystemPromptPadrao()">Usar Padr√£o</button>
                    </div>
                </div>

                <!-- Linha 5: Capacidades (checkbox) -->
                <div class="form-group">
                    <label class="form-label">Capacidades do Modelo</label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="input-model-vision">
                            <span>üëÅÔ∏è Vision (imagens)</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="input-model-tools">
                            <span>üîß Tool Use / Functions</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="input-model-streaming" checked>
                            <span>üì° Streaming</span>
                        </label>
                    </div>
                </div>

                <!-- Campo oculto para ID do modelo real -->
                <input type="hidden" id="input-model-modelo">
                <input type="hidden" id="input-model-is-reasoning" value="false">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('modal-add-model')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarModelo()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Chat com IA -->
    <div class="modal-overlay" id="modal-chat">
        <div class="modal modal-lg" style="max-width: 900px; height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title" id="chat-titulo">üí¨ Chat com IA</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select class="form-select" id="chat-model-select" style="width: 200px;"></select>
                    <button class="modal-close" onclick="closeModal('modal-chat')">√ó</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; display: flex; flex-direction: column; height: calc(100% - 130px);">
                <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px;"></div>
                <div style="border-top: 1px solid var(--border); padding: 16px; display: flex; gap: 12px;">
                    <textarea class="form-textarea" id="chat-input" placeholder="Digite sua mensagem..." style="flex: 1; min-height: 44px; max-height: 150px; resize: none;"></textarea>
                    <button class="btn btn-primary" onclick="enviarMensagemChat()">Enviar</button>
                </div>
            </div>
            <input type="hidden" id="chat-session-id">
            <input type="hidden" id="chat-atividade-id">
            <input type="hidden" id="chat-aluno-id">
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Task Panel (Fila de Tarefas) -->
    <button class="task-fab" id="task-fab" onclick="toggleTaskPanel()">
        üìã
        <span class="badge" id="task-badge" style="display:none;">0</span>
    </button>
    <div class="task-panel" id="task-panel">
        <div class="task-panel-header">
            <h4>üìã Tarefas</h4>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-xs" onclick="clearCompletedTasks()">Limpar conclu√≠das</button>
                <button class="btn btn-xs" onclick="toggleTaskPanel()">√ó</button>
            </div>
        </div>
        <div class="task-panel-body" id="task-panel-body">
            <div class="empty-state" style="padding: 24px; text-align: center;">
                <div style="font-size: 2rem;">üì≠</div>
                <div style="color: var(--text-muted); font-size: 0.85rem;">Nenhuma tarefa em execu√ß√£o</div>
            </div>
        </div>
    </div>

<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  FIM DA PARTE 1 - CONTINUE COM A PARTE 2 ABAIXO                 ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->

    <script>
        // ============================================================
        // CONFIGURA√á√ÉO
        // ============================================================
        // API URL - relative path works in both local and production
        const API = '/api';
        
        let currentView = 'dashboard';
        let currentMateria = null;
        let currentTurma = null;
        let currentAtividade = null;
        let currentAluno = null;
         // Chat Geral
        let chatGeralConversationId = 'chat_' + Date.now();
        let chatGeralProviders = [];

        // ============================================================
        // SISTEMA DE TAREFAS (TASK QUEUE)
        // ============================================================
        const taskQueue = {
            tasks: [],
            results: [],
            maxResults: 20,

            addTask(type, description, atividadeId, alunoId = null) {
                const task = {
                    id: 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    type,
                    description,
                    atividadeId,
                    alunoId,
                    status: 'running',
                    createdAt: new Date(),
                    result: null,
                    error: null
                };
                this.tasks.push(task);
                this.updateUI();
                return task;
            },

            completeTask(taskId, result) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = 'success';
                    task.result = result;
                    task.completedAt = new Date();
                    // Adicionar ao hist√≥rico de resultados
                    this.results.unshift({
                        id: task.id,
                        type: task.type,
                        description: task.description,
                        atividadeId: task.atividadeId,
                        alunoId: task.alunoId,
                        result: result,
                        completedAt: task.completedAt
                    });
                    // Limitar hist√≥rico
                    if (this.results.length > this.maxResults) {
                        this.results = this.results.slice(0, this.maxResults);
                    }
                    this.updateUI();
                    showToast(`‚úÖ ${task.description} - conclu√≠do!`, 'success');
                }
            },

            failTask(taskId, error) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = 'error';
                    task.error = error;
                    task.completedAt = new Date();
                    this.updateUI();
                    showToast(`‚ùå ${task.description} - falhou: ${error}`, 'error');
                }
            },

            removeTask(taskId) {
                this.tasks = this.tasks.filter(t => t.id !== taskId);
                this.updateUI();
            },

            clearCompleted() {
                this.tasks = this.tasks.filter(t => t.status === 'running');
                this.updateUI();
            },

            clearResult(resultId) {
                this.results = this.results.filter(r => r.id !== resultId);
            },

            getRunningCount() {
                return this.tasks.filter(t => t.status === 'running').length;
            },

            isRunning(type, atividadeId, alunoId = null) {
                return this.tasks.some(t =>
                    t.status === 'running' &&
                    t.type === type &&
                    t.atividadeId === atividadeId &&
                    t.alunoId === alunoId
                );
            },

            updateUI() {
                const fab = document.getElementById('task-fab');
                const badge = document.getElementById('task-badge');
                const body = document.getElementById('task-panel-body');

                const runningCount = this.getRunningCount();
                const totalTasks = this.tasks.length;

                // Mostrar FAB se houver tarefas
                if (totalTasks > 0) {
                    fab.classList.add('show');
                    if (runningCount > 0) {
                        badge.style.display = 'flex';
                        badge.textContent = runningCount;
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    fab.classList.remove('show');
                    badge.style.display = 'none';
                }

                // Renderizar tarefas
                if (totalTasks === 0) {
                    body.innerHTML = `
                        <div class="empty-state" style="padding: 24px; text-align: center;">
                            <div style="font-size: 2rem;">üì≠</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Nenhuma tarefa em execu√ß√£o</div>
                        </div>
                    `;
                } else {
                    body.innerHTML = this.tasks.map(task => `
                        <div class="task-item ${task.status}">
                            <div class="task-item-header">
                                <span class="task-item-title">${escapeHtml(task.description)}</span>
                                <span class="task-item-status">
                                    ${task.status === 'running' ? '<span class="spinner"></span>' : ''}
                                    ${task.status === 'success' ? '‚úÖ' : ''}
                                    ${task.status === 'error' ? '‚ùå' : ''}
                                </span>
                            </div>
                            <div class="task-item-actions">
                                ${task.status === 'success' && task.result ? `<button class="btn btn-xs btn-primary" onclick="viewTaskResult('${task.id}')">Ver Resultado</button>` : ''}
                                ${task.status !== 'running' ? `<button class="btn btn-xs" onclick="taskQueue.removeTask('${task.id}')">Remover</button>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }
        };

        function toggleTaskPanel() {
            const panel = document.getElementById('task-panel');
            panel.classList.toggle('show');
        }

        function clearCompletedTasks() {
            taskQueue.clearCompleted();
        }

        function viewTaskResult(taskId) {
            const task = taskQueue.tasks.find(t => t.id === taskId);
            if (task && task.result) {
                showResultado(task.type, task.atividadeId, task.alunoId, task.result, task.id);
            }
        }

        function showResultado(type, atividadeId, alunoId, result, taskId) {
            const backButton = atividadeId ?
                `<button class="btn" onclick="showAtividade('${atividadeId}')">‚Üê Voltar para Atividade</button>` :
                `<button class="btn" onclick="showDashboard()">‚Üê Voltar</button>`;

            const deleteButton = taskId ?
                `<button class="btn btn-danger btn-sm" onclick="deleteResultado('${taskId}')">üóëÔ∏è Excluir Visualiza√ß√£o</button>` : '';

            document.getElementById('content').innerHTML = `
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 class="page-title">Resultado: ${escapeHtml(type)}</h1>
                    ${deleteButton}
                </div>
                <div style="margin-bottom: 16px;">
                    ${backButton}
                </div>
                ${renderResultsNav(atividadeId, alunoId, taskId)}
                <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto; white-space: pre-wrap;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
            `;
        }

        function renderResultsNav(currentAtividadeId, currentAlunoId, currentTaskId) {
            const relevantResults = taskQueue.results.filter(r =>
                r.atividadeId === currentAtividadeId &&
                (!currentAlunoId || r.alunoId === currentAlunoId)
            );

            if (relevantResults.length <= 1) return '';

            return `
                <div class="results-nav">
                    ${relevantResults.map(r => `
                        <div class="results-nav-item ${r.id === currentTaskId ? 'active' : ''}"
                             onclick="showResultado('${escapeHtml(r.type)}', '${r.atividadeId}', '${r.alunoId || ''}', taskQueue.results.find(x => x.id === '${r.id}')?.result, '${r.id}')">
                            ${r.type === 'etapa' ? 'üìÑ' : 'üöÄ'} ${escapeHtml(r.description)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function deleteResultado(taskId) {
            if (!confirm('Excluir esta visualiza√ß√£o do hist√≥rico?')) return;
            taskQueue.clearResult(taskId);
            taskQueue.removeTask(taskId);
            showToast('Visualiza√ß√£o removida', 'success');
            // Voltar para atividade se poss√≠vel
            if (currentAtividade) {
                showAtividade(currentAtividade);
            } else {
                showDashboard();
            }
        }

        // ============================================================
        // INICIALIZA√á√ÉO
        // ============================================================

        document.addEventListener('DOMContentLoaded', () => {
            loadNavTree();
            showDashboard();
            setupUploadZone();
            setupBusca();
            loadTiposDocumentos();
            loadNiveisEnsino();
            loadChatGeralProviders();
        });
        
        // ============================================================
        // API HELPERS
        // ============================================================
        async function parseApiResponse(response) {
            const text = await response.text();
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                return text ? JSON.parse(text) : {};
            }
            try {
                return text ? JSON.parse(text) : {};
            } catch (e) {
                return { raw: text };
            }
        }

        async function api(endpoint, options = {}) {
            try {
                const response = await fetch(`${API}${endpoint}`, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', ...options.headers }
                });
                const data = await parseApiResponse(response);
                if (!response.ok) {
                    const message = data?.detail || data?.message || data?.raw || 'Erro na requisi√ß√£o';
                    throw new Error(message);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }
        
        async function apiForm(endpoint, formData) {
            try {
                const response = await fetch(`${API}${endpoint}`, { method: 'POST', body: formData });
                const data = await parseApiResponse(response);
                if (!response.ok) {
                    const message = data?.detail || data?.message || data?.raw || 'Erro na requisi√ß√£o';
                    throw new Error(message);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(error.message, 'error');
                throw error;
            }
        }
        
        // ============================================================
        // NAVEGA√á√ÉO - √ÅRVORE
        // ============================================================
        async function loadNavTree() {
            try {
                const data = await api('/navegacao/arvore');
                renderNavTree(data.materias);
            } catch (e) {
                console.error('Erro ao carregar √°rvore:', e);
            }
        }
        
        function renderNavTree(materias) {
            const container = document.getElementById('tree-materias');
            if (materias.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--text-muted); font-size: 0.85rem;">Nenhuma mat√©ria ainda</div>';
                return;
            }
            
            container.innerHTML = materias.map(materia => `
                <div class="tree-item" onclick="showMateria('${materia.id}')">
                    <span class="tree-toggle ${materia.turmas.length > 0 ? '' : 'hidden'}" onclick="event.stopPropagation(); toggleTree(this)">‚ñ∂</span>
                    <span class="tree-item-icon">üìö</span>
                    <span class="tree-item-name">${materia.nome}</span>
                    <span class="tree-item-count">${materia.turmas.length}</span>
                </div>
                <div class="tree-children" id="tree-materia-${materia.id}">
                    ${materia.turmas.map(turma => `
                        <div class="tree-item" onclick="showTurma('${turma.id}')">
                            <span class="tree-toggle ${turma.atividades.length > 0 ? '' : 'hidden'}" onclick="event.stopPropagation(); toggleTree(this)">‚ñ∂</span>
                            <span class="tree-item-icon">üë•</span>
                            <span class="tree-item-name">${turma.nome}</span>
                            <span class="tree-item-count">${turma.total_alunos}</span>
                        </div>
                        <div class="tree-children" id="tree-turma-${turma.id}">
                            ${turma.atividades.map(ativ => `
                                <div class="tree-item" onclick="showAtividade('${ativ.id}')">
                                    <span class="tree-item-icon">üìù</span>
                                    <span class="tree-item-name">${ativ.nome}</span>
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        function toggleTree(el) {
            el.classList.toggle('expanded');
            const children = el.closest('.tree-item').nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('expanded');
            }
        }
        
        // ============================================================
        // VIEWS
        // ============================================================
        async function showDashboard() {
            currentView = 'dashboard';
            currentMateria = currentTurma = currentAtividade = null;
            setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}]);
            
            try {
                const stats = await api('/estatisticas');
                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Vis√£o geral do sistema</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value">${stats.total_materias}</div><div class="stat-label">Mat√©rias</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_turmas}</div><div class="stat-label">Turmas</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_alunos}</div><div class="stat-label">Alunos</div></div>
                        <div class="stat-card"><div class="stat-value">${stats.total_atividades}</div><div class="stat-label">Atividades</div></div>
                    </div>
                    ${stats.alertas.atividades_sem_gabarito > 0 ? `
                        <div class="alert alert-warning">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div class="alert-content">
                                <div class="alert-title">Aten√ß√£o</div>
                                <div class="alert-text">${stats.alertas.atividades_sem_gabarito} atividade(s) sem gabarito</div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Mat√©rias</h3>
                            <button class="btn btn-primary btn-sm" onclick="openModal('modal-materia')">+ Nova</button>
                        </div>
                        <div class="card-grid" id="grid-materias"><div style="color: var(--text-muted);">Carregando...</div></div>
                    </div>
                `;
                
                const materiasData = await api('/materias');
                const gridMaterias = document.getElementById('grid-materias');
                if (materiasData.materias.length === 0) {
                    gridMaterias.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-icon">üìö</div><div class="empty-title">Nenhuma mat√©ria</div><div class="empty-text">Comece criando sua primeira mat√©ria</div><button class="btn btn-primary" onclick="openModal('modal-materia')">+ Criar Mat√©ria</button></div>`;
                } else {
                    gridMaterias.innerHTML = materiasData.materias.map(m => `<div class="card-grid-item" onclick="showMateria('${m.id}')"><div class="card-icon">üìö</div><div class="card-name">${m.nome}</div><div class="card-meta">${m.descricao || 'Sem descri√ß√£o'}</div></div>`).join('');
                }
            } catch (e) {
                document.getElementById('content').innerHTML = `<div class="alert alert-danger"><span class="alert-icon">‚ùå</span><div class="alert-content"><div class="alert-title">Erro ao carregar</div><div class="alert-text">Verifique se o servidor est√° rodando corretamente</div></div></div>`;
            }
        }
        
        async function showMateria(materiaId) {
            currentView = 'materia';
            currentMateria = materiaId;
            currentTurma = currentAtividade = null;
            
            try {
                const data = await api(`/materias/${materiaId}`);
                setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: data.materia.nome, onclick: `showMateria('${materiaId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div><h1 class="page-title">${data.materia.nome}</h1><p class="page-subtitle">${data.materia.descricao || 'Sem descri√ß√£o'}</p></div>
                        <button class="btn btn-danger btn-sm" onclick="excluirMateria('${materiaId}')">üóëÔ∏è Excluir Mat√©ria</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Turmas (${data.total_turmas})</h3><button class="btn btn-primary btn-sm" onclick="openModalTurma('${materiaId}')">+ Nova Turma</button></div>
                        ${data.turmas.length === 0 ? `<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Nenhuma turma</div><div class="empty-text">Crie uma turma para come√ßar</div></div>` : `<div class="card-grid">${data.turmas.map(t => `<div class="card-grid-item" onclick="showTurma('${t.id}')"><div class="card-icon">üë•</div><div class="card-name">${t.nome}</div><div class="card-meta">${t.ano_letivo || ''} ${t.periodo || ''}</div></div>`).join('')}</div>`}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar mat√©ria', 'error'); }
        }
        
        async function showTurma(turmaId) {
            currentView = 'turma';
            currentTurma = turmaId;
            currentAtividade = null;
            
            try {
                const data = await api(`/turmas/${turmaId}`);
                currentMateria = data.turma.materia_id;
                setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: data.materia.nome, onclick: `showMateria('${data.materia.id}')`}, {nome: data.turma.nome, onclick: `showTurma('${turmaId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div><h1 class="page-title">${data.turma.nome}</h1><p class="page-subtitle">${data.materia.nome} ‚Ä¢ ${data.turma.ano_letivo || ''}</p></div>
                        <button class="btn btn-danger btn-sm" onclick="excluirTurma('${turmaId}')">üóëÔ∏è Excluir Turma</button>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="showDashboardTurma('${turmaId}')">üìä Dashboard da Turma</button>
                        <button class="btn" onclick="openModalImportarCsv('${turmaId}')">‚¨áÔ∏è Importar Alunos (CSV)</button>
                        <button class="btn" onclick="exportarAlunosCsv('${turmaId}')">üì§ Exportar Alunos (CSV)</button>
                    </div>
                    <div class="tabs">
                        <div class="tab active" onclick="showTurmaTab('atividades', '${turmaId}')">Atividades (${data.total_atividades})</div>
                        <div class="tab" onclick="showTurmaTab('alunos', '${turmaId}')">Alunos (${data.total_alunos})</div>
                    </div>
                    <div id="turma-content">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Atividades</h3><button class="btn btn-primary btn-sm" onclick="openModalAtividade('${turmaId}')">+ Nova Atividade</button></div>
                            ${data.atividades.length === 0 ? `<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-title">Nenhuma atividade</div></div>` : `<div class="card-grid">${data.atividades.map(a => `<div class="card-grid-item" onclick="showAtividade('${a.id}')"><div class="card-icon">üìù</div><div class="card-name">${a.nome}</div><div class="card-meta"><span class="badge badge-${a.tipo === 'prova' ? 'primary' : 'purple'}">${a.tipo || 'outro'}</span> Nota m√°x: ${a.nota_maxima}</div></div>`).join('')}</div>`}
                        </div>
                    </div>
                `;
                window._turmaData = data;
            } catch (e) { showToast('Erro ao carregar turma', 'error'); }
        }
        
        async function showTurmaTab(tab, turmaId) {
            document.querySelectorAll('.tabs .tab').forEach((t, i) => t.classList.toggle('active', (tab === 'atividades' && i === 0) || (tab === 'alunos' && i === 1)));
            const data = window._turmaData;
            const container = document.getElementById('turma-content');
            
            if (tab === 'alunos') {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModalAluno('${data.turma.id}')">+ Novo Aluno</button></div>
                        ${data.alunos.length === 0 ? `<div class="empty-state"><div class="empty-icon">üë§</div><div class="empty-title">Nenhum aluno</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Nome</th><th>Matr√≠cula</th><th>Email</th><th>A√ß√µes</th></tr></thead><tbody>
                                ${data.alunos.map(a => `<tr><td><strong>${a.nome}</strong></td><td>${a.matricula || '-'}</td><td>${a.email || '-'}</td><td><button class="btn btn-sm" onclick="showAluno('${a.id}')">Ver</button> <button class="btn btn-sm btn-danger" onclick="excluirAluno('${a.id}')">üóëÔ∏è</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } else {
                showTurma(turmaId);
            }
        }
        
        async function showAtividade(atividadeId) {
            currentView = 'atividade';
            currentAtividade = atividadeId;
            currentAluno = null;
            
            try {
                const data = await api(`/atividades/${atividadeId}`);
                const turma = await api(`/turmas/${data.atividade.turma_id}`);
                currentTurma = turma.turma.id;
                currentMateria = turma.materia.id;
                
                setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: turma.materia.nome, onclick: `showMateria('${turma.materia.id}')`}, {nome: turma.turma.nome, onclick: `showTurma('${turma.turma.id}')`}, {nome: data.atividade.nome, onclick: `showAtividade('${atividadeId}')`}]);
                
                let alertas = data.documentos_base.faltando.length > 0 ? `<div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div class="alert-content"><div class="alert-title">Documentos faltando</div><div class="alert-text">${data.documentos_base.faltando.map(d => `<span class="badge badge-warning">${d}</span>`).join(' ')}</div></div></div>` : '';

                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">${data.atividade.nome}</h1><p class="page-subtitle">${turma.turma.nome} ‚Ä¢ Nota m√°x: ${data.atividade.nota_maxima}</p></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="openModalExecucao('${atividadeId}')">‚öôÔ∏è Executar Etapa</button>
                        <button class="btn btn-primary" onclick="openModalPipelineCompleto('${atividadeId}', 'aluno')">‚ö° Pipeline Aluno</button>
                        <button class="btn btn-success" onclick="openModalPipelineCompleto('${atividadeId}', 'turma')">üöÄ Pipeline Turma Toda</button>
                        <button class="btn" onclick="openModalUploadProvas('${atividadeId}')">üìö Upload Provas em Lote</button>
                    </div>
                    ${alertas}
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-card"><div class="stat-value">${data.alunos.total}</div><div class="stat-label">Alunos na turma</div></div>
                        <div class="stat-card"><div class="stat-value">${data.alunos.com_prova}</div><div class="stat-label">Provas entregues</div></div>
                        <div class="stat-card"><div class="stat-value">${data.alunos.corrigidos}</div><div class="stat-label">Corrigidos</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üìÑ Documentos da Atividade</h3><button class="btn btn-primary btn-sm" onclick="openModalUpload('${atividadeId}', 'base')">+ Upload</button></div>
                        <div id="docs-base">${renderDocsBase(data.documentos_base.existentes, atividadeId, data.documentos_base.detalhes || {})}</div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üë• Provas dos Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModalUpload('${atividadeId}', 'aluno')">+ Upload Prova</button></div>
                        <div class="table-container"><table><thead><tr><th>Aluno</th><th>Prova</th><th>Corre√ß√£o</th><th>Relat√≥rio</th><th>A√ß√µes</th></tr></thead><tbody>
                            ${data.alunos.detalhes.map(a => `<tr><td><strong>${a.aluno_nome}</strong></td><td>${a.tem_prova ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-danger">Falta</span>'}</td><td>${a.tem_correcao ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-warning">Pendente</span>'}</td><td>${a.tem_relatorio ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-warning">Pendente</span>'}</td><td><button class="btn btn-sm" onclick="showResultadoAluno('${atividadeId}', '${a.aluno_id}')">Ver Resultado</button></td></tr>`).join('')}
                        </tbody></table></div>
                    </div>
                `;
                window._atividadeData = data;
                window._turmaData = turma;
            } catch (e) { showToast('Erro ao carregar atividade', 'error'); }
        }
        
        function formatDateTime(value) {
            if (!value) return '';
            try {
                return new Date(value).toLocaleString('pt-BR');
            } catch (e) {
                return value;
            }
        }

        function renderDocumentoItem(doc, options = {}) {
            const metaItems = [];
            if (doc.criado_em) metaItems.push(`Enviado: ${formatDateTime(doc.criado_em)}`);
            if (doc.criado_por) metaItems.push(`Por: ${doc.criado_por}`);
            if (doc.ia_provider) metaItems.push(`IA: ${doc.ia_provider}`);
            if (doc.ia_modelo) metaItems.push(`Modelo: ${doc.ia_modelo}`);
            if (doc.prompt_usado) metaItems.push(`Prompt: ${doc.prompt_usado}`);
            if (doc.prompt_versao) metaItems.push(`Vers√£o: ${doc.prompt_versao}`);
            if (doc.tokens_usados) metaItems.push(`Tokens: ${doc.tokens_usados}`);
            if (doc.tempo_processamento_ms) metaItems.push(`Tempo: ${Math.round(doc.tempo_processamento_ms)}ms`);

            const metaHtml = metaItems.length
                ? `<div class="doc-meta-stack">${metaItems.map(item => `<span class="doc-meta-pill">${escapeHtml(item)}</span>`).join('')}</div>`
                : '';

            const actions = [];
            if (options.showVisualizar) {
                actions.push(`<button class="btn btn-sm" onclick="visualizarDocumento('${doc.id}')">Visualizar</button>`);
            }
            actions.push(`<button class="btn btn-sm" onclick="openDocumento('${doc.id}')">Baixar</button>`);
            if (options.showTrocar && options.onTrocar) {
                actions.push(`<button class="btn btn-sm btn-primary" onclick="${options.onTrocar}">Trocar</button>`);
            }
            if (options.showExcluir) {
                actions.push(`<button class="btn btn-sm btn-danger" onclick="deleteDocumento('${doc.id}')">Excluir</button>`);
            }

            return `
                <div class="doc-item doc-item-static">
                    <div class="doc-icon">${options.icon || 'üìÑ'}</div>
                    <div class="doc-info">
                        <div class="doc-name">${escapeHtml(doc.nome_arquivo || doc.id)}</div>
                        ${metaHtml}
                    </div>
                    <div class="doc-actions">${actions.join('')}</div>
                </div>
            `;
        }

        function renderDocumentoGrupo({ titulo, tipo, atividadeId, alunoId, docs, onAdicionar, icon, showVisualizar }) {
            const list = docs || [];
            const adicionarLabel = list.length ? '+ Novo' : 'Upload';
            const btnAdicionar = onAdicionar
                ? `<button class="btn btn-sm btn-primary" onclick="${onAdicionar}">${adicionarLabel}</button>`
                : '';
            const itens = list.length
                ? list.map(doc => renderDocumentoItem(doc, {
                    icon,
                    showVisualizar,
                    showTrocar: Boolean(onAdicionar),
                    showExcluir: true,
                    onTrocar: `openModalUploadSubstituir('${atividadeId}', '${tipo}', '${alunoId || ''}', '${doc.id}')`
                })).join('')
                : `<div class="doc-meta" style="padding: 8px 0;">Nenhum documento enviado.</div>`;
            return `
                <div class="doc-group">
                    <div class="doc-group-header">
                        <div class="doc-group-title">${titulo}${list.length ? ` (${list.length})` : ''}</div>
                        ${btnAdicionar}
                    </div>
                    ${itens}
                </div>
            `;
        }

        function renderDocsBase(existentes, atividadeId, detalhes = {}) {
            const tipos = ['enunciado', 'gabarito', 'criterios_correcao'];
            const nomes = {'enunciado': 'üìÑ Enunciado', 'gabarito': '‚úÖ Gabarito', 'criterios_correcao': 'üìã Crit√©rios de Corre√ß√£o'};
            return tipos.map(tipo => {
                const detalhe = detalhes[tipo];
                const docs = Array.isArray(detalhe) ? detalhe : (detalhe ? [detalhe] : []);
                return renderDocumentoGrupo({
                    titulo: nomes[tipo],
                    tipo,
                    atividadeId,
                    docs,
                    icon: tipo === 'gabarito' ? '‚úÖ' : (tipo === 'criterios_correcao' ? 'üìã' : 'üìÑ'),
                    onAdicionar: `openModalUploadTipo('${atividadeId}', '${tipo}')`,
                    showVisualizar: true
                });
            }).join('');
        }

        function groupDocumentosPorTipo(documentos) {
            return documentos.reduce((acc, doc) => {
                if (!acc[doc.tipo]) acc[doc.tipo] = [];
                acc[doc.tipo].push(doc);
                return acc;
            }, {});
        }
        
        async function showAlunos() {
            currentView = 'alunos';
            setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: 'Todos os Alunos', onclick: 'showAlunos()'}]);
            
            try {
                const data = await api('/alunos');
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Todos os Alunos</h1><p class="page-subtitle">${data.alunos.length} aluno(s)</p></div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Lista de Alunos</h3><button class="btn btn-primary btn-sm" onclick="openModal('modal-aluno')">+ Novo</button></div>
                        ${data.alunos.length === 0 ? `<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Nenhum aluno</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Nome</th><th>Matr√≠cula</th><th>Email</th><th>A√ß√µes</th></tr></thead><tbody>
                                ${data.alunos.map(a => `<tr><td><strong>${a.nome}</strong></td><td>${a.matricula || '-'}</td><td>${a.email || '-'}</td><td><button class="btn btn-sm" onclick="showAluno('${a.id}')">Ver Turmas</button> <button class="btn btn-sm btn-danger" onclick="excluirAluno('${a.id}')">üóëÔ∏è</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar alunos', 'error'); }
        }

        async function showPrompts() {
            currentView = 'prompts';
            setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: 'Prompts', onclick: 'showPrompts()'}]);
            try {
                const [promptsData, etapasData, materiasData] = await Promise.all([
                    api('/prompts'),
                    api('/prompts/etapas'),
                    api('/materias')
                ]);
                const materiaMap = materiasData.materias.reduce((acc, m) => {
                    acc[m.id] = m.nome;
                    return acc;
                }, {});

                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Prompts</h1>
                        <p class="page-subtitle">${promptsData.total} prompt(s) ativos</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Novo Prompt</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-input" id="input-prompt-nome" placeholder="Ex: Extrair gabarito - Matem√°tica">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Etapa *</label>
                            <select class="form-select" id="input-prompt-etapa">
                                ${etapasData.etapas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mat√©ria (opcional)</label>
                            <select class="form-select" id="input-prompt-materia">
                                <option value="">Global</option>
                                ${materiasData.materias.map(m => `<option value="${m.id}">${m.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" class="form-input" id="input-prompt-descricao" placeholder="Descri√ß√£o opcional">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prompt de Sistema (opcional)</label>
                            <textarea class="form-textarea" id="input-prompt-texto-sistema" placeholder="Instru√ß√µes de sistema para o modelo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prompt do Usu√°rio *</label>
                            <textarea class="form-textarea" id="input-prompt-texto" placeholder="Digite o prompt do usu√°rio aqui..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="criarPrompt()">Salvar Prompt</button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Prompts Existentes</h3>
                        </div>
                        ${promptsData.prompts.length === 0 ? `<div class="empty-state"><div class="empty-icon">üß†</div><div class="empty-title">Nenhum prompt</div></div>` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Etapa</th>
                                            <th>Mat√©ria</th>
                                            <th>Prompt de Sistema</th>
                                            <th>Prompt do Usu√°rio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${promptsData.prompts.map(p => `
                                            <tr>
                                                <td><strong>${p.nome}</strong></td>
                                                <td>${p.etapa}</td>
                                                <td>${p.materia_id ? (materiaMap[p.materia_id] || p.materia_id) : 'Global'}</td>
                                                <td title="${escapeHtml(p.texto_sistema || 'Sem prompt de sistema')}">${escapeHtml(truncateText(p.texto_sistema || '‚Äî', 80))}</td>
                                                <td title="${escapeHtml(p.texto || '')}">${escapeHtml(truncateText(p.texto || '‚Äî', 80))}</td>
                                                <td style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                    <button class="btn btn-sm" onclick="openPromptPreview('${p.id}')">Preview</button>
                                                    <button class="btn btn-sm" onclick="duplicarPrompt('${p.id}')">Duplicar</button>
                                                    <button class="btn btn-sm btn-primary" onclick="definirPromptPadrao('${p.id}')">Definir padr√£o</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            } catch (e) {
                showToast('Erro ao carregar prompts', 'error');
            }
        }

        async function showProviders() {
            currentView = 'providers';
            setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: 'Modelos de LLM', onclick: 'showProviders()'}]);
            try {
                const data = await api('/providers');
                window._providersCache = data.providers || [];
                document.getElementById('content').innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Modelos de LLM</h1>
                        <p class="page-subtitle">${data.providers.length} provider(s) dispon√≠veis</p>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Adicionar / Atualizar Provider</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Provider *</label>
                            <select class="form-select" id="input-provider-tipo">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="ollama">Ollama (Local)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome do Provider *</label>
                            <input type="text" class="form-input" id="input-provider-nome" placeholder="Ex: openai-gpt4o ou meu-provider">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo (nome do API) *</label>
                            <input type="text" class="form-input" id="input-provider-modelo" placeholder="Ex: gpt-4o, claude-sonnet-4-20250514, llama3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key (empresa)</label>
                            <input type="password" class="form-input" id="input-provider-api-key" placeholder="Opcional para OpenAI/Anthropic">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Base URL (Ollama)</label>
                            <input type="text" class="form-input" id="input-provider-base-url" placeholder="http://localhost:11434">
                        </div>
                        <button class="btn btn-primary" onclick="criarProvider()">Salvar Provider</button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Providers Existentes</h3>
                        </div>
                        ${data.providers.length === 0 ? `<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">Nenhum provider</div></div>` : `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Tipo</th>
                                            <th>Modelo</th>
                                            <th>Identificador</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.providers.map(p => `
                                            <tr>
                                                <td><strong>${p.name}</strong></td>
                                                <td>${p.provider_type}</td>
                                                <td>${p.model}</td>
                                                <td>${p.identifier}</td>
                                                <td>
                                                    <button class="btn btn-sm" onclick="editarProvider('${p.name}')">Editar</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                `;
            } catch (e) {
                showToast('Erro ao carregar providers', 'error');
            }
        }

        // ============================================================
        // CHAT GERAL
        // ============================================================
        async function showChatGeral(preselectedAtividadeId = null, preselectedAlunoId = null) {
            currentView = 'chat_geral';

            // Guardar refer√™ncia ao aluno pr√©-selecionado para uso no chat
            window._chatGeralAlunoId = preselectedAlunoId;

            // Breadcrumb din√¢mico baseado no contexto
            let breadcrumbItems = [
                {nome: 'In√≠cio', onclick: 'showDashboard()'}
            ];
            if (preselectedAtividadeId && window._atividadeData?.atividade) {
                breadcrumbItems.push({nome: window._atividadeData.atividade.nome, onclick: `showAtividade('${preselectedAtividadeId}')`});
            }
            breadcrumbItems.push({nome: 'Chat', onclick: preselectedAtividadeId ? `showChatGeral('${preselectedAtividadeId}')` : 'showChatGeral()'});
            setBreadcrumb(breadcrumbItems);

            // Carregar atividades para contexto
            let atividadesOptions = '<option value="">Sem contexto espec√≠fico</option>';
            try {
                const data = await api('/atividades');
                if (data.atividades) {
                    atividadesOptions += data.atividades.map(a =>
                        `<option value="${a.id}" ${a.id === preselectedAtividadeId ? 'selected' : ''}>${escapeHtml(a.nome)}</option>`
                    ).join('');
                }
            } catch (e) {}
            
            // Carregar modelos
            let modelsOptions = '<option value="">Selecione um modelo...</option>';
            try {
                const data = await api('/settings/models');
                chatGeralProviders = data.models || [];  // Mant√©m nome da vari√°vel para compatibilidade
                modelsOptions = chatGeralProviders.map(m =>
                    `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${getProviderIcon(m.tipo)} ${escapeHtml(m.nome)} (${m.modelo})</option>`
                ).join('');
                if (chatGeralProviders.length === 0) {
                    modelsOptions = '<option value="">Nenhum modelo configurado</option>';
                }
            } catch (e) {}
            
            document.getElementById('content').innerHTML = `
                <div class="page-header">
                    <h1 class="page-title">üí¨ Chat Geral</h1>
                    <p class="page-subtitle">Converse com a IA sobre qualquer assunto ou analise documentos</p>
                </div>
                
                <div class="chat-panel">
                    <div class="chat-panel-header">
                        <div class="chat-provider-info">
                            <span class="chat-provider-icon" id="chat-geral-icon">ü§ñ</span>
                            <span class="chat-provider-name" id="chat-geral-provider-name">Selecione um modelo</span>
                            <span class="chat-provider-model" id="chat-geral-model"></span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select class="form-select" id="chat-geral-model-select" style="width: 250px;" onchange="updateChatGeralHeader()">
                                ${modelsOptions}
                            </select>
                            <button class="btn btn-sm" onclick="limparChatGeral()" title="Limpar conversa">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="chat-context-bar">
                        <span>üìé Contexto (atividade):</span>
                        <select class="form-select" id="chat-geral-context" style="max-width: 300px;">
                            ${atividadesOptions}
                        </select>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">
                            Os documentos da atividade ser√£o anexados automaticamente
                        </span>
                    </div>
                    
                    <div class="chat-messages-container" id="chat-geral-messages">
                        <div class="chat-message assistant">
                            ${preselectedAtividadeId
                                ? `Ol√°! Estou pronto para ajudar com esta atividade.<br><br>
                                   Os documentos da atividade j√° est√£o carregados como contexto. Voc√™ pode:<br><br>
                                   ‚Ä¢ üìÑ Perguntar sobre os documentos<br>
                                   ‚Ä¢ ‚ùì Tirar d√∫vidas sobre as quest√µes<br>
                                   ‚Ä¢ ‚úÖ Discutir corre√ß√µes e respostas<br>
                                   ‚Ä¢ üìä Solicitar an√°lises e relat√≥rios<br><br>
                                   Selecione um modelo acima e comece a conversar!`
                                : `Ol√°! Sou seu assistente educacional. Posso ajudar voc√™ a:<br><br>
                                   ‚Ä¢ üìÑ Analisar documentos e provas<br>
                                   ‚Ä¢ ‚ùì Extrair e formatar quest√µes<br>
                                   ‚Ä¢ ‚úÖ Corrigir respostas de alunos<br>
                                   ‚Ä¢ üìä Gerar relat√≥rios e an√°lises<br><br>
                                   Selecione um modelo acima e comece a conversar!`}
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="form-textarea" 
                                id="chat-geral-input" 
                                placeholder="Digite sua mensagem... (Enter para enviar, Shift+Enter para nova linha)"
                                rows="1"
                            ></textarea>
                            <button class="btn btn-primary" onclick="enviarMensagemChatGeral()" id="chat-geral-send-btn">
                                Enviar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup do textarea
            const textarea = document.getElementById('chat-geral-input');
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensagemChatGeral();
                }
            });
            
            // Auto-resize do textarea
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            
            updateChatGeralHeader();
        }
        
        function getProviderIcon(tipo) {
            const icons = {
                'openai': 'üü¢',
                'anthropic': 'üü†',
                'google': 'üîµ',
                'ollama': 'ü¶ô',
                'groq': '‚ö°',
                'openrouter': 'üîÄ'
            };
            return icons[tipo] || 'ü§ñ';
        }
        
        function updateChatGeralHeader() {
            const select = document.getElementById('chat-geral-model-select');
            if (!select) return;

            const selectedId = select.value;
            const model = chatGeralProviders.find(m => m.id === selectedId);

            const iconEl = document.getElementById('chat-geral-icon');
            const nameEl = document.getElementById('chat-geral-provider-name');
            const modelEl = document.getElementById('chat-geral-model');

            if (model) {
                iconEl.textContent = getProviderIcon(model.tipo);
                nameEl.textContent = model.nome;
                modelEl.textContent = `(${model.modelo})`;
            } else {
                iconEl.textContent = 'ü§ñ';
                nameEl.textContent = 'Selecione um modelo';
                modelEl.textContent = '';
            }
        }

        async function loadChatGeralProviders() {
            try {
                const data = await api('/settings/models');
                chatGeralProviders = data.models || [];
            } catch (e) {
                chatGeralProviders = [];
            }
        }
        
        async function enviarMensagemChatGeral() {
            const input = document.getElementById('chat-geral-input');
            const mensagem = input.value.trim();
            if (!mensagem) return;

            const modelId = document.getElementById('chat-geral-model-select').value;
            if (!modelId) {
                showToast('Selecione um modelo de IA', 'error');
                return;
            }
            
            const atividadeId = document.getElementById('chat-geral-context').value;
            const container = document.getElementById('chat-geral-messages');
            const sendBtn = document.getElementById('chat-geral-send-btn');
            
            // Adicionar mensagem do usu√°rio
            container.innerHTML += `
                <div class="chat-message user">${escapeHtml(mensagem)}</div>
            `;
            input.value = '';
            input.style.height = 'auto';
            container.scrollTop = container.scrollHeight;
            
            // Indicador de digita√ß√£o
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `
                <div class="chat-message assistant" id="${typingId}">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
            sendBtn.disabled = true;
            
            try {
                // Usar endpoint de chat com documentos
                const result = await api('/chat/com-documentos', {
                    method: 'POST',
                    body: JSON.stringify({
                        mensagem: mensagem,
                        model_id: modelId,
                        atividade_id: atividadeId || null
                    })
                });
                
                // Remover indicador de digita√ß√£o
                document.getElementById(typingId)?.remove();
                
                if (result.sucesso) {
                    let html = formatChatMessage(result.resposta || 'Sem resposta');
                    
                    // Metadados
                    html += `
                        <div class="chat-message-meta">
                            <span>ü§ñ ${escapeHtml(result.provider || '')} / ${escapeHtml(result.modelo || '')}</span>
                            ${result.anexos_confirmados ? '<span>üìé Documentos processados</span>' : ''}
                        </div>
                    `;
                    
                    // Arquivos anexados
                    if (result.anexos_enviados && result.anexos_enviados.length > 0) {
                        html += `
                            <div class="chat-message-files">
                                ${result.anexos_enviados.map(a => 
                                    `<span class="chat-message-file">üìÑ ${escapeHtml(a.nome || 'arquivo')}</span>`
                                ).join('')}
                            </div>
                        `;
                    }
                    
                    container.innerHTML += `<div class="chat-message assistant">${html}</div>`;
                } else {
                    container.innerHTML += `
                        <div class="chat-message assistant" style="border-color: var(--danger);">
                            ‚ùå Erro: ${escapeHtml(result.erro || 'Erro desconhecido')}
                        </div>
                    `;
                }
                
            } catch (e) {
                document.getElementById(typingId)?.remove();
                container.innerHTML += `
                    <div class="chat-message assistant" style="border-color: var(--danger);">
                        ‚ùå Erro ao enviar mensagem: ${escapeHtml(e.message)}
                    </div>
                `;
            }
            
            sendBtn.disabled = false;
            container.scrollTop = container.scrollHeight;
        }
        
        function formatChatMessage(text) {
            if (!text) return '';

            // DEBUG
            console.log('formatChatMessage chamada, tamanho:', text.length);

            // 1. PRIMEIRO: Detectar blocos de documento
            const documentBlocks = [];
            const docRegex = /```\s*documento\s*:\s*([^\n\r]+)[\r\n]+([\s\S]*?)```/gi;
            text = text.replace(docRegex, (match, titulo, conteudo) => {
                console.log('Documento encontrado:', titulo);
                documentBlocks.push({ titulo: titulo.trim(), conteudo: conteudo.trim() });
                return `@@DOCBLOCK${documentBlocks.length - 1}@@`;
            });

            // 2. Blocos de c√≥digo normais
            const codeBlocks = [];
            text = text.replace(/```(\w*)[\r\n]+([\s\S]*?)```/g, (match, lang, code) => {
                codeBlocks.push({ lang, code });
                return `@@CODEBLOCK${codeBlocks.length - 1}@@`;
            });

            // 3. Tabelas markdown
            text = text.replace(/^\|(.+)\|\s*\n\|[-:\s|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm, (match, header, rows) => {
                const headers = header.split('|').map(h => h.trim()).filter(Boolean);
                const bodyRows = rows.trim().split('\n').map(row =>
                    row.split('|').map(c => c.trim()).filter(Boolean)
                );
                let table = '<table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:0.85rem;"><thead><tr>';
                headers.forEach(h => table += `<th style="border:1px solid var(--border);padding:8px;background:var(--bg-hover);">${h}</th>`);
                table += '</tr></thead><tbody>';
                bodyRows.forEach(row => {
                    table += '<tr>';
                    row.forEach(cell => table += `<td style="border:1px solid var(--border);padding:8px;">${cell}</td>`);
                    table += '</tr>';
                });
                table += '</tbody></table>';
                return table;
            });

            // 4. T√≠tulos
            text = text.replace(/^######\s+(.+)$/gm, '<h6 style="margin:10px 0 6px;font-size:0.9rem;">$1</h6>');
            text = text.replace(/^#####\s+(.+)$/gm, '<h5 style="margin:10px 0 6px;font-size:0.95rem;">$1</h5>');
            text = text.replace(/^####\s+(.+)$/gm, '<h4 style="margin:12px 0 8px;font-size:1rem;">$1</h4>');
            text = text.replace(/^###\s+(.+)$/gm, '<h3 style="margin:14px 0 8px;font-size:1.1rem;">$1</h3>');
            text = text.replace(/^##\s+(.+)$/gm, '<h2 style="margin:16px 0 10px;font-size:1.25rem;">$1</h2>');
            text = text.replace(/^#\s+(.+)$/gm, '<h1 style="margin:18px 0 12px;font-size:1.4rem;border-bottom:2px solid var(--primary);padding-bottom:6px;">$1</h1>');

            // 5. Linha horizontal
            text = text.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">');

            // 6. Blockquotes
            text = text.replace(/^>\s+(.+)$/gm, '<blockquote style="border-left:4px solid var(--primary);padding:8px 16px;margin:12px 0;background:rgba(59,130,246,0.1);font-style:italic;">$1</blockquote>');

            // 7. Listas n√£o ordenadas
            text = text.replace(/^[\*\-]\s+(.+)$/gm, '<li style="margin:4px 0;">$1</li>');
            text = text.replace(/(<li[^>]*>.*<\/li>\n?)+/g, '<ul style="margin:10px 0;padding-left:24px;">$&</ul>');

            // 8. Links
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--primary);">$1</a>');

            // 9. Negrito e it√°lico
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // 10. C√≥digo inline
            text = text.replace(/`([^`]+)`/g, '<code style="background:var(--bg-hover);padding:2px 6px;border-radius:4px;">$1</code>');

            // 11. Quebras de linha
            text = text.replace(/\n(?!<)/g, '<br>');
            text = text.replace(/(<\/h[1-6]>|<\/ul>|<\/table>|<\/blockquote>|<hr[^>]*>)<br>/g, '$1');

            // 12. Restaurar blocos de c√≥digo
            codeBlocks.forEach((block, i) => {
                const escaped = block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                text = text.replace(`@@CODEBLOCK${i}@@`, `<pre style="background:var(--bg-hover);padding:12px;border-radius:6px;overflow-x:auto;margin:8px 0;"><code>${escaped}</code></pre>`);
            });

            // 13. Restaurar blocos de documento
            documentBlocks.forEach((block, i) => {
                const docId = `doc_${Date.now()}_${i}`;
                window._documentContents = window._documentContents || {};
                window._documentContents[docId] = block;

                text = text.replace(`@@DOCBLOCK${i}@@`,
                    `<div style="background:linear-gradient(135deg,var(--bg-hover),var(--bg-card));border:2px solid var(--primary);border-radius:12px;padding:16px;margin:12px 0;">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                            <span style="font-size:1.5rem;">üìÑ</span>
                            <span style="font-weight:600;">${block.titulo.replace(/</g, '&lt;')}</span>
                        </div>
                        <button onclick="abrirDocumentoGerado('${docId}')" style="background:var(--primary);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:500;">
                            Abrir Documento
                        </button>
                    </div>`
                );
            });

            return text;
        }

        // Fun√ß√£o para abrir documento gerado
        function abrirDocumentoGerado(docId) {
            const docData = window._documentContents?.[docId];
            if (!docData) {
                alert('Documento n√£o encontrado');
                return;
            }

            const htmlContent = convertMarkdownParaHtml(docData.conteudo);
            const htmlCompleto = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>${docData.titulo.replace(/</g, '&lt;')} - Prova AI</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: #1f2937; background: #f9fafb; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #3b82f6; }
        .header h1 { color: #1e40af; font-size: 1.8rem; }
        h1 { font-size: 1.5rem; color: #1e40af; margin: 20px 0 12px; border-bottom: 2px solid #3b82f6; padding-bottom: 6px; }
        h2 { font-size: 1.3rem; color: #1e3a8a; margin: 18px 0 10px; }
        h3 { font-size: 1.1rem; margin: 14px 0 8px; }
        table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        th, td { border: 1px solid #d1d5db; padding: 10px; text-align: left; }
        th { background: #f3f4f6; }
        blockquote { border-left: 4px solid #3b82f6; padding: 12px 20px; margin: 16px 0; background: #eff6ff; font-style: italic; }
        ul, ol { margin: 12px 0; padding-left: 28px; }
        li { margin: 6px 0; }
        hr { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
        pre { background: #1f2937; color: #f9fafb; padding: 14px; border-radius: 6px; overflow-x: auto; }
        code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        pre code { background: none; padding: 0; }
        .print-bar { position: fixed; top: 0; left: 0; right: 0; background: #1e40af; color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .print-bar button { background: white; color: #1e40af; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        body { padding-top: 60px; }
        .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 0.85rem; }
        @media print { .print-bar { display: none !important; } body { padding: 0; background: white; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="print-bar">
        <span>${docData.titulo.replace(/</g, '&lt;')}</span>
        <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>
    <div class="container">
        <div class="header">
            <h1>${docData.titulo.replace(/</g, '&lt;')}</h1>
            <div style="color:#6b7280;font-size:0.9rem;">Gerado em ${new Date().toLocaleDateString('pt-BR')}</div>
        </div>
        <div class="content">${htmlContent}</div>
        <div class="footer">Documento gerado por Prova AI</div>
    </div>
</body>
</html>`;

            const novaJanela = window.open('', '_blank');
            if (novaJanela) {
                novaJanela.document.write(htmlCompleto);
                novaJanela.document.close();
            } else {
                alert('Popup bloqueado! Permita popups para este site.');
            }
        }

        function convertMarkdownParaHtml(md) {
            if (!md) return '';
            let html = md;
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => `<pre><code>${code.replace(/</g, '&lt;')}</code></pre>`);
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            html = html.replace(/^---+$/gm, '<hr>');
            html = html.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
            html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            html = html.replace(/^\|(.+)\|\s*\n\|[-:\s|]+\|\s*\n((?:\|.+\|\s*\n?)+)/gm, (m, hdr, rows) => {
                const hs = hdr.split('|').map(h => h.trim()).filter(Boolean);
                const rs = rows.trim().split('\n').map(r => r.split('|').map(c => c.trim()).filter(Boolean));
                let t = '<table><thead><tr>' + hs.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
                rs.forEach(r => { t += '<tr>' + r.map(c => `<td>${c}</td>`).join('') + '</tr>'; });
                return t + '</tbody></table>';
            });
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }
        
        function limparChatGeral() {
            if (!confirm('Limpar toda a conversa?')) return;
            chatGeralConversationId = 'chat_' + Date.now();
            const container = document.getElementById('chat-geral-messages');
            if (container) {
                container.innerHTML = `
                    <div class="chat-message assistant">
                        Conversa limpa! Como posso ajudar?
                    </div>
                `;
            }
        }
        
        async function showAluno(alunoId) {
            try {
                const data = await api(`/alunos/${alunoId}`);
                setBreadcrumb([{nome: 'In√≠cio', onclick: 'showDashboard()'}, {nome: 'Alunos', onclick: 'showAlunos()'}, {nome: data.aluno.nome, onclick: `showAluno('${alunoId}')`}]);
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">${data.aluno.nome}</h1><p class="page-subtitle">Matr√≠cula: ${data.aluno.matricula || 'N√£o informada'}</p></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="showDashboardAluno('${alunoId}')">üìä Dashboard do Aluno</button>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Turmas do Aluno (${data.total_turmas})</h3></div>
                        ${data.turmas.length === 0 ? `<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Nenhuma turma</div></div>` : `
                            <div class="table-container"><table><thead><tr><th>Mat√©ria</th><th>Turma</th><th>Ano</th><th>A√ß√µes</th></tr></thead><tbody>
                                ${data.turmas.map(t => `<tr><td><strong>${t.materia_nome}</strong></td><td>${t.nome}</td><td>${t.ano_letivo || '-'}</td><td><button class="btn btn-sm" onclick="showTurma('${t.id}')">Ver Turma</button></td></tr>`).join('')}
                            </tbody></table></div>
                        `}
                    </div>
                `;
            } catch (e) { showToast('Erro ao carregar aluno', 'error'); }
        }
        
        // ============================================================
        // BREADCRUMB
        // ============================================================
        function setBreadcrumb(items) {
            document.getElementById('breadcrumb').innerHTML = items.map((item, i) => `<span class="breadcrumb-item ${i === items.length - 1 ? 'current' : ''}" onclick="${item.onclick}">${item.nome}</span>${i < items.length - 1 ? '<span class="breadcrumb-sep">/</span>' : ''}`).join('');
        }
        
        // ============================================================
        // MODAIS
        // ============================================================
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openModalTurma(materiaId) { document.getElementById('input-turma-materia-id').value = materiaId; openModal('modal-turma'); }
        function openModalAtividade(turmaId) { document.getElementById('input-ativ-turma-id').value = turmaId; openModal('modal-atividade'); }
        // ============================================================
        // MODAL ALUNO - Sele√ß√£o e Cria√ß√£o
        // ============================================================

        let todosAlunos = [];  // Cache de todos os alunos para filtragem
        let alunosDisponiveis = [];  // Alunos que n√£o est√£o na turma atual
        let alunoSelecionadoId = null;
        let alunoTabAtual = 'selecionar';

        async function openModalAluno(turmaId) {
            document.getElementById('input-aluno-turma-id').value = turmaId || '';
            document.getElementById('input-aluno-selecionado-id').value = '';
            document.getElementById('input-busca-aluno').value = '';
            document.getElementById('input-aluno-nome').value = '';
            document.getElementById('input-aluno-matricula').value = '';
            document.getElementById('input-aluno-email').value = '';
            alunoSelecionadoId = null;

            // Reset to first tab
            switchAlunoTab('selecionar');

            // Load students for selection
            await carregarAlunosParaSelecao(turmaId);

            openModal('modal-aluno');
        }

        function switchAlunoTab(tab) {
            alunoTabAtual = tab;
            const tabSelecionar = document.getElementById('tab-selecionar-aluno');
            const tabCriar = document.getElementById('tab-criar-aluno');
            const btnSelecionar = document.getElementById('tab-btn-selecionar');
            const btnCriar = document.getElementById('tab-btn-criar');
            const btnConfirmar = document.getElementById('btn-confirmar-aluno');

            if (tab === 'selecionar') {
                tabSelecionar.style.display = 'block';
                tabCriar.style.display = 'none';
                btnSelecionar.classList.add('active');
                btnCriar.classList.remove('active');
                btnConfirmar.textContent = 'Adicionar';
            } else {
                tabSelecionar.style.display = 'none';
                tabCriar.style.display = 'block';
                btnSelecionar.classList.remove('active');
                btnCriar.classList.add('active');
                btnConfirmar.textContent = 'Criar e Adicionar';
            }
        }

        async function carregarAlunosParaSelecao(turmaId) {
            const listaEl = document.getElementById('lista-alunos');
            listaEl.innerHTML = '<div class="aluno-list-empty">Carregando...</div>';

            try {
                // Get all students
                const resultAll = await api('/alunos');
                todosAlunos = resultAll.alunos || [];

                // Get students already in this class
                let alunosNaTurma = [];
                if (turmaId) {
                    const resultTurma = await api(`/alunos?turma_id=${turmaId}`);
                    alunosNaTurma = resultTurma.alunos || [];
                }

                // Filter: show only students NOT in the class
                const idsNaTurma = new Set(alunosNaTurma.map(a => a.id));
                alunosDisponiveis = todosAlunos.filter(a => !idsNaTurma.has(a.id));

                // Sort alphabetically
                alunosDisponiveis.sort((a, b) => a.nome.localeCompare(b.nome));

                renderizarListaAlunos(alunosDisponiveis);
            } catch (e) {
                listaEl.innerHTML = '<div class="aluno-list-empty">Erro ao carregar alunos</div>';
            }
        }

        function renderizarListaAlunos(alunos) {
            const listaEl = document.getElementById('lista-alunos');

            if (alunos.length === 0) {
                listaEl.innerHTML = '<div class="aluno-list-empty">Nenhum aluno dispon√≠vel. Crie um novo na aba "Criar Novo".</div>';
                return;
            }

            listaEl.innerHTML = alunos.map(aluno => {
                const detalhes = [aluno.matricula, aluno.email].filter(Boolean).join(' ‚Ä¢ ');
                const isSelected = alunoSelecionadoId === aluno.id;
                return `
                    <div class="aluno-item ${isSelected ? 'selected' : ''}" onclick="selecionarAluno('${aluno.id}')">
                        <div class="aluno-item-info">
                            <div class="aluno-item-nome">${aluno.nome}</div>
                            ${detalhes ? `<div class="aluno-item-detalhes">${detalhes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarAlunos() {
            const busca = document.getElementById('input-busca-aluno').value.toLowerCase().trim();

            if (!busca) {
                renderizarListaAlunos(alunosDisponiveis);
                return;
            }

            const filtrados = alunosDisponiveis.filter(aluno =>
                aluno.nome.toLowerCase().includes(busca) ||
                (aluno.matricula && aluno.matricula.toLowerCase().includes(busca)) ||
                (aluno.email && aluno.email.toLowerCase().includes(busca))
            );

            renderizarListaAlunos(filtrados);
        }

        function selecionarAluno(alunoId) {
            alunoSelecionadoId = alunoId;
            document.getElementById('input-aluno-selecionado-id').value = alunoId;

            // Re-render to show selection
            const busca = document.getElementById('input-busca-aluno').value.toLowerCase().trim();
            if (busca) {
                filtrarAlunos();
            } else {
                renderizarListaAlunos(alunosDisponiveis);
            }
        }

        async function confirmarAluno() {
            const turmaId = document.getElementById('input-aluno-turma-id').value;

            if (alunoTabAtual === 'selecionar') {
                // Tab: Select existing student
                if (!alunoSelecionadoId) {
                    showToast('Selecione um aluno da lista', 'error');
                    return;
                }

                try {
                    await api('/alunos/vincular', {
                        method: 'POST',
                        body: JSON.stringify({ aluno_id: alunoSelecionadoId, turma_id: turmaId })
                    });
                    showToast('Aluno adicionado √† turma!', 'success');
                    closeModal('modal-aluno');
                    if (turmaId) showTurma(turmaId); else showAlunos();
                } catch (e) {
                    showToast(e.message || 'Erro ao adicionar aluno', 'error');
                }
            } else {
                // Tab: Create new student
                await criarAluno();
            }
        }

        function openModalImportarCsv(turmaId) { document.getElementById('input-importar-turma-id').value = turmaId || ''; openModal('modal-importar-csv'); }

        function openDocumento(documentoId) {
            if (!documentoId) return;
            window.open(`${API}/documentos/${documentoId}/download`, '_blank');
        }



        async function downloadDocumento(documentoId) {
            if (!documentoId) return;
            try {
                const response = await fetch(`${API}/documentos/${documentoId}/download`);
                if (!response.ok) throw new Error('Erro ao baixar');
                
                const blob = await response.blob();
                const contentDisposition = response.headers.get('content-disposition');
                let filename = 'documento';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?(.+)"?/);
                    if (match) filename = match[1];
                }
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (e) {
                showToast('Erro ao baixar documento', 'error');
            }
        }

        async function visualizarDocumento(documentoId) {
            if (!documentoId) return;
            try {
                const data = await api(`/documentos/${documentoId}/conteudo`);
                const doc = data.documento || {};
                const titulo = doc.nome_arquivo ? `Visualizar: ${doc.nome_arquivo}` : 'Visualizar Documento';
                document.getElementById('titulo-documento-conteudo').textContent = titulo;
                const meta = [];
                if (doc.tipo) meta.push(`Tipo: ${doc.tipo}`);
                if (doc.ia_provider) meta.push(`IA: ${doc.ia_provider}`);
                if (doc.ia_modelo) meta.push(`Modelo: ${doc.ia_modelo}`);
                if (doc.prompt_usado) meta.push(`Prompt: ${doc.prompt_usado}`);
                if (doc.criado_em) meta.push(`Criado em: ${formatDateTime(doc.criado_em)}`);
                document.getElementById('documento-conteudo-meta').textContent = meta.join(' ‚Ä¢ ');

                const output = document.getElementById('output-documento-conteudo');
                if (data.pode_visualizar) {
                    const content = data.tipo_conteudo === 'json'
                        ? JSON.stringify(data.conteudo, null, 2)
                        : (data.conteudo || '');
                    output.textContent = content;
                    openModal('modal-documento-conteudo');
                } else {
                    showToast('Documento n√£o possui visualiza√ß√£o. Fa√ßa o download para ver.', 'warning');
                    openDocumento(documentoId);
                }
            } catch (e) {}
        }

        async function deleteDocumento(documentoId) {
            if (!documentoId) return;
            if (!confirm('Deseja excluir este documento? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            try {
                await api(`/documentos/${documentoId}`, { method: 'DELETE' });
                showToast('Documento exclu√≠do', 'success');
                refreshCurrentView();
            } catch (e) {}
        }

        function refreshCurrentView() {
            if (currentView === 'atividade' && currentAtividade) {
                showAtividade(currentAtividade);
                return;
            }
            if (currentView === 'resultado_aluno' && currentAtividade && currentAluno) {
                showResultadoAluno(currentAtividade, currentAluno);
                return;
            }
            if (currentView === 'turma' && currentTurma) {
                showTurma(currentTurma);
                return;
            }
            if (currentView === 'alunos') {
                showAlunos();
            }
        }

        async function ensureAtividadeData(atividadeId) {
            if (!atividadeId) return null;
            if (!window._atividadeData || window._atividadeData?.atividade?.id !== atividadeId) {
                try {
                    window._atividadeData = await api(`/atividades/${atividadeId}`);
                } catch (e) {
                    window._atividadeData = null;
                }
            }
            return window._atividadeData;
        }

        function renderAlunoOptions(alunos = [], includeEmpty = false) {
            const options = alunos.map(a => {
                const label = a.aluno_nome
                    ? `${a.aluno_nome}${a.aluno_id ? ` ‚Ä¢ ${a.aluno_id}` : ''}`
                    : (a.aluno_id || 'Aluno');
                return `<option value="${a.aluno_id}">${label}</option>`;
            });
            if (includeEmpty) {
                options.unshift('<option value="">Sem aluno</option>');
            }
            return options.join('');
        }

        function openModalUploadProvas(atividadeId) {
            document.getElementById('input-upload-provas-atividade-id').value = atividadeId;
            openModal('modal-upload-provas');
        }

        async function openModalExecucao(atividadeId) {
            document.getElementById('input-execucao-atividade-id').value = atividadeId;
            await ensureAtividadeData(atividadeId);
            await carregarEtapasExecucao();
            await carregarProvidersExecucao();
            carregarAlunosExecucao();
            openModal('modal-execucao');
        }

        async function openModalPipelineCompleto(atividadeId, modo = 'aluno') {
            try {
                document.getElementById('input-pipeline-atividade-id').value = atividadeId;
                await ensureAtividadeData(atividadeId);
                await carregarPipelineAlunos();
                await carregarPipelineProviders();

                // Definir modo e atualizar UI
                document.querySelector(`input[name="pipeline-modo"][value="${modo}"]`).checked = true;
                onPipelineModoChange();

                // Calcular resumo da turma
                const atividadeData = window._atividadeData;
                const alunosDetalhes = atividadeData?.alunos?.detalhes || [];
                const alunosComProva = alunosDetalhes.filter(a => a.tem_prova);
                document.getElementById('pipeline-turma-resumo').innerHTML = `<strong>${alunosComProva.length}</strong> aluno(s) com prova enviada`;

                openModal('modal-pipeline-completo');
            } catch (e) {
                console.error('Erro ao abrir modal pipeline:', e);
                showToast('Erro ao carregar dados do pipeline', 'error');
            }
        }
        
        async function openModalUpload(atividadeId, modo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            resetUploadReplace();
            const grupoAluno = document.getElementById('grupo-aluno-upload');
            const selectTipo = document.getElementById('input-upload-tipo');
            if (modo === 'aluno') {
                selectTipo.value = 'prova_respondida';
                grupoAluno.style.display = 'block';
                await ensureAtividadeData(atividadeId);
                carregarAlunosParaUpload();
            } else {
                selectTipo.value = 'enunciado';
                grupoAluno.style.display = 'none';
            }
            openModal('modal-upload');
        }
        
        async function openModalUploadTipo(atividadeId, tipo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('grupo-aluno-upload').style.display = 'none';
            await ensureAtividadeData(atividadeId);
            openModal('modal-upload');
        }

        async function openModalUploadAlunoTipo(atividadeId, alunoId, tipo) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('grupo-aluno-upload').style.display = 'block';
            await ensureAtividadeData(atividadeId);
            carregarAlunosParaUpload();
            const selectAluno = document.getElementById('input-upload-aluno');
            if (selectAluno) {
                selectAluno.value = alunoId || '';
            }
            openModal('modal-upload');
        }

        async function openModalUploadSubstituir(atividadeId, tipo, alunoId, documentoId) {
            document.getElementById('input-upload-atividade-id').value = atividadeId;
            document.getElementById('input-upload-tipo').value = tipo;
            document.getElementById('input-upload-documento-id').value = documentoId || '';
            const replaceInfo = document.getElementById('upload-replace-info');
            replaceInfo.textContent = 'Substituir documento selecionado: o novo upload excluir√° o arquivo anterior. Tipo e aluno ficam bloqueados.';
            replaceInfo.style.display = 'block';
            const selectTipo = document.getElementById('input-upload-tipo');
            const selectAluno = document.getElementById('input-upload-aluno');
            selectTipo.disabled = true;
            selectAluno.disabled = true;
            if ((window._documentosBase || []).includes(tipo)) {
                document.getElementById('grupo-aluno-upload').style.display = 'none';
            } else {
                document.getElementById('grupo-aluno-upload').style.display = 'block';
                if (!window._atividadeData || window._atividadeData?.atividade?.id !== atividadeId) {
                    try {
                        window._atividadeData = await api(`/atividades/${atividadeId}`);
                    } catch (e) {}
                }
                carregarAlunosParaUpload();
                if (selectAluno) {
                    selectAluno.value = alunoId || '';
                }
            }
            openModal('modal-upload');
        }

        function resetUploadReplace() {
            // Limpar estado de substitui√ß√£o
            document.getElementById('input-upload-documento-id').value = '';
            document.getElementById('upload-replace-info').style.display = 'none';
            document.getElementById('upload-replace-info').textContent = '';
            // Reabilitar selects
            document.getElementById('input-upload-tipo').disabled = false;
            const selectAluno = document.getElementById('input-upload-aluno');
            if (selectAluno) selectAluno.disabled = false;
        }

        function carregarAlunosParaUpload() {
            const data = window._atividadeData;
            const select = document.getElementById('input-upload-aluno');
            if (data) {
                select.innerHTML = renderAlunoOptions(data.alunos?.detalhes || []);
            } else if (select) {
                select.innerHTML = '<option value="">Nenhum aluno encontrado</option>';
            }
        }

        function carregarAlunosExecucao() {
            const data = window._atividadeData;
            const select = document.getElementById('input-execucao-aluno');
            if (!select) return;
            if (data && data.alunos?.detalhes) {
                select.innerHTML = renderAlunoOptions(data.alunos.detalhes, true);
            } else {
                select.innerHTML = `<option value="">Sem aluno</option>`;
            }
        }

        async function carregarEtapasExecucao() {
            try {
                const data = await api('/prompts/etapas');
                const select = document.getElementById('input-execucao-etapa');
                select.innerHTML = data.etapas.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
                window._etapasData = data.etapas;
                // Atualizar prompts para etapa selecionada
                onEtapaChange();
            } catch (e) {
                console.error('Erro ao carregar etapas:', e);
            }
        }

        // Etapas que n√£o precisam de aluno
        const ETAPAS_SEM_ALUNO = ['extrair_questoes', 'extrair_gabarito'];

        async function onEtapaChange() {
            const etapa = document.getElementById('input-execucao-etapa').value;
            const hint = document.getElementById('input-execucao-aluno-hint');

            // Atualizar hint do aluno
            if (ETAPAS_SEM_ALUNO.includes(etapa)) {
                hint.textContent = 'Esta etapa extrai dados da atividade, n√£o precisa de aluno.';
            } else {
                hint.textContent = 'Selecione o aluno para executar esta etapa.';
            }

            // Carregar prompts para esta etapa
            await carregarPromptsEtapa(etapa);
        }

        async function carregarPromptsEtapa(etapa) {
            const select = document.getElementById('input-execucao-prompt');
            try {
                const data = await api(`/prompts?etapa=${etapa}`);
                const prompts = data.prompts || [];
                window._promptsEtapa = prompts;

                select.innerHTML = '<option value="">Usar prompt padr√£o</option>' +
                    prompts.map(p => `<option value="${p.id}">${p.nome}${p.is_padrao ? ' (Padr√£o)' : ''}</option>`).join('');

                // Mostrar op√ß√£o de editar
                document.getElementById('grupo-prompt-customizado').style.display = 'block';
                document.getElementById('input-execucao-editar-prompt').checked = false;
                document.getElementById('grupo-prompt-texto').style.display = 'none';
            } catch (e) {
                select.innerHTML = '<option value="">Usar prompt padr√£o</option>';
                console.error('Erro ao carregar prompts:', e);
            }
        }

        async function onPromptChange() {
            const promptId = document.getElementById('input-execucao-prompt').value;
            if (!promptId) {
                document.getElementById('input-execucao-prompt-texto').value = '';
                return;
            }

            // Buscar texto do prompt selecionado
            const prompts = window._promptsEtapa || [];
            const prompt = prompts.find(p => p.id === promptId);
            if (prompt) {
                document.getElementById('input-execucao-prompt-texto').value = prompt.texto || '';
            }
        }

        function toggleEditarPrompt() {
            const editando = document.getElementById('input-execucao-editar-prompt').checked;
            document.getElementById('grupo-prompt-texto').style.display = editando ? 'block' : 'none';

            // Se habilitou edi√ß√£o, carregar texto do prompt selecionado
            if (editando) {
                onPromptChange();
            }
        }

        async function carregarProvidersExecucao() {
            try {
                const data = await api('/settings/models').catch(() => ({ models: [] }));
                const models = data.models || [];
                const options = models.map(m => `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)} (${m.modelo})</option>`).join('');
                document.getElementById('input-execucao-model').innerHTML = options || '<option value="">Nenhum modelo configurado</option>';
            } catch (e) {}
        }

        async function carregarPipelineAlunos() {
            const data = window._atividadeData;
            const select = document.getElementById('input-pipeline-aluno');
            if (!select) return;

            const detalhes = data?.alunos?.detalhes || [];
            // Filtrar apenas alunos com prova para o pipeline
            const alunosComProva = detalhes.filter(a => a.tem_prova);

            if (alunosComProva.length > 0) {
                select.innerHTML = alunosComProva.map(a =>
                    `<option value="${a.aluno_id}">${a.aluno_nome || a.aluno_id}</option>`
                ).join('');
            } else if (detalhes.length > 0) {
                // Se n√£o tem ningu√©m com prova, mostrar todos
                select.innerHTML = detalhes.map(a =>
                    `<option value="${a.aluno_id}">${a.aluno_nome || a.aluno_id}</option>`
                ).join('');
            } else {
                select.innerHTML = '<option value="">Nenhum aluno na turma</option>';
            }
        }

        async function carregarPipelineProviders() {
            try {
                const [etapasData, modelsData] = await Promise.all([
                    api('/prompts/etapas'),
                    api('/settings/models').catch(() => ({ models: [] }))
                ]);

                const models = modelsData.models || [];
                const defaultModel = models.find(m => m.is_default)?.id || '';
                const modelOptions = models.map(m => `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)} (${m.modelo})</option>`).join('');

                const defaultSelect = document.getElementById('input-pipeline-provider-default');
                if (defaultSelect) {
                    defaultSelect.innerHTML = modelOptions || '<option value="">Nenhum modelo configurado</option>';
                    if (defaultModel) {
                        defaultSelect.value = defaultModel;
                    }
                }

                const etapasPermitidas = [
                    'extrair_questoes',
                    'extrair_gabarito',
                    'extrair_respostas',
                    'corrigir',
                    'analisar_habilidades',
                    'gerar_relatorio'
                ];
                const etapas = (etapasData.etapas || []).filter(e => etapasPermitidas.includes(e.id));
                const container = document.getElementById('pipeline-provider-stages');
                if (container) {
                    container.innerHTML = etapas.map(etapa => `
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <div style="flex: 1; font-size: 0.85rem; color: var(--text-muted);">${etapa.nome}</div>
                            <select class="form-select" data-etapa="${etapa.id}" style="flex: 1;">
                                <option value="">Usar padr√£o</option>
                                ${modelOptions}
                            </select>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Erro ao carregar modelos:', e);
            }
        }
        
        // ============================================================
        // CRUD OPERATIONS
        // ============================================================
        async function criarMateria() {
            const nome = document.getElementById('input-materia-nome').value.trim();
            const descricao = document.getElementById('input-materia-desc').value.trim();
            const nivel = document.getElementById('input-materia-nivel').value;
            if (!nome) { showToast('Digite o nome da mat√©ria', 'error'); return; }
            try {
                await api('/materias', { method: 'POST', body: JSON.stringify({ nome, descricao, nivel }) });
                showToast('Mat√©ria criada!', 'success');
                closeModal('modal-materia');
                document.getElementById('input-materia-nome').value = '';
                document.getElementById('input-materia-desc').value = '';
                loadNavTree();
                showDashboard();
            } catch (e) {}
        }
        
        async function criarTurma() {
            const nome = document.getElementById('input-turma-nome').value.trim();
            const anoLetivo = document.getElementById('input-turma-ano').value;
            const periodo = document.getElementById('input-turma-periodo').value.trim();
            const materiaId = document.getElementById('input-turma-materia-id').value;
            if (!nome) { showToast('Digite o nome da turma', 'error'); return; }
            try {
                await api('/turmas', { method: 'POST', body: JSON.stringify({ materia_id: materiaId, nome, ano_letivo: anoLetivo ? parseInt(anoLetivo) : null, periodo: periodo || null }) });
                showToast('Turma criada!', 'success');
                closeModal('modal-turma');
                document.getElementById('input-turma-nome').value = '';
                loadNavTree();
                showMateria(materiaId);
            } catch (e) {}
        }
        
        async function criarAtividade() {
            const nome = document.getElementById('input-ativ-nome').value.trim();
            const tipo = document.getElementById('input-ativ-tipo').value;
            const notaMaxima = document.getElementById('input-ativ-nota').value;
            const turmaId = document.getElementById('input-ativ-turma-id').value;
            if (!nome) { showToast('Digite o nome da atividade', 'error'); return; }
            try {
                await api('/atividades', { method: 'POST', body: JSON.stringify({ turma_id: turmaId, nome, tipo, nota_maxima: parseFloat(notaMaxima) || 10 }) });
                showToast('Atividade criada!', 'success');
                closeModal('modal-atividade');
                document.getElementById('input-ativ-nome').value = '';
                loadNavTree();
                showTurma(turmaId);
            } catch (e) {}
        }
        
        async function criarAluno() {
            const nome = document.getElementById('input-aluno-nome').value.trim();
            const matricula = document.getElementById('input-aluno-matricula').value.trim();
            const email = document.getElementById('input-aluno-email').value.trim();
            const turmaId = document.getElementById('input-aluno-turma-id').value;
            if (!nome) { showToast('Digite o nome do aluno', 'error'); return; }
            try {
                const result = await api('/alunos', { method: 'POST', body: JSON.stringify({ nome, matricula: matricula || null, email: email || null }) });
                if (turmaId && result.aluno) {
                    await api('/alunos/vincular', { method: 'POST', body: JSON.stringify({ aluno_id: result.aluno.id, turma_id: turmaId }) });
                }
                showToast('Aluno criado!', 'success');
                closeModal('modal-aluno');
                document.getElementById('input-aluno-nome').value = '';
                document.getElementById('input-aluno-matricula').value = '';
                document.getElementById('input-aluno-email').value = '';
                if (turmaId) showTurma(turmaId); else showAlunos();
            } catch (e) {}
        }

        async function excluirMateria(id) {
            if (!confirm('Excluir mat√©ria e todas as turmas/atividades relacionadas?')) return;
            try {
                await api(`/materias/${id}`, { method: 'DELETE' });
                showToast('Mat√©ria exclu√≠da!', 'success');
                loadNavTree();
                showDashboard();
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function excluirTurma(id) {
            if (!confirm('Excluir turma e todas as atividades relacionadas?')) return;
            try {
                await api(`/turmas/${id}`, { method: 'DELETE' });
                showToast('Turma exclu√≠da!', 'success');
                loadNavTree();
                showMateria(currentMateria);
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function excluirAluno(id) {
            if (!confirm('Excluir aluno?')) return;
            try {
                await api(`/alunos/${id}`, { method: 'DELETE' });
                showToast('Aluno exclu√≠do!', 'success');
                if (currentTurma) showTurma(currentTurma);
                else if (currentView === 'alunos') showAlunos();
                else showDashboard();
            } catch (e) { showToast(e.message || 'Erro ao excluir', 'error'); }
        }

        async function criarProvider() {
            const providerType = document.getElementById('input-provider-tipo')?.value;
            const name = document.getElementById('input-provider-nome')?.value.trim();
            const model = document.getElementById('input-provider-modelo')?.value.trim();
            const apiKey = document.getElementById('input-provider-api-key')?.value.trim();
            const baseUrl = document.getElementById('input-provider-base-url')?.value.trim();
            if (!providerType || !name || !model) {
                showToast('Preencha tipo, nome e modelo do provider', 'error');
                return;
            }
            try {
                await api('/providers', {
                    method: 'POST',
                    body: JSON.stringify({
                        name,
                        provider_type: providerType,
                        model,
                        api_key: apiKey || null,
                        base_url: baseUrl || null
                    })
                });
                showToast('Provider salvo!', 'success');
                showProviders();
                carregarProvidersExecucao();
            } catch (e) {
                showToast('Erro ao salvar provider', 'error');
            }
        }

        function editarProvider(providerName) {
            const provider = (window._providersCache || []).find(p => p.name === providerName);
            if (!provider) {
                showToast('Provider n√£o encontrado', 'error');
                return;
            }
            document.getElementById('input-provider-tipo').value = provider.provider_type;
            document.getElementById('input-provider-nome').value = provider.name;
            document.getElementById('input-provider-modelo').value = provider.model;
            document.getElementById('input-provider-api-key').value = '';
            document.getElementById('input-provider-base-url').value = '';
            showToast('Atualize os campos e salve o provider', 'success');
        }

        async function criarPrompt() {
            const nome = document.getElementById('input-prompt-nome').value.trim();
            const etapa = document.getElementById('input-prompt-etapa').value;
            const materiaId = document.getElementById('input-prompt-materia').value;
            const descricao = document.getElementById('input-prompt-descricao').value.trim();
            const textoSistema = document.getElementById('input-prompt-texto-sistema').value.trim();
            const texto = document.getElementById('input-prompt-texto').value.trim();
            if (!nome || !texto) { showToast('Preencha nome e texto do prompt', 'error'); return; }
            try {
                await api('/prompts', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome,
                        etapa,
                        texto,
                        texto_sistema: textoSistema || null,
                        descricao: descricao || null,
                        materia_id: materiaId || null
                    })
                });
                showToast('Prompt criado!', 'success');
                showPrompts();
            } catch (e) {}
        }

        async function duplicarPrompt(promptId) {
            const novoNome = prompt('Nome do novo prompt');
            if (!novoNome) return;
            try {
                const formData = new FormData();
                formData.append('novo_nome', novoNome);
                await apiForm(`/prompts/${promptId}/duplicar`, formData);
                showToast('Prompt duplicado!', 'success');
                showPrompts();
            } catch (e) {}
        }

        async function definirPromptPadrao(promptId) {
            try {
                const formData = new FormData();
                await apiForm(`/prompts/${promptId}/definir-padrao`, formData);
                showToast('Prompt definido como padr√£o', 'success');
            } catch (e) {}
        }

        function openPromptPreview(promptId) {
            document.getElementById('input-prompt-id').value = promptId;
            document.getElementById('output-prompt-preview-sistema').value = '';
            document.getElementById('output-prompt-preview').value = '';
            openModal('modal-prompt-preview');
        }

        async function renderPrompt() {
            const promptId = document.getElementById('input-prompt-id').value;
            const variaveisRaw = document.getElementById('input-prompt-variaveis').value.trim();
            let variaveis = {};
            if (variaveisRaw) {
                try {
                    variaveis = JSON.parse(variaveisRaw);
                } catch (e) {
                    showToast('JSON inv√°lido', 'error');
                    return;
                }
            }
            try {
                const data = await api('/prompts/render', {
                    method: 'POST',
                    body: JSON.stringify({ prompt_id: promptId, variaveis })
                });
                document.getElementById('output-prompt-preview-sistema').value = data.texto_sistema_renderizado || '';
                document.getElementById('output-prompt-preview').value = data.texto_renderizado || '';
            } catch (e) {}
        }
        
        async function uploadDocumento() {
            const tipo = document.getElementById('input-upload-tipo').value;
            const atividadeId = document.getElementById('input-upload-atividade-id').value;
            const fileInput = document.getElementById('input-upload-file');
            const alunoId = document.getElementById('input-upload-aluno').value;
            const replaceId = document.getElementById('input-upload-documento-id').value;
            if (!fileInput.files.length) { showToast('Selecione ao menos um arquivo', 'error'); return; }
            const isBase = (window._documentosBase || []).includes(tipo);
            if (!isBase && !alunoId) { showToast('Selecione o aluno', 'error'); return; }
            try {
                const files = Array.from(fileInput.files);
                if (replaceId && files.length > 1) {
                    showToast('Para substituir, selecione apenas um arquivo.', 'warning');
                    return;
                }
                for (const file of files) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('tipo', tipo);
                    formData.append('atividade_id', atividadeId);
                    if (!isBase && alunoId) formData.append('aluno_id', alunoId);
                    await apiForm('/documentos/upload', formData);
                }
                if (replaceId) {
                    await api(`/documentos/${replaceId}`, { method: 'DELETE' });
                }
                showToast('Documento(s) enviado(s)!', 'success');
                closeModal('modal-upload');
                fileInput.value = '';
                document.getElementById('upload-file-name').textContent = '';
                resetUploadReplace();
                refreshCurrentView();
            } catch (e) {}
        }

        async function importarAlunosCsv() {
            const fileInput = document.getElementById('input-importar-csv');
            const turmaId = document.getElementById('input-importar-turma-id').value;
            if (!fileInput.files.length) { showToast('Selecione um arquivo CSV', 'error'); return; }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (turmaId) formData.append('turma_id', turmaId);
            try {
                const result = await apiForm('/alunos/importar-csv', formData);
                showToast(`Importados: ${result.criados || 0}`, 'success');
                closeModal('modal-importar-csv');
                if (turmaId) showTurma(turmaId); else showAlunos();
            } catch (e) {}
        }

        async function exportarAlunosCsv(turmaId) {
            try {
                const data = await api(`/exportar/alunos-csv${turmaId ? `?turma_id=${turmaId}` : ''}`);
                const blob = new Blob([data.csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'alunos.csv';
                link.click();
                URL.revokeObjectURL(url);
            } catch (e) {}
        }

        async function uploadProvasEmLote() {
            const filesInput = document.getElementById('input-upload-provas-files');
            const atividadeId = document.getElementById('input-upload-provas-atividade-id').value;
            const modo = document.getElementById('input-upload-provas-modo').value;
            if (!filesInput.files.length) { showToast('Selecione arquivos', 'error'); return; }
            const formData = new FormData();
            Array.from(filesInput.files).forEach(file => formData.append('files', file));
            formData.append('atividade_id', atividadeId);
            formData.append('modo_nome', modo);
            try {
                const result = await apiForm('/documentos/upload-provas-alunos', formData);
                showToast(`Enviados: ${result.salvos || 0}`, 'success');
                closeModal('modal-upload-provas');
                showAtividade(atividadeId);
            } catch (e) {}
        }

        function onPipelineModoChange() {
            const modo = document.querySelector('input[name="pipeline-modo"]:checked').value;
            document.getElementById('pipeline-aluno-container').style.display = modo === 'aluno' ? 'block' : 'none';
            document.getElementById('pipeline-turma-info').style.display = modo === 'turma' ? 'block' : 'none';
            document.getElementById('btn-executar-pipeline').textContent = modo === 'turma' ? 'Executar para Turma Toda' : 'Executar Pipeline';
        }

        async function executarPipelineCompleto() {
            const atividadeId = document.getElementById('input-pipeline-atividade-id').value;
            const modo = document.querySelector('input[name="pipeline-modo"]:checked').value;
            const defaultModelId = document.getElementById('input-pipeline-provider-default').value;

            const modelsPerStage = {};
            document.querySelectorAll('#pipeline-provider-stages select[data-etapa]').forEach(select => {
                if (select.value && select.value !== defaultModelId) {
                    modelsPerStage[select.dataset.etapa] = select.value;
                }
            });

            // Renomear providers para manter compatibilidade com backend
            const providers = modelsPerStage;
            const btn = document.getElementById('btn-executar-pipeline');

            // Valida√ß√µes
            if (modo === 'aluno') {
                const alunoId = document.getElementById('input-pipeline-aluno').value;
                if (!atividadeId || !alunoId) {
                    showToast('Selecione o aluno para executar o pipeline', 'error');
                    return;
                }
                // Verificar se j√° est√° executando
                if (taskQueue.isRunning('pipeline', atividadeId, alunoId)) {
                    showToast('J√° existe um pipeline em execu√ß√£o para este aluno', 'warning');
                    return;
                }
            } else {
                if (taskQueue.isRunning('pipeline-turma', atividadeId)) {
                    showToast('J√° existe um pipeline de turma em execu√ß√£o', 'warning');
                    return;
                }
            }

            // Fechar modal imediatamente e iniciar tarefa em background
            closeModal('modal-pipeline-completo');

            const taskType = modo === 'turma' ? 'pipeline-turma' : 'pipeline';
            const description = modo === 'turma' ? 'Pipeline Turma Toda' : `Pipeline Aluno`;
            const alunoIdForTask = modo === 'aluno' ? document.getElementById('input-pipeline-aluno').value : null;

            const task = taskQueue.addTask(taskType, description, atividadeId, alunoIdForTask);
            showToast('üöÄ Pipeline iniciado! Acompanhe no painel de tarefas.', 'success');

            // Abrir painel de tarefas
            document.getElementById('task-panel').classList.add('show');

            try {
                let result;
                if (modo === 'turma') {
                    const formData = new FormData();
                    formData.append('atividade_id', atividadeId);
                    formData.append('apenas_com_prova', 'true');
                    if (defaultModelId) formData.append('model_id', defaultModelId);
                    if (Object.keys(modelsPerStage).length) formData.append('providers', JSON.stringify(modelsPerStage));

                    result = await apiForm('/executar/pipeline-turma', formData);
                } else {
                    const alunoId = document.getElementById('input-pipeline-aluno').value;
                    const formData = new FormData();
                    formData.append('atividade_id', atividadeId);
                    formData.append('aluno_id', alunoId);
                    if (defaultModelId) formData.append('model_id', defaultModelId);
                    if (Object.keys(modelsPerStage).length) formData.append('providers', JSON.stringify(modelsPerStage));

                    result = await apiForm('/executar/pipeline-completo', formData);
                }

                taskQueue.completeTask(task.id, result);
            } catch (e) {
                taskQueue.failTask(task.id, e.message || 'Erro ao executar pipeline');
            }
        }

        async function executarEtapa(preview = false) {
            const etapa = document.getElementById('input-execucao-etapa').value;
            const atividadeId = document.getElementById('input-execucao-atividade-id').value;
            const alunoId = document.getElementById('input-execucao-aluno').value || null;
            const modelId = document.getElementById('input-execucao-model').value || null;
            const promptId = document.getElementById('input-execucao-prompt').value || null;
            const editandoPrompt = document.getElementById('input-execucao-editar-prompt').checked;
            const promptTexto = editandoPrompt ? document.getElementById('input-execucao-prompt-texto').value : null;

            if (!etapa || !atividadeId) { showToast('Selecione a etapa', 'error'); return; }

            // Chat Geral: redireciona para a p√°gina de chat com a atividade pr√©-selecionada
            if (etapa === 'chat_geral') {
                closeModal('modal-execucao');
                showChatGeral(atividadeId, alunoId);
                return;
            }

            // Verificar se etapa precisa de aluno
            if (!ETAPAS_SEM_ALUNO.includes(etapa) && !alunoId) {
                showToast('Esta etapa requer um aluno selecionado', 'error');
                return;
            }

            // Para preview, executar diretamente (√© r√°pido)
            if (preview) {
                try {
                    const payload = {
                        etapa,
                        atividade_id: atividadeId,
                        aluno_id: alunoId,
                        model_id: modelId,
                        prompt_id: promptId
                    };
                    if (editandoPrompt && promptTexto) {
                        payload.prompt_customizado = promptTexto;
                    }
                    const result = await api('/executar/etapa-preview', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    showToast('Preview gerado', 'success');
                    closeModal('modal-execucao');
                    if (result?.resultado) {
                        showResultado('preview-' + etapa, atividadeId, alunoId, result.resultado, null);
                    }
                } catch (e) {
                    showToast(e.message || 'Erro ao gerar preview', 'error');
                }
                return;
            }

            // Verificar se j√° est√° executando esta etapa
            const taskKey = `etapa-${etapa}`;
            if (taskQueue.isRunning(taskKey, atividadeId, alunoId)) {
                showToast('Esta etapa j√° est√° em execu√ß√£o', 'warning');
                return;
            }

            // Fechar modal e executar em background
            closeModal('modal-execucao');

            const etapaLabel = window._etapasData?.find(e => e.id === etapa)?.nome || etapa;
            const task = taskQueue.addTask(taskKey, `Etapa: ${etapaLabel}`, atividadeId, alunoId);
            showToast(`üîÑ Executando "${etapaLabel}"... Acompanhe no painel de tarefas.`, 'success');

            // Abrir painel de tarefas
            document.getElementById('task-panel').classList.add('show');

            try {
                const payload = {
                    etapa,
                    atividade_id: atividadeId,
                    aluno_id: alunoId,
                    model_id: modelId,
                    prompt_id: promptId
                };
                if (editandoPrompt && promptTexto) {
                    payload.prompt_customizado = promptTexto;
                }

                const result = await api('/executar/etapa', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                taskQueue.completeTask(task.id, result?.resultado || result);
            } catch (e) {
                console.error('Erro ao executar etapa:', e);
                taskQueue.failTask(task.id, e.message || 'Erro ao executar etapa');
            }
        }

        async function showStatusProcessamento(atividadeId) {
            const alunoId = prompt('ID do aluno (opcional)', '');
            const query = alunoId ? `?aluno_id=${alunoId}` : '';
            try {
                const data = await api(`/processamento/status/${atividadeId}${query}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Status de Processamento</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }

        async function showRanking(atividadeId) {
            try {
                const data = await api(`/resultados/${atividadeId}/ranking`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Ranking</h1></div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr><th>Posi√ß√£o</th><th>Aluno</th><th>Nota</th><th>Percentual</th></tr>
                                </thead>
                                <tbody>
                                    ${data.ranking.map(r => `
                                        <tr>
                                            <td>${r.posicao}</td>
                                            <td>${r.aluno_nome}</td>
                                            <td>${r.nota ?? '-'}/${r.nota_maxima ?? '-'}</td>
                                            <td>${r.percentual ?? '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (e) {}
        }

        async function showEstatisticasAtividade(atividadeId) {
            try {
                const data = await api(`/resultados/${atividadeId}/estatisticas`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Estat√≠sticas da Atividade</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }

        async function showResultadoAluno(atividadeId, alunoId) {
            try {
                currentView = 'resultado_aluno';
                currentAtividade = atividadeId;
                currentAluno = alunoId;
                const [resultadoResp, documentosResp] = await Promise.allSettled([
                    api(`/resultados/${atividadeId}/${alunoId}`),
                    api(`/documentos?atividade_id=${atividadeId}&aluno_id=${alunoId}`)
                ]);
                
                // Nova l√≥gica: endpoint agora retorna resultados parciais em vez de 404
                const resultadoData = resultadoResp.status === 'fulfilled' ? resultadoResp.value : null;
                const isComplete = resultadoData?.completo === true;
                const resultado = isComplete ? (resultadoData.resultado || {}) : {};
                const documentos = documentosResp.status === 'fulfilled' ? (documentosResp.value.documentos || []) : [];
                
                // Renderizar status do pipeline se n√£o est√° completo
                let pipelineStatus = '';
                if (resultadoData && !isComplete) {
                    const progresso = resultadoData.progresso || 0;
                    const etapas = resultadoData.etapas || {};
                    const dadosParciais = resultadoData.dados_parciais || {};
                    
                    pipelineStatus = `
                        <div class="card" style="border-left: 4px solid var(--warning);">
                            <div class="card-header">
                                <h3 class="card-title">‚è≥ Pipeline em Progresso</h3>
                                <span style="font-size: 14px; color: var(--text-secondary);">${progresso}% conclu√≠do</span>
                            </div>
                            <div style="background: var(--bg); border-radius: 8px; height: 8px; margin-bottom: 16px; overflow: hidden;">
                                <div style="background: var(--primary); height: 100%; width: ${progresso}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px;">
                                ${Object.entries(etapas).map(([key, etapa]) => `
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg); border-radius: 6px;">
                                        <span style="font-size: 16px;">${etapa.completa ? '‚úÖ' : '‚è≥'}</span>
                                        <span style="font-size: 13px; ${etapa.completa ? '' : 'color: var(--text-secondary);'}">${etapa.nome}</span>
                                        ${etapa.doc_id ? `<button class="btn btn-sm" onclick="visualizarDocumento('${etapa.doc_id}')" style="margin-left: auto; padding: 2px 6px;">üëÅÔ∏è</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ${Object.keys(dadosParciais).length > 0 ? `
                                <details style="margin-top: 16px;">
                                    <summary style="cursor: pointer; font-weight: 500;">üìä Dados Parciais Dispon√≠veis</summary>
                                    <pre style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 8px; font-size: 12px; overflow: auto; max-height: 300px;">${escapeHtml(JSON.stringify(dadosParciais, null, 2))}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else if (!resultadoData) {
                    pipelineStatus = '<div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div class="alert-content"><div class="alert-title">Resultado indispon√≠vel</div><div class="alert-text">Ainda n√£o h√° corre√ß√£o para este aluno. Inicie o pipeline.</div></div></div>';
                }
                
                const docsPorTipo = groupDocumentosPorTipo(documentos);
                const labels = {
                    enunciado: 'üìÑ Enunciado',
                    gabarito: '‚úÖ Gabarito',
                    criterios_correcao: 'üìã Crit√©rios de Corre√ß√£o',
                    prova_respondida: 'üìù Prova Respondida',
                    correcao_professor: 'üßë‚Äçüè´ Corre√ß√£o do Professor',
                    extracao_questoes: 'üîé Extra√ß√£o de Quest√µes da Atividade',
                    extracao_gabarito: 'üß© Extra√ß√£o de Gabarito',
                    extracao_respostas: 'üìù Extra√ß√£o de Respostas do Aluno',
                    correcao: '‚úÖ Corre√ß√£o da IA',
                    analise_habilidades: 'üìä An√°lise de Habilidades',
                    relatorio_final: 'üìÑ Relat√≥rio Final'
                };
                const tiposAluno = window._documentosAluno || ['prova_respondida', 'correcao_professor'];
                const tiposGerados = window._documentosGerados || [
                    'extracao_questoes',
                    'extracao_gabarito',
                    'extracao_respostas',
                    'correcao',
                    'analise_habilidades',
                    'relatorio_final'
                ];
                const gruposAluno = tiposAluno.map(tipo => renderDocumentoGrupo({
                    titulo: labels[tipo] || tipo,
                    tipo,
                    atividadeId,
                    alunoId,
                    docs: docsPorTipo[tipo] || [],
                    icon: tipo === 'correcao_professor' ? 'üßë‚Äçüè´' : 'üë§',
                    onAdicionar: `openModalUploadAlunoTipo('${atividadeId}', '${alunoId}', '${tipo}')`,
                    showVisualizar: true
                })).join('');
                const gruposGerados = tiposGerados.map(tipo => renderDocumentoGrupo({
                    titulo: labels[tipo] || tipo,
                    tipo,
                    atividadeId,
                    alunoId,
                    docs: docsPorTipo[tipo] || [],
                    icon: 'ü§ñ',
                    onAdicionar: '',
                    showVisualizar: true
                })).join('');
                
                // S√≥ mostrar resultado final se completo
                const resultadoFinal = isComplete ? `
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üìä Resultado Final</h3></div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <a class="btn" href="${API}/resultados/${atividadeId}/${alunoId}/exportar/json" target="_blank">Exportar JSON</a>
                            <a class="btn" href="${API}/resultados/${atividadeId}/${alunoId}/exportar/markdown" target="_blank">Exportar Markdown</a>
                        </div>
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto; max-height: 400px;">${escapeHtml(JSON.stringify(resultado, null, 2))}</pre>
                    </div>
                ` : '';
                
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Resultado do Aluno</h1></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                        <button class="btn" onclick="openModalExecucao('${atividadeId}')">‚öôÔ∏è Executar Etapa</button>
                        <button class="btn btn-primary" onclick="openModalPipelineCompleto('${atividadeId}', 'aluno')">‚ö° Pipeline Aluno</button>
                        <button class="btn" onclick="showAtividade('${atividadeId}')">‚Üê Voltar para Atividade</button>
                    </div>
                    ${pipelineStatus}
                    ${resultadoFinal}
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üìå Documentos do Aluno</h3></div>
                        ${gruposAluno || '<div class="empty-state"><div class="empty-icon">üìÑ</div><div class="empty-title">Nenhum documento do aluno</div></div>'}
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">ü§ñ Comparativo das Etapas (IA)</h3></div>
                        ${gruposGerados || '<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">Nenhuma etapa gerada</div></div>'}
                    </div>
                `;
            } catch (e) {
                console.error('Erro ao carregar resultado:', e);
            }
        }

        async function showDashboardTurma(turmaId) {
            try {
                const data = await api(`/dashboard/turma/${turmaId}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Dashboard da Turma</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }

        async function showDashboardAluno(alunoId) {
            try {
                const data = await api(`/dashboard/aluno/${alunoId}`);
                document.getElementById('content').innerHTML = `
                    <div class="page-header"><h1 class="page-title">Dashboard do Aluno</h1></div>
                    <div class="card">
                        <pre style="background: var(--bg-card); padding: 16px; border-radius: 8px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                    </div>
                `;
            } catch (e) {}
        }
        
        // ============================================================
        // UPLOAD ZONE
        // ============================================================
        function setupUploadZone() {
            const zone = document.getElementById('upload-zone-modal');
            const input = document.getElementById('input-upload-file');
            const fileName = document.getElementById('upload-file-name');
            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    input.files = e.dataTransfer.files;
                    const names = Array.from(e.dataTransfer.files).map(file => file.name);
                    fileName.textContent = `üìé ${names.join(', ')}`;
                }
            });
            input.addEventListener('change', () => {
                if (input.files.length) {
                    const names = Array.from(input.files).map(file => file.name);
                    fileName.textContent = `üìé ${names.join(', ')}`;
                }
            });
            document.getElementById('input-upload-tipo').addEventListener('change', (e) => {
                const isBase = (window._documentosBase || []).includes(e.target.value);
                document.getElementById('grupo-aluno-upload').style.display = isBase ? 'none' : 'block';
                resetUploadReplace();
            });
            document.getElementById('input-upload-aluno').addEventListener('change', () => {
                resetUploadReplace();
            });
        }
        
        // ============================================================
        // BUSCA
        // ============================================================
        function setupBusca() {
            const input = document.getElementById('input-busca');
            let timeout;
            input.addEventListener('input', () => { clearTimeout(timeout); timeout = setTimeout(() => buscar(input.value), 300); });
        }
        
        async function buscar(termo) {
            const container = document.getElementById('resultados-busca');
            if (termo.length < 2) { container.innerHTML = '<div style="color: var(--text-muted); padding: 20px; text-align: center;">Digite pelo menos 2 caracteres</div>'; return; }
            try {
                const data = await api(`/busca?q=${encodeURIComponent(termo)}`);
                if (data.total === 0) { container.innerHTML = '<div style="color: var(--text-muted); padding: 20px; text-align: center;">Nenhum resultado</div>'; return; }
                let html = '';
                if (data.resultados.alunos.length > 0) { html += '<div style="margin-bottom: 12px;"><strong>Alunos</strong></div>' + data.resultados.alunos.map(a => `<div class="doc-item" onclick="closeModal('modal-busca'); showAluno('${a.id}')"><div class="doc-icon">üë§</div><div class="doc-info"><div class="doc-name">${a.nome}</div><div class="doc-meta">${a.matricula || ''}</div></div></div>`).join(''); }
                if (data.resultados.materias.length > 0) { html += '<div style="margin: 12px 0;"><strong>Mat√©rias</strong></div>' + data.resultados.materias.map(m => `<div class="doc-item" onclick="closeModal('modal-busca'); showMateria('${m.id}')"><div class="doc-icon">üìö</div><div class="doc-info"><div class="doc-name">${m.nome}</div></div></div>`).join(''); }
                if (data.resultados.turmas.length > 0) { html += '<div style="margin: 12px 0;"><strong>Turmas</strong></div>' + data.resultados.turmas.map(t => `<div class="doc-item" onclick="closeModal('modal-busca'); showTurma('${t.id}')"><div class="doc-icon">üë•</div><div class="doc-info"><div class="doc-name">${t.nome}</div><div class="doc-meta">${t.materia || ''}</div></div></div>`).join(''); }
                if (data.resultados.atividades.length > 0) { html += '<div style="margin: 12px 0;"><strong>Atividades</strong></div>' + data.resultados.atividades.map(a => `<div class="doc-item" onclick="closeModal('modal-busca'); showAtividade('${a.id}')"><div class="doc-icon">üìù</div><div class="doc-info"><div class="doc-name">${a.nome}</div><div class="doc-meta">${a.turma || ''}</div></div></div>`).join(''); }
                container.innerHTML = html;
            } catch (e) { container.innerHTML = '<div style="color: var(--danger); padding: 20px;">Erro na busca</div>'; }
        }

        async function loadTiposDocumentos() {
            try {
                const data = await api('/tipos/documentos');
                const select = document.getElementById('input-upload-tipo');
                if (!select) return;
                window._documentosBase = data.tipos?.base || [];
                window._documentosAluno = data.tipos?.aluno || [];
                window._documentosGerados = data.tipos?.gerados || [];
                const labels = {
                    enunciado: 'üìÑ Enunciado da Prova',
                    gabarito: '‚úÖ Gabarito',
                    criterios_correcao: 'üìã Crit√©rios de Corre√ß√£o',
                    prova_respondida: 'üë§ Prova do Aluno',
                    correcao_professor: 'üßë‚Äçüè´ Corre√ß√£o do Professor',
                    extracao_questoes: 'üîé Extra√ß√£o de Quest√µes',
                    extracao_gabarito: 'üß© Extra√ß√£o de Gabarito',
                    extracao_respostas: 'üìù Extra√ß√£o de Respostas',
                    correcao: '‚úÖ Corre√ß√£o',
                    analise_habilidades: 'üìä An√°lise de Habilidades',
                    relatorio_final: 'üìÑ Relat√≥rio Final'
                };
                select.innerHTML = data.todos.map(tipo => `<option value="${tipo}">${labels[tipo] || tipo}</option>`).join('');
            } catch (e) {}
        }

        async function loadNiveisEnsino() {
            try {
                const data = await api('/tipos/niveis');
                const select = document.getElementById('input-materia-nivel');
                if (!select) return;
                select.innerHTML = data.niveis.map(n => `<option value="${n}">${n.replace('_', ' ').toUpperCase()}</option>`).join('');
            } catch (e) {}
        }
        
        // ============================================================
        // TOAST
        // ============================================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength - 1)}‚Ä¶`;
        }



        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }





        
        // ============================================================
        // SETTINGS - API KEYS E MODELOS
        // ============================================================
        let _modelosSugeridos = {};

        function showSettingsTab(tab) {
            const tabNames = ['api-keys', 'models', 'catalog', 'custom', 'local'];
            document.querySelectorAll('#modal-settings .tab').forEach((t, i) => {
                t.classList.toggle('active', tabNames[i] === tab);
            });
            tabNames.forEach(name => {
                const el = document.getElementById(`settings-tab-${name}`);
                if (el) el.style.display = name === tab ? 'block' : 'none';
            });
            if (tab === 'api-keys') carregarApiKeys();
            if (tab === 'models') carregarModelos();
            if (tab === 'catalog') carregarCatalogo();
            if (tab === 'local') detectAllLocalModels();
        }

        // ============================================================
        // CATALOG - CAT√ÅLOGO DE MODELOS
        // ============================================================
        let _catalogData = null;
        let _catalogViewMode = 'cards';
        let _selectedForCompare = [];

        async function carregarCatalogo() {
            if (_catalogData) {
                renderCatalog();
                return;
            }
            try {
                _catalogData = await api('/settings/model-catalog');
                populateProviderFilter();
                renderCatalog();
            } catch (e) {
                document.getElementById('catalog-grid').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Erro ao carregar cat√°logo</div></div>';
            }
        }

        function populateProviderFilter() {
            if (!_catalogData || !_catalogData.providers) return;
            const select = document.getElementById('filter-provider');
            select.innerHTML = '<option value="">Todos Provedores</option>';
            for (const [key, prov] of Object.entries(_catalogData.providers)) {
                select.innerHTML += `<option value="${key}">${prov.name}</option>`;
            }
        }

        function setCatalogView(mode) {
            _catalogViewMode = mode;
            document.querySelectorAll('.view-mode-btn').forEach(btn =>
                btn.classList.toggle('active', btn.dataset.mode === mode)
            );
            document.getElementById('catalog-content').style.display = mode === 'compare' ? 'none' : 'block';
            document.getElementById('compare-content').style.display = mode === 'compare' ? 'block' : 'none';
            renderCatalog();
        }

        function filterCatalog() {
            renderCatalog();
        }

        function renderCatalog() {
            if (!_catalogData) return;
            const providerFilter = document.getElementById('filter-provider').value;
            const capFilter = document.getElementById('filter-capability').value;
            const searchFilter = document.getElementById('filter-search').value.toLowerCase();

            switch (_catalogViewMode) {
                case 'cards': renderCatalogCards(providerFilter, capFilter, searchFilter); break;
                case 'table': renderCatalogTable(providerFilter, capFilter, searchFilter); break;
                case 'compare': renderCatalogCompare(); break;
                case 'minimal': renderCatalogMinimal(providerFilter, capFilter, searchFilter); break;
            }
        }

        function getFilteredModels(providerFilter, capFilter, searchFilter) {
            const models = [];
            for (const [key, prov] of Object.entries(_catalogData.providers)) {
                if (providerFilter && key !== providerFilter) continue;
                for (const m of prov.models || []) {
                    if (capFilter) {
                        const capKey = `supports_${capFilter}`;
                        if (!m[capKey]) continue;
                    }
                    if (searchFilter) {
                        const searchIn = `${m.display_name} ${m.id} ${m.description || ''}`.toLowerCase();
                        if (!searchIn.includes(searchFilter)) continue;
                    }
                    models.push({ ...m, provider: key, providerName: prov.name });
                }
            }
            return models;
        }

        function renderCatalogCards(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = models.map(m => `
                <div class="model-card">
                    <div class="model-card-header">
                        <span class="provider-badge provider-${m.provider}">${m.providerName}</span>
                        <span class="model-card-name">${escapeHtml(m.display_name)}</span>
                    </div>
                    <div class="model-card-desc">${escapeHtml(m.description || '')}</div>
                    <div class="model-stats">
                        <div class="stat">
                            <span class="stat-label">Contexto</span>
                            <span class="stat-value">${formatContext(m.context_window)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Input</span>
                            <span class="stat-value">$${m.input_cost?.toFixed(2) || '0'}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Output</span>
                            <span class="stat-value">$${m.output_cost?.toFixed(2) || '0'}</span>
                        </div>
                    </div>
                    <div class="capability-badges">
                        ${m.supports_vision ? '<span class="badge-vision">üëÅÔ∏è Vision</span>' : ''}
                        ${m.supports_tools ? '<span class="badge-tools">üîß Tools</span>' : ''}
                        ${m.supports_reasoning ? '<span class="badge-reasoning">üß† Reasoning</span>' : ''}
                        ${m.supports_search ? '<span class="badge-search">üîç Search</span>' : ''}
                        ${m.supports_json_mode ? '<span class="badge-json">üìã JSON</span>' : ''}
                    </div>
                    <div class="model-card-footer">
                        <button class="btn btn-sm btn-primary" onclick="addFromCatalog('${m.provider}', '${m.id}')">+ Adicionar</button>
                    </div>
                </div>
            `).join('');
        }

        function renderCatalogTable(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = `
                <table class="catalog-table">
                    <thead>
                        <tr>
                            <th>Modelo</th>
                            <th>Contexto</th>
                            <th>Input</th>
                            <th>Output</th>
                            <th>üëÅÔ∏è</th>
                            <th>üîß</th>
                            <th>üß†</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${models.map(m => `
                            <tr>
                                <td>
                                    <span class="provider-badge provider-${m.provider}" style="margin-right: 6px;">${m.providerName}</span>
                                    ${escapeHtml(m.display_name)}
                                </td>
                                <td>${formatContext(m.context_window)}</td>
                                <td>$${m.input_cost?.toFixed(2) || '0'}</td>
                                <td>$${m.output_cost?.toFixed(2) || '0'}</td>
                                <td class="${m.supports_vision ? 'check' : 'cross'}">${m.supports_vision ? '‚úì' : '‚àí'}</td>
                                <td class="${m.supports_tools ? 'check' : 'cross'}">${m.supports_tools ? '‚úì' : '‚àí'}</td>
                                <td class="${m.supports_reasoning ? 'check' : 'cross'}">${m.supports_reasoning ? '‚úì' : '‚àí'}</td>
                                <td><button class="btn btn-xs btn-primary" onclick="addFromCatalog('${m.provider}', '${m.id}')">+</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderCatalogMinimal(providerFilter, capFilter, searchFilter) {
            const models = getFilteredModels(providerFilter, capFilter, searchFilter);
            const container = document.getElementById('catalog-grid');
            if (models.length === 0) {
                container.innerHTML = '<div class="empty-hint">Nenhum modelo encontrado</div>';
                return;
            }
            container.innerHTML = `<div class="minimal-list">${models.map(m => `
                <div class="minimal-item" onclick="addFromCatalog('${m.provider}', '${m.id}')">
                    <span class="provider-dot" style="background: var(--${getProviderColor(m.provider)});"></span>
                    <span class="model-name" style="flex:1">${escapeHtml(m.display_name)}</span>
                    <span class="context-badge">${formatContext(m.context_window)}</span>
                </div>
            `).join('')}</div>`;
        }

        function renderCatalogCompare() {
            const allModels = getFilteredModels('', '', '');
            const chipsContainer = document.getElementById('compare-chips');
            chipsContainer.innerHTML = allModels.map(m => {
                const ref = `${m.provider}/${m.id}`;
                const isSelected = _selectedForCompare.some(s => s.ref === ref);
                return `<span class="compare-chip ${isSelected ? 'selected' : ''}"
                             onclick="toggleCompareModel('${m.provider}', '${m.id}', '${escapeHtml(m.display_name)}', ${m.input_cost || 0}, ${m.output_cost || 0})">
                    ${escapeHtml(m.display_name)}
                </span>`;
            }).join('');

            const grid = document.getElementById('compare-grid');
            if (_selectedForCompare.length === 0) {
                grid.innerHTML = '<div class="empty-hint">Selecione modelos acima para comparar</div>';
                document.getElementById('cost-results').innerHTML = '';
                return;
            }

            grid.innerHTML = _selectedForCompare.map(m => `
                <div class="model-card">
                    <div class="model-card-header">
                        <span class="model-card-name">${m.name}</span>
                    </div>
                    <div class="model-stats">
                        <div class="stat">
                            <span class="stat-label">Input</span>
                            <span class="stat-value">$${m.inputCost.toFixed(2)}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Output</span>
                            <span class="stat-value">$${m.outputCost.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            calculateCosts();
        }

        function toggleCompareModel(provider, modelId, name, inputCost, outputCost) {
            const ref = `${provider}/${modelId}`;
            const idx = _selectedForCompare.findIndex(s => s.ref === ref);
            if (idx >= 0) {
                _selectedForCompare.splice(idx, 1);
            } else if (_selectedForCompare.length < 4) {
                _selectedForCompare.push({ ref, name, inputCost, outputCost });
            } else {
                showToast('M√°ximo 4 modelos para compara√ß√£o', 'warning');
                return;
            }
            renderCatalogCompare();
        }

        function calculateCosts() {
            const inputTokens = parseInt(document.getElementById('calc-input-tokens').value) || 1000;
            const outputTokens = parseInt(document.getElementById('calc-output-tokens').value) || 500;
            const requests = parseInt(document.getElementById('calc-requests').value) || 100;

            const results = _selectedForCompare.map(m => {
                const costPerReq = (inputTokens * m.inputCost / 1000000) + (outputTokens * m.outputCost / 1000000);
                return {
                    name: m.name,
                    daily: costPerReq * requests,
                    monthly: costPerReq * requests * 30
                };
            });

            const container = document.getElementById('cost-results');
            if (results.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = results.map(r => `
                <div class="cost-card">
                    <div class="cost-card-title">${escapeHtml(r.name)}</div>
                    <div class="cost-card-value">$${r.monthly.toFixed(2)}/m√™s</div>
                    <div class="cost-card-sub">$${r.daily.toFixed(4)}/dia</div>
                </div>
            `).join('');
        }

        function formatContext(tokens) {
            if (!tokens) return '‚àí';
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
            if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K';
            return tokens.toString();
        }

        function getProviderColor(provider) {
            const colors = {
                openai: 'success', anthropic: 'warning', google: 'primary',
                deepseek: 'primary', mistral: 'warning', xai: 'text',
                perplexity: 'success', cohere: 'danger', groq: 'danger',
                openrouter: 'purple', ollama: 'text', vllm: 'purple', lmstudio: 'success'
            };
            return colors[provider] || 'text';
        }

        async function addFromCatalog(provider, modelId) {
            try {
                // Buscar info completa do modelo
                const info = await api(`/settings/model-catalog/${provider}/${modelId}`);
                const model = info.model;

                // Reset modal primeiro
                resetModelModal();

                // Preencher o modal com dados do cat√°logo
                document.getElementById('input-model-nome').value = model.display_name;
                document.getElementById('input-model-tipo').value = provider;

                // Popular dropdown
                onProviderChange();

                // Tentar selecionar no dropdown, sen√£o colocar no campo manual
                const select = document.getElementById('input-model-select');
                let found = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === modelId) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    document.getElementById('input-model-manual').value = modelId;
                }

                // Definir capacidades
                document.getElementById('input-model-vision').checked = model.supports_vision || false;
                document.getElementById('input-model-tools').checked = model.supports_tools || false;

                // Verificar se √© reasoning
                const isReasoning = model.supports_reasoning || !model.requires_temperature;
                if (isReasoning) {
                    document.getElementById('input-model-is-reasoning').value = 'true';
                    document.getElementById('reasoning-warning').style.display = 'flex';
                    document.getElementById('temp-group').style.display = 'none';
                    document.getElementById('reasoning-group').style.display = 'block';
                } else {
                    document.getElementById('input-model-is-reasoning').value = 'false';
                }

                // Definir max_output se dispon√≠vel
                if (model.max_output) {
                    document.getElementById('input-model-tokens').value = Math.min(model.max_output, 16384);
                }

                // Abrir modal
                openModal('modal-add-model');
                showToast(`Dados de ${model.display_name} carregados`, 'success');
            } catch (e) {
                console.error('Erro addFromCatalog:', e);
                showToast('Erro ao carregar modelo do cat√°logo', 'error');
            }
        }

        // ============================================================
        // CUSTOM ENDPOINT
        // ============================================================
        async function salvarCustomEndpoint() {
            const nome = document.getElementById('custom-nome').value;
            const tipo = document.getElementById('custom-compat').value;
            const modelId = document.getElementById('custom-model-id').value;
            const baseUrl = document.getElementById('custom-url').value;
            const apiVersion = document.getElementById('custom-api-version').value || null;
            const headersText = document.getElementById('custom-headers').value;
            const maxTokens = parseInt(document.getElementById('custom-tokens').value) || 4096;
            const temperature = parseFloat(document.getElementById('custom-temp').value) || 0.7;

            if (!nome || !modelId || !baseUrl) {
                showToast('Preencha os campos obrigat√≥rios', 'error');
                return;
            }

            let extraHeaders = null;
            if (headersText) {
                try {
                    extraHeaders = JSON.parse(headersText);
                } catch (e) {
                    showToast('JSON de headers inv√°lido', 'error');
                    return;
                }
            }

            try {
                await api('/settings/models/custom', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome,
                        tipo,
                        custom_model_id: modelId,
                        custom_base_url: baseUrl,
                        api_version: apiVersion,
                        extra_headers: extraHeaders,
                        max_tokens: maxTokens,
                        temperature
                    })
                });
                showToast('Endpoint customizado salvo!', 'success');
                // Limpar campos
                document.getElementById('custom-nome').value = '';
                document.getElementById('custom-model-id').value = '';
                document.getElementById('custom-url').value = '';
                document.getElementById('custom-api-version').value = '';
                document.getElementById('custom-headers').value = '';
                showSettingsTab('models');
            } catch (e) {
                showToast('Erro ao salvar endpoint', 'error');
            }
        }

        // ============================================================
        // LOCAL MODELS DETECTION
        // ============================================================
        async function detectAllLocalModels() {
            detectLocalModels('ollama');
            detectLocalModels('vllm');
            detectLocalModels('lmstudio');
        }

        async function detectLocalModels(provider) {
            const statusEl = document.getElementById(`${provider}-status`);
            const listEl = document.getElementById(`${provider}-models`);
            statusEl.textContent = '‚è≥';
            listEl.innerHTML = '<div class="empty-hint">Verificando...</div>';

            try {
                const data = await api(`/settings/local-models/${provider}`);
                if (data.online) {
                    statusEl.textContent = 'üü¢';
                    statusEl.title = 'Online';
                    if (data.models && data.models.length > 0) {
                        listEl.innerHTML = data.models.map(m => `
                            <div class="local-model-item">
                                <span class="model-name">${escapeHtml(m.display_name || m.id)}</span>
                                ${m.size ? `<span class="model-size">${formatBytes(m.size)}</span>` : ''}
                                <button class="btn btn-xs btn-primary" onclick="addLocalModel('${provider}', '${m.id}')">+</button>
                            </div>
                        `).join('');
                    } else {
                        listEl.innerHTML = '<div class="empty-hint">Nenhum modelo instalado</div>';
                    }
                } else {
                    statusEl.textContent = 'üî¥';
                    statusEl.title = 'Offline';
                    listEl.innerHTML = '<div class="empty-hint">Servidor n√£o encontrado</div>';
                }
            } catch (e) {
                statusEl.textContent = 'üî¥';
                listEl.innerHTML = '<div class="empty-hint">Erro ao conectar</div>';
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '';
            const gb = bytes / (1024 * 1024 * 1024);
            return gb.toFixed(1) + ' GB';
        }

        async function addLocalModel(provider, modelId) {
            try {
                await api('/settings/models', {
                    method: 'POST',
                    body: JSON.stringify({
                        nome: modelId,
                        tipo: provider,
                        modelo: modelId,
                        max_tokens: 4096,
                        temperature: 0.7
                    })
                });
                showToast(`Modelo ${modelId} adicionado!`, 'success');
                showSettingsTab('models');
            } catch (e) {
                showToast('Erro ao adicionar modelo', 'error');
            }
        }

        async function carregarApiKeys() {
            try {
                const data = await api('/settings/api-keys');
                const container = document.getElementById('api-keys-list');
                if (!data.api_keys || data.api_keys.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîë</div><div class="empty-title">Nenhuma API key configurada</div></div>';
                    return;
                }
                container.innerHTML = data.api_keys.map(k => `
                    <div class="doc-item" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                        <div class="doc-icon" style="background: var(--bg-hover);">üîë</div>
                        <div class="doc-info" style="flex: 1;">
                            <div class="doc-name">${escapeHtml(k.nome_exibicao || k.empresa)}</div>
                            <div class="doc-meta">${escapeHtml(k.empresa)} ‚Ä¢ ${k.api_key_preview || '***'}</div>
                        </div>
                        <div class="doc-actions">
                            <button class="btn btn-xs btn-danger" onclick="excluirApiKey('${k.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('api-keys-list').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Erro ao carregar API keys. Verifique se o routes_chat.py est√° instalado.</div>';
            }
        }

        async function salvarApiKey() {
            const empresa = document.getElementById('input-apikey-empresa').value;
            const apiKey = document.getElementById('input-apikey-key').value;
            const nome = document.getElementById('input-apikey-nome').value;
            if (!apiKey) { showToast('API key obrigat√≥ria', 'error'); return; }
            try {
                await api('/settings/api-keys', {
                    method: 'POST',
                    body: JSON.stringify({ empresa, api_key: apiKey, nome_exibicao: nome || null })
                });
                showToast('API key salva!', 'success');
                closeModal('modal-add-apikey');
                document.getElementById('input-apikey-key').value = '';
                document.getElementById('input-apikey-nome').value = '';
                carregarApiKeys();
            } catch (e) { /* erro j√° mostrado */ }
        }

        async function excluirApiKey(id) {
            if (!confirm('Excluir esta API key?')) return;
            try {
                await api(`/settings/api-keys/${id}`, { method: 'DELETE' });
                showToast('API key exclu√≠da!', 'success');
                carregarApiKeys();
            } catch (e) { /* erro j√° mostrado */ }
        }

        async function carregarModelos() {
            try {
                const data = await api('/settings/models');
                const container = document.getElementById('models-list');
                if (!data.models || data.models.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ü§ñ</div><div class="empty-title">Nenhum modelo configurado</div></div>';
                    return;
                }
                container.innerHTML = data.models.map(m => `
                    <div class="doc-item" style="border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                        <div class="doc-icon" style="background: var(--bg-hover);">ü§ñ</div>
                        <div class="doc-info" style="flex: 1;">
                            <div class="doc-name">${escapeHtml(m.nome)} ${m.is_default ? '<span class="badge badge-primary">Padr√£o</span>' : ''}</div>
                            <div class="doc-meta">${escapeHtml(m.tipo)} ‚Ä¢ ${escapeHtml(m.modelo)}</div>
                        </div>
                        <div class="doc-actions" style="display: flex; gap: 6px;">
                            ${!m.is_default ? `<button class="btn btn-xs" onclick="definirModeloPadrao('${m.id}')" title="Definir como padr√£o">‚≠ê</button>` : ''}
                            <button class="btn btn-xs" onclick="testarModelo('${m.id}')" title="Testar">üß™</button>
                            <button class="btn btn-xs btn-danger" onclick="excluirModelo('${m.id}')" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('models-list').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è Erro ao carregar modelos. Verifique se o routes_chat.py est√° instalado.</div>';
            }
        }

        // Modelos de reasoning que n√£o suportam temperatura
        const REASONING_MODELS = ['o1', 'o1-mini', 'o1-pro', 'o3', 'o3-mini', 'o4-mini', 'deepseek-reasoner'];

        async function carregarModelosSugeridosInicial() {
            try {
                const data = await api('/settings/models/sugeridos');
                _modelosSugeridos = data.modelos_por_tipo || {};
            } catch (e) { console.log('Modelos sugeridos n√£o dispon√≠veis'); }
        }

        function onProviderChange() {
            const tipo = document.getElementById('input-model-tipo').value;
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const modelos = _modelosSugeridos[tipo] || [];

            // Limpar campo manual
            manualInput.value = '';

            // Popular dropdown
            if (modelos.length === 0) {
                select.innerHTML = '<option value="">-- Nenhum modelo sugerido, digite abaixo --</option>';
            } else {
                select.innerHTML = '<option value="">-- Selecione ou digite abaixo --</option>' +
                    modelos.map(m => {
                        // Verifica se √© reasoning: suporta_temperature deve ser EXPLICITAMENTE false
                        const isReasoning = m.suporta_temperature === false || m.suporta_reasoning === true;
                        const reasoningBadge = isReasoning ? ' [Reasoning]' : '';
                        return `<option value="${m.id}" data-reasoning="${isReasoning}" data-vision="${m.suporta_vision || false}">${escapeHtml(m.nome || m.id)}${reasoningBadge}</option>`;
                    }).join('');
            }

            // Verificar se modelo digitado √© reasoning
            checkIfReasoningModel();
        }

        function onModelSelect() {
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const selectedOption = select.options[select.selectedIndex];

            if (select.value) {
                manualInput.value = '';  // Limpa manual se selecionou do dropdown
            }

            // Atualizar checkboxes de capacidades
            if (selectedOption && selectedOption.dataset) {
                const isVision = selectedOption.dataset.vision === 'true';
                document.getElementById('input-model-vision').checked = isVision;
            }

            checkIfReasoningModel();
        }

        function checkIfReasoningModel() {
            const select = document.getElementById('input-model-select');
            const manualInput = document.getElementById('input-model-manual');
            const selectedOption = select.options[select.selectedIndex];

            // Determinar qual modelo est√° selecionado
            const modelId = (manualInput.value.trim() || select.value).toLowerCase();

            // Verificar se √© reasoning:
            // 1. Pelo dropdown (j√° calculado corretamente)
            // 2. Pelo ID manual (verifica se cont√©m nomes de modelos reasoning)
            const isReasoningFromDropdown = selectedOption && selectedOption.dataset && selectedOption.dataset.reasoning === 'true';
            const isReasoningFromManual = modelId && REASONING_MODELS.some(r => modelId.includes(r));
            const isReasoning = isReasoningFromDropdown || isReasoningFromManual;

            // Mostrar/ocultar elementos
            document.getElementById('reasoning-warning').style.display = isReasoning ? 'flex' : 'none';
            document.getElementById('temp-group').style.display = isReasoning ? 'none' : 'block';
            document.getElementById('reasoning-group').style.display = isReasoning ? 'block' : 'none';
            document.getElementById('input-model-is-reasoning').value = isReasoning ? 'true' : 'false';
        }

        // Verificar reasoning quando digita manualmente
        document.addEventListener('DOMContentLoaded', function() {
            const manualInput = document.getElementById('input-model-manual');
            if (manualInput) {
                manualInput.addEventListener('input', checkIfReasoningModel);
            }
        });

        function preencherSystemPromptPadrao() {
            const systemPrompt = `Voc√™ √© um assistente educacional especializado em corre√ß√£o de provas.

REGRA CR√çTICA PARA GERA√á√ÉO DE ARQUIVOS:
=========================================
Quando o usu√°rio pedir para criar/gerar qualquer arquivo (Excel, PDF, Word, PowerPoint, imagem, CSV, etc.), voc√™ DEVE usar o formato python-exec.

FORMATO OBRIGAT√ìRIO:
\`\`\`python-exec:nome_arquivo.extensao
# c√≥digo Python aqui
\`\`\`

NUNCA FA√áA ISSO:
- N√ÉO diga "copie e cole"
- N√ÉO diga "salve como"
- N√ÉO use blocos documento: ou document: ou arquivo:
- N√ÉO descreva como criar o arquivo - CRIE O ARQUIVO

Bibliotecas dispon√≠veis: pandas, openpyxl, python-docx, reportlab, python-pptx, matplotlib, pillow, numpy

EXEMPLO CORRETO (Excel):
\`\`\`python-exec:notas.xlsx
import pandas as pd
df = pd.DataFrame({'Aluno': ['Ana', 'Bruno'], 'Nota': [9.0, 7.5]})
df.to_excel('notas.xlsx', index=False)
print('Criado!')
\`\`\`

Seja preciso e educativo nas corre√ß√µes.`;
            document.getElementById('input-model-system').value = systemPrompt;
        }

        async function salvarModelo() {
            const nome = document.getElementById('input-model-nome').value.trim();
            const tipo = document.getElementById('input-model-tipo').value;
            const modeloSelect = document.getElementById('input-model-select').value;
            const modeloManual = document.getElementById('input-model-manual').value.trim();
            const modelo = modeloManual || modeloSelect;  // Prioriza manual
            const maxTokens = parseInt(document.getElementById('input-model-tokens').value) || 4096;
            const systemPrompt = document.getElementById('input-model-system').value;
            const isReasoning = document.getElementById('input-model-is-reasoning').value === 'true';

            // Capacidades
            const suportaVision = document.getElementById('input-model-vision').checked;
            const suportaTools = document.getElementById('input-model-tools').checked;
            const suportaStreaming = document.getElementById('input-model-streaming').checked;

            // Valida√ß√£o
            if (!nome) { showToast('Apelido √© obrigat√≥rio', 'error'); return; }
            if (!modelo) { showToast('Modelo (ID da API) √© obrigat√≥rio', 'error'); return; }

            // Construir payload
            const payload = {
                nome,
                tipo,
                modelo,
                max_tokens: maxTokens,
                system_prompt: systemPrompt || null,
                suporta_vision: suportaVision,
                suporta_function_calling: suportaTools,
                suporta_streaming: suportaStreaming,
                suporta_temperature: !isReasoning
            };

            // Adicionar temperatura ou reasoning_effort
            if (isReasoning) {
                payload.temperature = null;
                payload.parametros = {
                    reasoning_effort: document.getElementById('input-model-reasoning').value
                };
            } else {
                payload.temperature = parseFloat(document.getElementById('input-model-temp').value) || 0.7;
                payload.parametros = {};
            }

            try {
                await api('/settings/models', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                showToast('Modelo salvo!', 'success');
                closeModal('modal-add-model');
                resetModelModal();
                carregarModelos();
            } catch (e) { /* erro j√° mostrado */ }
        }

        function resetModelModal() {
            document.getElementById('input-model-nome').value = '';
            document.getElementById('input-model-select').selectedIndex = 0;
            document.getElementById('input-model-manual').value = '';
            document.getElementById('input-model-tokens').value = '4096';
            document.getElementById('input-model-temp').value = '0.7';
            document.getElementById('input-model-reasoning').value = 'medium';
            document.getElementById('input-model-system').value = '';
            document.getElementById('input-model-vision').checked = false;
            document.getElementById('input-model-tools').checked = false;
            document.getElementById('input-model-streaming').checked = true;
            document.getElementById('reasoning-warning').style.display = 'none';
            document.getElementById('temp-group').style.display = 'block';
            document.getElementById('reasoning-group').style.display = 'none';
        }

        function openAddModelModal() {
            resetModelModal();
            onProviderChange();  // Popular dropdown inicial
            openModal('modal-add-model');
        }

        async function definirModeloPadrao(id) {
            try {
                await api(`/settings/models/${id}/default`, { method: 'POST' });
                showToast('Modelo definido como padr√£o!', 'success');
                carregarModelos();
            } catch (e) { /* erro j√° mostrado */ }
        }

        async function testarModelo(id) {
            showToast('Testando conex√£o...', 'warning');
            try {
                const result = await api(`/settings/models/${id}/testar`, { method: 'POST' });
                if (result.success) {
                    showToast('‚úÖ Modelo funcionando!', 'success');
                } else {
                    showToast(`‚ùå Erro: ${result.erro}`, 'error');
                }
            } catch (e) { /* erro j√° mostrado */ }
        }

        async function excluirModelo(id) {
            if (!confirm('Excluir este modelo?')) return;
            try {
                await api(`/settings/models/${id}`, { method: 'DELETE' });
                showToast('Modelo exclu√≠do!', 'success');
                carregarModelos();
            } catch (e) { /* erro j√° mostrado */ }
        }

        // ============================================================
        // CHAT COM IA
        // ============================================================
        async function abrirChat(atividadeId, alunoId = null, titulo = 'Chat com IA') {
            document.getElementById('chat-atividade-id').value = atividadeId || '';
            document.getElementById('chat-aluno-id').value = alunoId || '';
            document.getElementById('chat-titulo').textContent = 'üí¨ ' + titulo;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input').value = '';
            
            // Carregar modelos dispon√≠veis
            try {
                const modelsData = await api('/settings/models');
                const select = document.getElementById('chat-model-select');
                if (modelsData.models && modelsData.models.length > 0) {
                    select.innerHTML = modelsData.models.map(m => 
                        `<option value="${m.id}" ${m.is_default ? 'selected' : ''}>${escapeHtml(m.nome)}</option>`
                    ).join('');
                } else {
                    select.innerHTML = '<option value="">Nenhum modelo configurado</option>';
                }
            } catch (e) {
                document.getElementById('chat-model-select').innerHTML = '<option value="">Erro ao carregar modelos</option>';
            }
            
            // Criar sess√£o de chat
            try {
                const sessaoData = await api('/chat/sessoes', {
                    method: 'POST',
                    body: JSON.stringify({
                        titulo: titulo,
                        atividade_id: atividadeId || null,
                        aluno_id: alunoId || null
                    })
                });
                document.getElementById('chat-session-id').value = sessaoData.sessao.id;
            } catch (e) {
                showToast('Erro ao criar sess√£o de chat', 'error');
            }
            
            openModal('modal-chat');
        }

        async function enviarMensagemChat() {
            const input = document.getElementById('chat-input');
            const mensagem = input.value.trim();
            if (!mensagem) return;
            
            const sessionId = document.getElementById('chat-session-id').value;
            const modelId = document.getElementById('chat-model-select').value;
            const container = document.getElementById('chat-messages');
            
            // Adicionar mensagem do usu√°rio
            container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--primary); color: white; align-self: flex-end;">${escapeHtml(mensagem)}</div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;
            
            // Adicionar indicador de carregamento
            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `<div id="${loadingId}" style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--bg-hover); align-self: flex-start;"><span class="spinner"></span> Pensando...</div>`;
            container.scrollTop = container.scrollHeight;
            
            try {
                const result = await api(`/chat/sessoes/${sessionId}/mensagem`, {
                    method: 'POST',
                    body: JSON.stringify({
                        mensagem: mensagem,
                        model_id: modelId || null
                    })
                });
                
                // Remover loading e adicionar resposta
                document.getElementById(loadingId)?.remove();
                const resposta = result.resposta?.content || result.content || 'Sem resposta';
                container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: var(--bg-hover); align-self: flex-start; white-space: pre-wrap;">${escapeHtml(resposta)}</div>`;
                container.scrollTop = container.scrollHeight;
            } catch (e) {
                document.getElementById(loadingId)?.remove();
                container.innerHTML += `<div style="max-width: 80%; padding: 12px 16px; border-radius: 12px; background: rgba(239, 68, 68, 0.2); color: var(--danger); align-self: flex-start;">‚ùå Erro ao enviar mensagem</div>`;
            }
        }

        // Permitir enviar com Enter
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        enviarMensagemChat();
                    }
                });
            }
            // Carregar modelos sugeridos no in√≠cio
            carregarModelosSugeridosInicial();
        });
    </script>
    <script src="/static/chat_system.js"></script>
</body>
</html>
